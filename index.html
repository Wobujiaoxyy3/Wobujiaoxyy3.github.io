<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Wobujiaoxyy3">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="Wobujiaoxyy3">
<meta property="og:locale" content="en_US">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Wobujiaoxyy3</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Wobujiaoxyy3</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/05/07/recblog_1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Wobujiaoxyy3">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/05/07/recblog_1/" class="post-title-link" itemprop="url">How Content Finds Us</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-05-07 23:10:39" itemprop="dateCreated datePublished" datetime="2025-05-07T23:10:39+08:00">2025-05-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-05-09 18:11:54" itemprop="dateModified" datetime="2025-05-09T18:11:54+08:00">2025-05-09</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>As the number of users and items continued to grow, traditional neighborhood-based collaborative filtering methods began to face significant challengesâ€”most notably data sparsity and scalability. To address these issues, researchers turned to matrix factorization (MF), a model-based approach that maps high-dimensional userâ€“item interactions into a low-dimensional latent factor space. At its core, matrix factorization is a form of dimensionality reduction, assuming that both users and items can be described by a small number of latent features that capture their underlying preferences or characteristics.</p>
<p>Formally, given a set of users ( U ) and items ( I ), we define two matrices:<br>( P \in \mathbb{R}^{|U| \times k} ) representing latent vectors for all users, and<br>( Q \in \mathbb{R}^{|I| \times k} ) for all items,<br>where ( k ) is the number of latent dimensions (much smaller than the number of users or items).<br>The goal is to approximate the original rating matrix ( R ) by the product of ( P ) and ( Q ).<br>For any user ( u ) and item ( i ), the predicted rating is computed as:</p>
<p>[<br>\hat{r}_{u,i} &#x3D; p_u \cdot q_i<br>]</p>
<p>â€”that is, the dot product of the user and item vectors.<br>The matrices ( P ) and ( Q ) are learned from observed ratings by minimizing the squared error between predicted and actual values, with a regularization term to prevent overfitting:</p>
<p>[<br>\min_{P,Q} \sum_{(u,i)\in K} \left(r_{u,i} - p_u \cdot q_i\right)^2 + \lambda \left( |p_u|^2 + |q_i|^2 \right)<br>]</p>
<p>Here, ( K ) is the set of observed userâ€“item pairs in the training data, and ( \lambda ) is a regularization coefficient. Optimization techniques such as stochastic gradient descent (SGD) or alternating least squares (ALS) are typically used to train the model.</p>
<p>Intuitively, matrix factorization embeds users and items into a shared latent semantic space, such that users are close to items theyâ€™re likely to prefer. For example, if â€œUser Daveâ€ ends up with a latent vector positioned close to those of <em>Oceanâ€™s 11</em> and <em>The Lion King</em>, the model will likely predict that Dave enjoys these movies.</p>
<p>The major breakthrough for matrix factorization came with the launch of the Netflix Prize in 2006. Netflix released a dataset containing 100 million user ratings and challenged the world to improve its recommendation algorithm by at least 10% in terms of RMSE over its existing neighborhood-based method. The competition drew massive attentionâ€”never before had such a large-scale recommendation dataset been made public. Researchers and engineers worldwide participated, openly sharing techniques and innovations.</p>
<p>One particularly influential contribution came from Simon Funk, who posted on his blog a simple yet powerful matrix factorization algorithm (now known as Funk-SVD). His method demonstrated the effectiveness of MF for collaborative filtering and inspired many teams. Over time, enhanced versions of matrix factorizationâ€”incorporating bias terms, temporal dynamics, and moreâ€”dominated the leaderboard. In 2009, the BellKor team ultimately won the competition with a model ensemble containing hundreds of algorithms, but matrix factorization remained the core component of their solution.</p>
<p>Post-competition, it became clear that MF methods could capture the hidden structure of user preferences much better than traditional neighborhood methods, leading to significantly higher accuracy. The Netflix Prize brought matrix factorization into the spotlight across both academia and industry.</p>
<p>Since then, latent factor models have become a dominant paradigm in recommender systems. Extensions such as <strong>SVD++</strong> (which incorporates implicit feedback) and <strong>Factorization Machines (FM)</strong> (which integrate regression-like modeling) were developed to further improve recommendation quality and incorporate richer information. Despite these variations, the core philosophy remains: use low-dimensional vectors to represent users and items, and frame the recommendation task as a problem of matching these vectors in space.</p>
<p>$$ sds^2$<br>$\text{Var}[X_i] &#x3D; \sigma^2 &lt; \infty$</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/05/06/latex/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Wobujiaoxyy3">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/05/06/latex/" class="post-title-link" itemprop="url">latex</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-05-06 18:16:49" itemprop="dateCreated datePublished" datetime="2025-05-06T18:16:49+08:00">2025-05-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-05-09 18:18:11" itemprop="dateModified" datetime="2025-05-09T18:18:11+08:00">2025-05-09</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p> is great at typesetting mathematics. Let <span
class="math inline"><em>X</em><sub>1</sub>,â€†<em>X</em><sub>2</sub>,â€†â€¦,â€†<em>X</em><sub><em>n</em></sub></span>
be a sequence of independent and identically distributed random
variables with <span
class="math inline">E[<em>X</em><sub><em>i</em></sub>]â€„=â€„<em>Î¼</em></span>
and <span
class="math inline">Var[<em>X</em><sub><em>i</em></sub>]â€„=â€„<em>Ïƒ</em><sup>2</sup>â€„&lt;â€„âˆ</span>,
and let [S_n = = _{i}^{n} X_i] denote their mean. Then as <span
class="math inline"><em>n</em></span> approaches infinity, the random
variables <span class="math inline">$\sqrt{n}(S_n - \mu)$</span>
converge in distribution to a normal <span
class="math inline">ğ’©(0,<em>Ïƒ</em><sup>2</sup>)</span>.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/11/28/solana-simple-socialfi/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Wobujiaoxyy3">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/11/28/solana-simple-socialfi/" class="post-title-link" itemprop="url">Solanaå°é¡¹ç›®ï¼šç®€æ˜“SocialFi</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2024-11-28 06:36:50 / Modified: 06:55:08" itemprop="dateCreated datePublished" datetime="2024-11-28T06:36:50+08:00">2024-11-28</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="ç®€æ˜“SocialFi"><a href="#ç®€æ˜“SocialFi" class="headerlink" title="ç®€æ˜“SocialFi"></a>ç®€æ˜“SocialFi</h1><p>åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬éœ€è¦å®Œæˆä¸€ä¸ªç®€æ˜“çš„SocialFié¡¹ç›®ï¼Œå…¶ä¸­åŒ…å«ä»¥ä¸‹åŠŸèƒ½ï¼š</p>
<ul>
<li>åˆå§‹åŒ–ç”¨æˆ·</li>
<li>å…³æ³¨ç”¨æˆ·</li>
<li>å–æ¶ˆå…³æ³¨</li>
<li>æŸ¥è¯¢å…³æ³¨åˆ—è¡¨</li>
<li>å‘å¸–</li>
<li>æŸ¥è¯¢å¸–å­</li>
</ul>
<p>å°†åŠŸèƒ½è½¬åŒ–ä¸ºéœ€è¦å®ç°çš„æŒ‡ä»¤ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[derive(BorshDeserialize, BorshSerialize, Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">enum</span> <span class="title class_">SocialInstruction</span> &#123;</span><br><span class="line">    InitializeUser&#123;seed_type: <span class="type">String</span>&#125;,</span><br><span class="line">    FollowUser&#123;user_to_follow: Pubkey&#125;,</span><br><span class="line">    UnfollowUser&#123;user_to_unfollow: Pubkey&#125;,</span><br><span class="line">    QueryFollows,</span><br><span class="line">    PostContent&#123;content: <span class="type">String</span>&#125;,</span><br><span class="line">    QueryPosts,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="å…·ä½“å®ç°"><a href="#å…·ä½“å®ç°" class="headerlink" title="å…·ä½“å®ç°"></a>å…·ä½“å®ç°</h2><p>æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬åœ¨<code>processor.rs</code>ä¸­å…·ä½“å®ç°æ¯ä¸€ä¸ªæŒ‡ä»¤å¯¹åº”çš„æ“ä½œï¼Œé¦–å…ˆï¼Œå¯¼å…¥ç›¸åº”çš„åŒ…å¹¶å®šä¹‰ä¸»å‡½æ•°ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> borsh::&#123;BorshDeserialize, BorshSerialize&#125;;</span><br><span class="line"><span class="keyword">use</span> solana_program::&#123;</span><br><span class="line">    account_info::&#123;next_account_info, AccountInfo&#125;, address_lookup_table::&#123;instruction, state::ProgramState&#125;, borsh1::try_from_slice_unchecked, entrypoint::ProgramResult, lamports, msg, program::&#123;invoke, invoke_signed&#125;, program_error::ProgramError, pubkey::Pubkey, system_instruction, system_program, sysvar::&#123;rent::Rent, Sysvar&#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">use</span> spl_associated_token_account::tools::account;</span><br><span class="line"><span class="keyword">use</span> crate::instruction::*;</span><br><span class="line"><span class="keyword">use</span> crate::state::*;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è®¾ç½®ä¸€äº›å¸¸é‡</span></span><br><span class="line"><span class="keyword">const</span> PUBKEY_SIZE: <span class="type">usize</span> = <span class="number">32</span>;</span><br><span class="line"><span class="keyword">const</span> U16_SIZE: <span class="type">usize</span> = <span class="number">2</span>;</span><br><span class="line"><span class="keyword">const</span> USER_PROFILE_SIZE: <span class="type">usize</span> = <span class="number">6</span>;</span><br><span class="line"><span class="keyword">const</span> MAX_FOLLOWER_COUNT: <span class="type">usize</span> = <span class="number">200</span>;  <span class="comment">//æœ€å¤§å…³æ³¨è€…æ•°é‡</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> USER_POST_SIZE: <span class="type">usize</span> = <span class="number">8</span>;    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Processor</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Processor</span> &#123;</span><br><span class="line">    <span class="comment">//å®šä¹‰ä¸»å‡½æ•°</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">process_instruction</span>(</span><br><span class="line">        program_id: &amp;Pubkey,</span><br><span class="line">        accounts: &amp;[AccountInfo],</span><br><span class="line">        instruction_data: &amp;[<span class="type">u8</span>],</span><br><span class="line">    ) <span class="punctuation">-&gt;</span> ProgramResult &#123;</span><br><span class="line">        <span class="comment">//è§£åºåˆ—åŒ–æŒ‡ä»¤</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">instruction</span> = SocialInstruction::<span class="title function_ invoke__">try_from_slice</span>(instruction_data)?;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//åŒ¹é…ä¼ å…¥çš„æŒ‡ä»¤</span></span><br><span class="line">        <span class="keyword">match</span> instruction &#123;</span><br><span class="line">            SocialInstruction::InitializeUser &#123; seed_type &#125; =&gt; &#123;</span><br><span class="line">                <span class="keyword">Self</span>::<span class="title function_ invoke__">initialize_user</span>(program_id, accounts, seed_type)</span><br><span class="line">            &#125;</span><br><span class="line">            SocialInstruction::FollowUser &#123; user_to_follow &#125; =&gt; &#123;</span><br><span class="line">                <span class="keyword">Self</span>::<span class="title function_ invoke__">follow_user</span>(accounts, user_to_follow)</span><br><span class="line">            &#125;</span><br><span class="line">            SocialInstruction::QueryFollows =&gt; &#123;</span><br><span class="line">                <span class="keyword">Self</span>::<span class="title function_ invoke__">query_follows</span>(accounts)</span><br><span class="line">            &#125;</span><br><span class="line">            SocialInstruction::UnfollowUser &#123; user_to_unfollow &#125; =&gt; &#123;</span><br><span class="line">                <span class="keyword">Self</span>::<span class="title function_ invoke__">unfollow_user</span>(accounts, user_to_unfollow)</span><br><span class="line">            &#125;</span><br><span class="line">            SocialInstruction::PostContent &#123; content &#125; =&gt; &#123;</span><br><span class="line">                <span class="keyword">Self</span>::<span class="title function_ invoke__">post_content</span>(program_id, accounts, content)</span><br><span class="line">            &#125;</span><br><span class="line">            SocialInstruction::QueryPosts =&gt; &#123;</span><br><span class="line">                <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>(ä¸‹é¢å†™çš„æ¯”è¾ƒéšæ„ï¼Œè§è°…)</p>
<h3 id="state-rså’Œä¸€äº›ç®€å•å‡½æ•°"><a href="#state-rså’Œä¸€äº›ç®€å•å‡½æ•°" class="headerlink" title="state.rså’Œä¸€äº›ç®€å•å‡½æ•°"></a>state.rså’Œä¸€äº›ç®€å•å‡½æ•°</h3><p>åœ¨å®ç°ç®€æ˜“SocialFiçš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ä¸€äº›ç‰¹å®šçš„è´¦æˆ·æ¥ä¸ºæˆ‘ä»¬å­˜å‚¨ä¸€äº›æ•°æ®ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> solana_program::pubkey::Pubkey;</span><br><span class="line"><span class="keyword">use</span> borsh::&#123;BorshDeserialize, BorshSerialize&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(BorshDeserialize, BorshSerialize, Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">UserProfile</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> data_len: <span class="type">u16</span>,</span><br><span class="line">    <span class="keyword">pub</span> follows: <span class="type">Vec</span>&lt;Pubkey&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(BorshDeserialize, BorshSerialize, Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">UserPost</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> post_count: <span class="type">u64</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(BorshDeserialize, BorshSerialize, Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Post</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> content: <span class="type">String</span>,</span><br><span class="line">    <span class="keyword">pub</span> timestamp: <span class="type">u64</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">UserProfile</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">new</span>() <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">Self</span> &#123;</span><br><span class="line">            data_len: <span class="number">0</span>,</span><br><span class="line">            follows: <span class="type">Vec</span>::<span class="title function_ invoke__">new</span>(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">follow</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, user_to_follow: Pubkey) &#123;</span><br><span class="line">        <span class="keyword">self</span>.follows.<span class="title function_ invoke__">push</span>(user_to_follow);</span><br><span class="line">        <span class="keyword">self</span>.data_len = <span class="keyword">self</span>.follows.<span class="title function_ invoke__">len</span>() <span class="keyword">as</span> <span class="type">u16</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">unfollow</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, user_to_unfollow: Pubkey) &#123;</span><br><span class="line">        <span class="keyword">self</span>.follows.<span class="title function_ invoke__">retain</span>(|&amp;x| x != user_to_unfollow);</span><br><span class="line">        <span class="keyword">self</span>.data_len = <span class="keyword">self</span>.follows.<span class="title function_ invoke__">len</span>() <span class="keyword">as</span> <span class="type">u16</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">UserPost</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">new</span>() <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">Self</span> &#123;</span><br><span class="line">            post_count: <span class="number">0</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">add_post</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.post_count += <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">get_count</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">u64</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.post_count</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Post</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">new</span>(content: <span class="type">String</span>, timestamp: <span class="type">u64</span>) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">Self</span> &#123;</span><br><span class="line">            content,</span><br><span class="line">            timestamp,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åŒæ—¶ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä¸€äº›å®šä¹‰ä¸€äº›ç®€å•çš„å‡½æ•°ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å®šä¹‰è®¡ç®—è´¦æˆ·å ç”¨ç©ºé—´çš„å‡½æ•°</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">compute_profile_space</span>(pubkey_count: <span class="type">usize</span>) <span class="punctuation">-&gt;</span> <span class="type">usize</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> USER_PROFILE_SIZE + pubkey_count * PUBKEY_SIZE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å®šä¹‰å°†å­—èŠ‚è½¬åŒ–ä¸ºu16çš„å‡½æ•°</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">bytes_to_u16</span>(bytes: &amp;[<span class="type">u8</span>]) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;<span class="type">u16</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> bytes.<span class="title function_ invoke__">len</span>() != <span class="number">2</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span>; <span class="comment">//ç¡®ä¿è¾“å…¥æ˜¯2ä¸ªå­—èŠ‚</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">array</span> = [<span class="number">0u8</span>; <span class="number">2</span>];</span><br><span class="line">    array.<span class="title function_ invoke__">copy_from_slice</span>(bytes);</span><br><span class="line">    <span class="title function_ invoke__">Some</span>(<span class="type">u16</span>::<span class="title function_ invoke__">from_le_bytes</span>(array))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="InitializeUser"><a href="#InitializeUser" class="headerlink" title="InitializeUser"></a>InitializeUser</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å®šä¹‰initialize_useræ–¹æ³•</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">initialize_user</span>(program_id: &amp;Pubkey, accounts: &amp;[AccountInfo], seed_type: <span class="type">String</span>) <span class="punctuation">-&gt;</span> ProgramResult &#123;</span><br><span class="line">    <span class="comment">//è·å–è´¦æˆ·ä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">account_into_iter</span> = &amp;<span class="keyword">mut</span> accounts.<span class="title function_ invoke__">iter</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">user_account</span> = <span class="title function_ invoke__">next_account_info</span>(account_into_iter)?;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">pda_account</span> = <span class="title function_ invoke__">next_account_info</span>(account_into_iter)?;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">system_program</span> = <span class="title function_ invoke__">next_account_info</span>(account_into_iter)?;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//åŒ¹é…ä¼ å…¥çš„seedä»¥åˆ›å»ºä¸åŒçš„è´¦æˆ·</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">seed</span> = <span class="keyword">match</span> seed_type.<span class="title function_ invoke__">as_str</span>() &#123;</span><br><span class="line">        <span class="string">&quot;profile&quot;</span> =&gt; <span class="string">&quot;profile&quot;</span>, </span><br><span class="line">        <span class="string">&quot;post&quot;</span> =&gt; <span class="string">&quot;post&quot;</span>,</span><br><span class="line">        _ =&gt; <span class="keyword">return</span> <span class="title function_ invoke__">Err</span>(ProgramError::InvalidArgument),</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    msg!(<span class="string">&quot;seed: &#123;:?&#125;&quot;</span>, seed);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è°ƒç”¨find_program_addressæ–¹æ³•ï¼Œç”ŸæˆPDAè´¦æˆ·ï¼ˆbump_seedç”¨äºé˜²æ­¢ç”Ÿæˆè´¦æˆ·é‡å¤ï¼‰</span></span><br><span class="line">    <span class="keyword">let</span> (pda, bump_seed) = Pubkey::<span class="title function_ invoke__">find_program_address</span>(&amp;[user_account.key.<span class="title function_ invoke__">as_ref</span>(), seed.<span class="title function_ invoke__">as_bytes</span>()], program_id);</span><br><span class="line"></span><br><span class="line">    msg!(<span class="string">&quot;pda: &#123;:?&#125;&quot;</span>, pda);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//éªŒè¯ä¼ å…¥çš„PDAè´¦æˆ·æ˜¯å¦ä¸ç¨‹åºä¸­ç”Ÿæˆçš„åŒ¹é…ï¼Œå¦‚æœä¸€è‡´ï¼Œåˆ™è¯´æ˜ä¼ å…¥çš„PDAè´¦æˆ·æ­£ç¡®,å¦åˆ™æŠ¥é”™</span></span><br><span class="line">    <span class="keyword">if</span> pda != pda_account.key.<span class="title function_ invoke__">clone</span>() &#123;</span><br><span class="line">        <span class="keyword">return</span>  <span class="title function_ invoke__">Err</span>(ProgramError::InvalidArgument);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è·å–å½“å‰åŒºå—é“¾çš„ç§Ÿé‡‘å‚æ•°ï¼ˆrentæ˜¯sysvarä¸­çš„å‚æ•°ï¼‰</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">rent</span>= Rent::<span class="title function_ invoke__">get</span>()?;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è®¡ç®—è¯¥è´¦æˆ·æ‰€éœ€çš„å­˜å‚¨ç©ºé—´å¤§å°</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">space</span> = <span class="keyword">match</span> seed_type.<span class="title function_ invoke__">as_str</span>() &#123;</span><br><span class="line">        <span class="string">&quot;profile&quot;</span> =&gt; <span class="title function_ invoke__">compute_profile_space</span>(MAX_FOLLOWER_COUNT),</span><br><span class="line">        <span class="string">&quot;post&quot;</span> =&gt; USER_POST_SIZE, </span><br><span class="line">        _ =&gt; <span class="keyword">return</span> <span class="title function_ invoke__">Err</span>(ProgramError::InvalidArgument),</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ ¹æ®è´¦æˆ·æ‰€éœ€çš„å­˜å‚¨ç©ºé—´ï¼Œè®¡ç®—åˆ›å»ºè´¦æˆ·çš„æœ€ä½ç§Ÿé‡‘é‡‘é¢</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">lamports</span> = rent.<span class="title function_ invoke__">minimum_balance</span>(space);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//åˆ›å»ºcreate_account_ixæŒ‡ä»¤</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">create_account_ix</span> = system_instruction::<span class="title function_ invoke__">create_account</span>(</span><br><span class="line">        user_account.key,</span><br><span class="line">        &amp;pda,</span><br><span class="line">        lamports,</span><br><span class="line">        space <span class="keyword">as</span> <span class="type">u64</span>,</span><br><span class="line">        program_id</span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//ä½¿ç”¨invokeè°ƒç”¨å‡½æ•°</span></span><br><span class="line">    <span class="title function_ invoke__">invoke_signed</span>(</span><br><span class="line">        &amp;create_account_ix,</span><br><span class="line">        &amp;[</span><br><span class="line">            user_account.<span class="title function_ invoke__">clone</span>(),</span><br><span class="line">            pda_account.<span class="title function_ invoke__">clone</span>(),</span><br><span class="line">            system_program.<span class="title function_ invoke__">clone</span>(),</span><br><span class="line">        ],</span><br><span class="line">        &amp;[&amp;[user_account.key.<span class="title function_ invoke__">as_ref</span>(), seed.<span class="title function_ invoke__">as_bytes</span>(), &amp;[bump_seed]]],     <span class="comment">//éœ€è¦ç­¾å</span></span><br><span class="line">    )?;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ç»§ç»­åŒ¹é…ä¼ å…¥çš„seedä»¥å†³å®šå¯¹user_profileè´¦æˆ·æˆ–user_postè´¦æˆ·è¿›è¡Œåˆå§‹åŒ–</span></span><br><span class="line">     <span class="keyword">match</span> seed_type.<span class="title function_ invoke__">as_str</span>() &#123;</span><br><span class="line">        <span class="string">&quot;profile&quot;</span> =&gt; &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">user_profile</span> = UserProfile::<span class="title function_ invoke__">new</span>();  <span class="comment">//åˆå§‹åŒ–UserProfile</span></span><br><span class="line">            user_profile.<span class="title function_ invoke__">serialize</span>(&amp;<span class="keyword">mut</span> *pda_account.<span class="title function_ invoke__">try_borrow_mut_data</span>()?)?;  <span class="comment">//é€šè¿‡serializeæ–¹æ³•å°†UserProfileä¼ å…¥PDAè´¦æˆ·ä¸­</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="string">&quot;post&quot;</span> =&gt; &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">user_post</span> = UserPost::<span class="title function_ invoke__">new</span>();    <span class="comment">//åˆå§‹åŒ–UserPost</span></span><br><span class="line">            user_post.<span class="title function_ invoke__">serialize</span>(&amp;<span class="keyword">mut</span> *pda_account.<span class="title function_ invoke__">try_borrow_mut_data</span>()?)?; <span class="comment">//é€šè¿‡serializeæ–¹æ³•å°†UserPostä¼ å…¥PDAè´¦æˆ·ä¸­</span></span><br><span class="line">        &#125;</span><br><span class="line">        _ =&gt; <span class="keyword">return</span> <span class="title function_ invoke__">Err</span>(ProgramError::InvalidArgument),</span><br><span class="line">    &#125;;</span><br><span class="line">    msg!(<span class="string">&quot;User init success&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="FollowUser"><a href="#FollowUser" class="headerlink" title="FollowUser"></a>FollowUser</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å®šä¹‰follow_useræ–¹æ³•</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">follow_user</span>(accounts: &amp;[AccountInfo], user_to_follow: Pubkey) <span class="punctuation">-&gt;</span> ProgramResult &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">account_into_iter</span> = &amp;<span class="keyword">mut</span> accounts.<span class="title function_ invoke__">iter</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">pda_account</span> = <span class="title function_ invoke__">next_account_info</span>(account_into_iter)?;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è®¡ç®—size</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">size</span>: <span class="type">usize</span> = <span class="number">0</span>;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">data</span> = &amp;pda_account.data.<span class="title function_ invoke__">borrow</span>();  <span class="comment">//æå–å­˜å‚¨åœ¨PDAè´¦æˆ·ä¸­dataçš„å†…å®¹</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">len</span> = &amp;data[..U16_SIZE];    <span class="comment">//æå–UserProfileç»“æ„ä½“ä¸­çš„data_lenå­—æ®µï¼ˆå‰ä¸¤ä¸ªå­—èŠ‚ï¼‰</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">pubkey_count</span> = <span class="title function_ invoke__">bytes_to_u16</span>(len).<span class="title function_ invoke__">unwrap</span>();  <span class="comment">//å°†data_lenå­—æ®µä»å­—èŠ‚è½¬æ¢ä¸ºu16ç±»å‹ï¼Œè·å–è¯¥PDAè´¦æˆ·å…³æ³¨çš„æ•°é‡</span></span><br><span class="line">        size = <span class="title function_ invoke__">compute_profile_space</span>(pubkey_count <span class="keyword">as</span> <span class="type">usize</span>);    <span class="comment">//é€šè¿‡å…³æ³¨çš„æ•°é‡è®¡ç®—è¯¥PDAè´¦æˆ·æ‰€éœ€çš„å­˜å‚¨å­—èŠ‚æ•°</span></span><br><span class="line">        msg!(<span class="string">&quot;size is &#123;:?&#125;&quot;</span>, size);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">user_profile</span> = UserProfile::<span class="title function_ invoke__">try_from_slice</span>(&amp;pda_account.data.<span class="title function_ invoke__">borrow</span>()[..size])?;    <span class="comment">//é€šè¿‡ä¹‹å‰è®¡ç®—çš„å­˜å‚¨å­—èŠ‚æ•°æå–é“¾ä¸ŠPDAè´¦æˆ·çš„UserProfileï¼ˆéœ€è¦ç²¾ç¡®è®¡ç®—å­˜å‚¨å­—èŠ‚æ•°ï¼Œå¦åˆ™ä¼šæŠ¥é”™ï¼‰</span></span><br><span class="line"></span><br><span class="line">    msg!(<span class="string">&quot;user_profile is &#123;:?&#125;&quot;</span>, user_profile);</span><br><span class="line"></span><br><span class="line">    user_profile.<span class="title function_ invoke__">follow</span>(user_to_follow);    <span class="comment">//é€šè¿‡ä¸€ä¸ªfollowæ–¹æ³•å¯¹UserProfileè¿›è¡Œæ›´æ–°ï¼Œæ·»åŠ å…³æ³¨è€…</span></span><br><span class="line"></span><br><span class="line">    user_profile.<span class="title function_ invoke__">serialize</span>(&amp;<span class="keyword">mut</span> *pda_account.<span class="title function_ invoke__">try_borrow_mut_data</span>()?)?;  <span class="comment">//å°†æ›´æ–°å¥½çš„UserProfileé‡æ–°å¯¼å…¥åˆ°é“¾ä¸ŠPDAè´¦æˆ·çš„dataä¸­</span></span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="QueryFollow"><a href="#QueryFollow" class="headerlink" title="QueryFollow"></a>QueryFollow</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å®šä¹‰query_followsæ–¹æ³•</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">query_follows</span>(accounts: &amp;[AccountInfo]) <span class="punctuation">-&gt;</span> ProgramResult&#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">account_into_iter</span> = &amp;<span class="keyword">mut</span> accounts.<span class="title function_ invoke__">iter</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">pda_account</span> = <span class="title function_ invoke__">next_account_info</span>(account_into_iter)?;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å¦ä¸€ç§æ¯”è¾ƒç®€ä¾¿çš„æ–¹æ³•ï¼Œä»PDAè´¦æˆ·çš„dataä¸­è¯»å–UserProfile</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">user_profile</span> = try_from_slice_unchecked::&lt;UserProfile&gt;(&amp;pda_account.data.<span class="title function_ invoke__">borrow</span>()).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è¯»å–å¥½UserProfileå¹¶æ‰“å°å‡ºæ¥</span></span><br><span class="line">    msg!(<span class="string">&quot;user_profile is &#123;:?&#125;&quot;</span>, user_profile);</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="UnfollowUser"><a href="#UnfollowUser" class="headerlink" title="UnfollowUser"></a>UnfollowUser</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å®šä¹‰unfollow_useræ–¹æ³•</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">unfollow_user</span>(accounts: &amp;[AccountInfo], user_to_unfollow: Pubkey) <span class="punctuation">-&gt;</span> ProgramResult &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">account_into_iter</span> = &amp;<span class="keyword">mut</span> accounts.<span class="title function_ invoke__">iter</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">pda_account</span> = <span class="title function_ invoke__">next_account_info</span>(account_into_iter)?;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸è®¡ç®—sizeä¼šæŠ¥é”™</span></span><br><span class="line">    <span class="comment">//let mut user_profile = UserProfile::try_from_slice(&amp;pda_account.data.borrow())?;</span></span><br><span class="line"></span><br><span class="line">    user_profile.<span class="title function_ invoke__">unfollow</span>(user_to_unfollow);</span><br><span class="line"></span><br><span class="line">    user_profile.<span class="title function_ invoke__">serialize</span>(&amp;<span class="keyword">mut</span> *pda_account.<span class="title function_ invoke__">try_borrow_mut_data</span>()?)?;</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="PostContent"><a href="#PostContent" class="headerlink" title="PostContent"></a>PostContent</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å®šä¹‰post_contentæ–¹æ³•</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">post_content</span>(program_id: &amp;Pubkey, accounts: &amp;[AccountInfo], content: <span class="type">String</span>) <span class="punctuation">-&gt;</span> ProgramResult &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">account_into_iter</span> = &amp;<span class="keyword">mut</span> accounts.<span class="title function_ invoke__">iter</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">user_account</span> = <span class="title function_ invoke__">next_account_info</span>(account_into_iter)?;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">pda_account</span> = <span class="title function_ invoke__">next_account_info</span>(account_into_iter)?;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">post_pda_account</span> = <span class="title function_ invoke__">next_account_info</span>(account_into_iter)?;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">system_program</span> = <span class="title function_ invoke__">next_account_info</span>(account_into_iter)?;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è·å–å½“å‰æ—¶é—´æˆ³</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">clock</span> = Clock::<span class="title function_ invoke__">get</span>()?;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">timestamp</span> = clock.unix_timestamp <span class="keyword">as</span> <span class="type">u64</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è¯»å–é“¾ä¸Šè´¦æˆ·ä¸­çš„UserPostæ•°æ®</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">user_post</span> = try_from_slice_unchecked::&lt;UserPost&gt;(&amp;pda_account.data.<span class="title function_ invoke__">borrow</span>())?;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ç­‰åŒäºidå¢é•¿</span></span><br><span class="line">    user_post.<span class="title function_ invoke__">add_post</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å¦ä¸€ç§å°†æ•°æ®å†™åˆ°é“¾ä¸Šè´¦æˆ·çš„æ–¹æ³•</span></span><br><span class="line">    user_post.<span class="title function_ invoke__">serialize</span>(&amp;<span class="keyword">mut</span> &amp;<span class="keyword">mut</span> pda_account.data.<span class="title function_ invoke__">borrow_mut</span>())?;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è·å–æœ€æ–°çš„post_count</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">count</span> = user_post.<span class="title function_ invoke__">get_count</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ç”Ÿæˆä¸€ä¸ªæ–°çš„pdaè´¦æˆ·ï¼Œç”¨äºå­˜æ”¾Post</span></span><br><span class="line">    <span class="keyword">let</span> (pda, bump_seed) = Pubkey::<span class="title function_ invoke__">find_program_address</span>(</span><br><span class="line">        &amp;[</span><br><span class="line">            user_account.key.<span class="title function_ invoke__">as_ref</span>(),</span><br><span class="line">            <span class="string">&quot;post&quot;</span>.<span class="title function_ invoke__">as_bytes</span>(),</span><br><span class="line">            &amp;[count <span class="keyword">as</span> <span class="type">u8</span>],</span><br><span class="line">        ],</span><br><span class="line">        program_id,</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ ¹æ®å†…å®¹å’Œæ—¶é—´æˆ³åˆ›å»ºæ–°çš„post</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">post</span> = Post::<span class="title function_ invoke__">new</span>(content, timestamp);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">rent</span> = Rent::<span class="title function_ invoke__">get</span>()?;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">space</span> = borsh::<span class="title function_ invoke__">to_vec</span>(&amp;post).<span class="title function_ invoke__">unwrap</span>().<span class="title function_ invoke__">len</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">lamports</span> = rent.<span class="title function_ invoke__">minimum_balance</span>(space);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ç”Ÿæˆæ–°è´¦æˆ·çš„æŒ‡ä»¤</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">create_account_ix</span> = &amp;system_instruction::<span class="title function_ invoke__">create_account</span>(</span><br><span class="line">        user_account.key,</span><br><span class="line">        &amp;post_pda_account,</span><br><span class="line">        lamports, </span><br><span class="line">        space <span class="keyword">as</span> <span class="type">u64</span>,</span><br><span class="line">        program_id,</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è°ƒç”¨invokeæ‰§è¡Œå‘½ä»¤</span></span><br><span class="line">    <span class="title function_ invoke__">invoke_signed</span>(</span><br><span class="line">        create_account_ix,</span><br><span class="line">        &amp;[</span><br><span class="line">            user_account.<span class="title function_ invoke__">clone</span>(),</span><br><span class="line">            post_pda_account.<span class="title function_ invoke__">clone</span>(),</span><br><span class="line">            system_program.<span class="title function_ invoke__">clone</span>()</span><br><span class="line">        ],</span><br><span class="line">        &amp;[&amp;[</span><br><span class="line">            user_account.key.<span class="title function_ invoke__">as_ref</span>(),</span><br><span class="line">            <span class="string">&quot;post&quot;</span>.<span class="title function_ invoke__">as_bytes</span>(),</span><br><span class="line">            &amp;[count <span class="keyword">as</span> <span class="type">u8</span>],</span><br><span class="line">            &amp;[bump_seed],</span><br><span class="line">        ]]</span><br><span class="line">    )?;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å°†æ–°çš„postå†…å®¹å†™å…¥æ–°å»ºçš„post_pdaè´¦æˆ·ä¸­</span></span><br><span class="line">    post.<span class="title function_ invoke__">serialize</span>(&amp;<span class="keyword">mut</span> *post_pda_account.<span class="title function_ invoke__">try_borrow_mut_data</span>()?)?;</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="QueryPost"><a href="#QueryPost" class="headerlink" title="QueryPost"></a>QueryPost</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æŸ¥è¯¢å¸–å­</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">query_posts</span>(accounts: &amp;[AccountInfo]) <span class="punctuation">-&gt;</span> ProgramResult &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">accounts_into_iter</span> = &amp;<span class="keyword">mut</span> accounts.<span class="title function_ invoke__">iter</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">pda_account</span> = <span class="title function_ invoke__">next_account_info</span>(accounts_into_iter)?;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">post_pda_account</span> = <span class="title function_ invoke__">next_account_info</span>(accounts_into_iter)?;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">user_post</span> = try_from_slice_unchecked::&lt;UserPost&gt;(&amp;pda_account.data.<span class="title function_ invoke__">borrow</span>())?;</span><br><span class="line"></span><br><span class="line">    msg!(<span class="string">&quot;user_post: &#123;:?&#125;&quot;</span>, user_post);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">post</span> = try_from_slice_unchecked::&lt;Post&gt;(&amp;post_pda_account.data.<span class="title function_ invoke__">borrow</span>())?;</span><br><span class="line"></span><br><span class="line">    msg!(<span class="string">&quot;post: &#123;:?&#125;, at &#123;:?&#125;&quot;</span>, post.content, post.timestamp); </span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/11/23/solana-SPL-token/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Wobujiaoxyy3">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/11/23/solana-SPL-token/" class="post-title-link" itemprop="url">Solanaå°é¡¹ç›®ï¼šSPL-tokenåˆçº¦åˆ›å»º</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-11-23 10:09:34" itemprop="dateCreated datePublished" datetime="2024-11-23T10:09:34+08:00">2024-11-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-12-01 01:06:37" itemprop="dateModified" datetime="2024-12-01T01:06:37+08:00">2024-12-01</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="SPL-Tokenåˆçº¦"><a href="#SPL-Tokenåˆçº¦" class="headerlink" title="SPL-Tokenåˆçº¦"></a>SPL-Tokenåˆçº¦</h1><p>ä¸ºäº†æ›´åŠ äº†è§£å¦‚ä½•ä½¿ç”¨Ruståœ¨Solanaä¸Šéƒ¨ç½²åˆçº¦å¹¶ä½¿ç”¨åˆçº¦ï¼Œæˆ‘ä»¬å®Œæˆäº†ä¸€ä¸ªSPL-tokençš„åˆçº¦ç»ƒä¹ ï¼Œè¯¥åˆçº¦åŒ…å«äº†ä¸¤ä¸ªå†…å®¹ï¼š<br>    - CreateTokenåˆ›å»ºä»£å¸<br>    - Minté“¸é€ ä»£å¸</p>
<h2 id="é¡¹ç›®æ–‡ä»¶çš„åŸºæœ¬ç»“æ„"><a href="#é¡¹ç›®æ–‡ä»¶çš„åŸºæœ¬ç»“æ„" class="headerlink" title="é¡¹ç›®æ–‡ä»¶çš„åŸºæœ¬ç»“æ„"></a>é¡¹ç›®æ–‡ä»¶çš„åŸºæœ¬ç»“æ„</h2><p>æˆ‘ä»¬é¦–å…ˆä½¿ç”¨<code>cargo new --lib token</code>æ¥åˆ›å»ºè¯¥é¡¹ç›®ï¼Œæ­¤æ—¶è¯¥é¡¹ç›®çš„<code>src</code>æ–‡ä»¶å¤¹ä¸‹åªæœ‰<code>lib.rs</code>æ–‡ä»¶ã€‚æ­¤æ—¶ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ç»§ç»­åˆ›å»ºå¦‚ä¸‹æ–‡ä»¶ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">--lib.rs (åˆ›å»ºæ—¶å°±æœ‰)</span><br><span class="line">--processor.rs</span><br><span class="line">--instruction.rs</span><br><span class="line">--state.rs</span><br><span class="line">--error.rs</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­ï¼š<br>    - <code>lib.rs</code>æ˜¯é¡¹ç›®çš„å…¥å£æ–‡ä»¶ï¼Œå®šä¹‰ç¨‹åºçš„ä¸»è¦é€»è¾‘æ¨¡å—ã€‚<br>    - <code>processor.rs</code>é€šè¿‡å®šä¹‰<code>process()</code>å‡½æ•°ï¼Œå®ç°ç¨‹åºçš„æ ¸å¿ƒé€»è¾‘å¤„ç†ã€‚<br>    - <code>instruction.rs</code>ç”¨äºå®šä¹‰ç¨‹åºå¯ä»¥å¤„ç†çš„æŒ‡ä»¤ç±»å‹ã€‚<br>    - <code>state.rs</code>ç”¨äºå®šä¹‰ç¨‹åºä¸­æŒä¹…åŒ–çš„è´¦æˆ·æ•°æ®ç»“æ„å’Œé€»è¾‘ã€‚<br>    -  <code>error.rs</code>ç”¨äºè‡ªå®šä¹‰ç¨‹åºä¸­çš„é”™è¯¯ç±»å‹ã€‚</p>
<h2 id="å¯¼å…¥åŸºæœ¬ä¾èµ–"><a href="#å¯¼å…¥åŸºæœ¬ä¾èµ–" class="headerlink" title="å¯¼å…¥åŸºæœ¬ä¾èµ–"></a>å¯¼å…¥åŸºæœ¬ä¾èµ–</h2><p>åœ¨å¼€å§‹å†™ä»£ç å‰ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä½¿ç”¨<code>cargo add</code>å‘½ä»¤æ¥å¯¼å…¥è¯¥é¡¹ç›®æ‰€éœ€çš„ä¾èµ–ï¼š<code>solana-program</code>ã€<code>spl-associated-token-account</code>ã€<code>spl-token</code>ã€‚æœ€åï¼Œ<code>Cargo.toml</code>æ–‡ä»¶çš„å†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight zsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[package]</span><br><span class="line">name = <span class="string">&quot;token&quot;</span></span><br><span class="line">version = <span class="string">&quot;0.1.0&quot;</span></span><br><span class="line">edition = <span class="string">&quot;2021&quot;</span></span><br><span class="line"></span><br><span class="line">[dependencies]</span><br><span class="line">borsh = <span class="string">&quot;1.5.1&quot;</span></span><br><span class="line">solana-program = <span class="string">&quot;=2.0.10&quot;</span></span><br><span class="line">spl-associated-token-account = &#123;version = <span class="string">&quot;5.0.1&quot;</span>, features = [<span class="string">&quot;no-entrypoint&quot;</span>]&#125;</span><br><span class="line">spl-token = &#123;version = <span class="string">&quot;6.0.0&quot;</span>, features = [<span class="string">&quot;no-entrypoint&quot;</span>]&#125;</span><br><span class="line"></span><br><span class="line">[lib]</span><br><span class="line">crate-type = [<span class="string">&quot;cdylib&quot;</span>, <span class="string">&quot;lib&quot;</span>]</span><br><span class="line"></span><br><span class="line">[features]</span><br><span class="line">no-entrypoint = []</span><br></pre></td></tr></table></figure>
<p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬ä¸º<code>spl-associated-token-account</code>å’Œ<code>spl-token</code>èµ‹äºˆäº†<code>no-entrypoint</code>çš„ç‰¹å¾ã€‚è¿™æ˜¯å› ä¸ºï¼Œä½¿ç”¨<code>Rust</code>å¼€å‘<code>Solana</code>ç¨‹åºæ—¶ï¼Œ<code>entrypoint</code>æ˜¯ç¨‹åºçš„ä¸»è¦å…¥å£ç‚¹ï¼Œç”¨äºæ¥æ”¶å¤–éƒ¨ä¼ å…¥çš„æŒ‡ä»¤å’Œå‚æ•°ã€‚åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œ<code>Solana</code>çš„æ¡†æ¶ä¼šæœŸæœ›ç¨‹åºæœ‰ä¸€ä¸ªå…¥å£ç‚¹ï¼Œä»¥ä¾¿å¤„ç†äº‹åŠ¡è¯·æ±‚ã€‚ç„¶è€Œï¼Œæœ‰äº›æ¨¡å—ï¼ˆä¾‹å¦‚<code>spl-associated-token-account</code>æˆ–<code>spl-token</code>ï¼‰å¹¶ä¸æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ç¨‹åºï¼Œè€Œæ˜¯ä¸ºå…¶ä»–ç¨‹åºæä¾›åŠŸèƒ½çš„åº“ï¼Œå› æ­¤å®ƒä»¬ä¸éœ€è¦ä¸€ä¸ªé»˜è®¤çš„å…¥å£ç‚¹ã€‚</p>
<p>æ­£å› ä¸ºæ­¤ï¼Œæˆ‘ä»¬éœ€è¦ä¸º<code>spl-associated-token-account</code>å’Œ<code>spl-token</code>èµ‹äºˆäº†<code>no-entrypoint</code>çš„ç‰¹å¾ï¼Œç”¨äºç¦ç”¨è¿™äº›ä¾èµ–çš„é»˜è®¤å…¥å£ç‚¹ï¼Œé¿å…ä¸å¿…è¦çš„ä»£ç è¿è¡Œã€‚</p>
<p>åŒæ—¶ï¼Œæˆ‘ä»¬æ·»åŠ äº†<code>cdylib</code>ï¼Œè¿™æ˜¯ä¸€ç§ç”¨äºç”ŸæˆåŠ¨æ€åº“çš„ç›®æ ‡ç±»å‹ï¼Œå®ƒæ˜¯ä¸ºäº†ä¸å¤–éƒ¨çš„éRustä»£ç äº¤äº’è®¾è®¡çš„ã€‚Solanaå¯ä»¥ä½¿ç”¨åŠ¨æ€åº“æ¥éƒ¨ç½²ç¨‹åºï¼Œä½¿å…¶è¿è¡Œåœ¨é“¾ä¸Šã€‚</p>
<h2 id="ç€æ‰‹å†™ä»£ç "><a href="#ç€æ‰‹å†™ä»£ç " class="headerlink" title="ç€æ‰‹å†™ä»£ç "></a>ç€æ‰‹å†™ä»£ç </h2><p>åœ¨ç†æ¸…äº†ä¸€ä¸ªSolanaé¡¹ç›®çš„åŸºæœ¬ç»“æ„åï¼Œæˆ‘ä»¬å°±å¯ä»¥å¼€å§‹ç€æ‰‹å†™ä»£ç äº†ã€‚é¦–å…ˆï¼Œè®©æˆ‘ä»¬çœ‹ä¸€ä¸‹<code>lib.rs</code>çš„åŸºæœ¬æ¶æ„ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å¼•å…¥éœ€è¦çš„åº“</span></span><br><span class="line"><span class="keyword">use</span> solana_program::&#123;</span><br><span class="line">    entrypoint,</span><br><span class="line">    entrypoint::ProgramResult,</span><br><span class="line">    pubkey::Pubkey,</span><br><span class="line">    account_info::AccountInfo</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">use</span> spl_token::state::Account;  </span><br><span class="line"></span><br><span class="line"><span class="comment">//å¯¼å…¥processor.rs ã€ instruction.rs</span></span><br><span class="line"><span class="keyword">mod</span> processor; </span><br><span class="line"><span class="keyword">mod</span> instruction;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å¼•å…¥Processorç±»å‹</span></span><br><span class="line"><span class="keyword">use</span> crate::processor::Processor;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å®šä¹‰ç¨‹åºçš„å…¥å£ç‚¹ä¸ºprocess_instruction</span></span><br><span class="line">entrypoint!(process_instruction);</span><br><span class="line"></span><br><span class="line"><span class="comment">//å®šä¹‰ç¨‹åºçš„å…¥å£å‡½æ•°ï¼Œç¬¦åˆsolanaçš„æ ‡å‡†æ¥å£</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">process_instruction</span>(</span><br><span class="line">    program_id: &amp;Pubkey,    <span class="comment">//å½“å‰ç¨‹åºçš„å…¬é’¥</span></span><br><span class="line">    accounts: &amp;[AccountInfo],   <span class="comment">//è°ƒç”¨æŒ‡ä»¤æ—¶ä¼ é€’çš„è´¦æˆ·ä¿¡æ¯æ•°ç»„</span></span><br><span class="line">    instruction_data: &amp;[<span class="type">u8</span>],    <span class="comment">//è°ƒç”¨æ—¶çš„è¾“å…¥æ•°æ®ï¼ˆæŒ‡ä»¤å’Œå‚æ•°ï¼‰</span></span><br><span class="line">) <span class="punctuation">-&gt;</span> ProgramResult &#123;    <span class="comment">//è¿”å›ProgramResultï¼Œ è¡¨ç¤ºç¨‹åºçš„æ‰§è¡Œç»“æœ</span></span><br><span class="line">    Processor::<span class="title function_ invoke__">process</span>(program_id, accounts, instruction_data)  <span class="comment">//è°ƒç”¨å‡½æ•°</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢<code>lib.rs</code>çš„ä»£ç æ˜¯Solanaç¨‹åºçš„æ ‡å‡†æ¡†æ¶ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬å¼•å…¥äº†ä¸€å †éœ€è¦çš„åº“ã€‚</p>
<p>å…¶æ¬¡ï¼Œä½¿ç”¨äº†<code>mod processor</code>å’Œ<code>mod instruction</code>åˆ†åˆ«å£°æ˜äº†<code>processor</code>æ¨¡å—å’Œ<code>instruction</code>æ¨¡å—ï¼Œåˆ†åˆ«ç”¨äºè´Ÿè´£æ ¸å¿ƒé€»è¾‘çš„å®ç°å’Œå®šä¹‰ä¸ç¨‹åºäº¤äº’çš„æŒ‡ä»¤ã€‚ä¹‹åä½¿ç”¨<code>use crate::processor::Processor;</code>å¼•å…¥<code>Processor</code>ç±»å‹ï¼Œè¿™æ˜¯åœ¨<code>processor</code>æ¨¡å—ä¸­å®šä¹‰çš„æ ¸å¿ƒé€»è¾‘å¤„ç†å™¨ã€‚å®ƒé€šå¸¸åŒ…å«ä¸€ä¸ªé™æ€æ–¹æ³•<code>process</code>ï¼Œç”¨äºæ ¹æ®ä¼ å…¥çš„æŒ‡ä»¤æ•°æ®è§£æå¹¶è°ƒç”¨å¯¹åº”çš„é€»è¾‘ã€‚</p>
<p>éšåï¼Œä½¿ç”¨<code>entrypoint!()</code>å®ç”¨äºå®šä¹‰ç¨‹åºçš„å…¥å£ç‚¹ä¸º<code>process_instruction</code>ã€‚å½“Solanaç¨‹åºåœ¨é“¾ä¸Šè¿è¡Œæ—¶ï¼Œä¼šä»è¯¥å…¥å£ç‚¹å¼€å§‹æ‰§è¡Œï¼Œä¼ å…¥<code>program_id</code>ã€<code>accounts</code>ã€<code>instruction_data</code>å‚æ•°ã€‚</p>
<p>æœ€åï¼Œå®šä¹‰ç¨‹åºçš„å…¥å£å‡½æ•°<code>process_instruction</code>:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">process_instruction</span>(</span><br><span class="line">    program_id: &amp;Pubkey,</span><br><span class="line">    accounts: &amp;[AccountInfo],</span><br><span class="line">    instruction_data: &amp;[<span class="type">u8</span>],</span><br><span class="line">) <span class="punctuation">-&gt;</span> ProgramResult &#123;</span><br><span class="line">    Processor::<span class="title function_ invoke__">process</span>(program_id, accounts, instruction_data)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®ƒéœ€è¦ä¼ å…¥ä¸‰ä¸ªå‚æ•°ï¼šç¬¬ä¸€ä¸ªæ˜¯å½“å‰æ™ºèƒ½åˆçº¦çš„åœ°å€ï¼›ç¬¬äºŒä¸ªæ˜¯è°ƒç”¨æŒ‡ä»¤æ—¶æ‰€éœ€è¦ä¼ é€’çš„è´¦æˆ·ä¿¡æ¯ï¼›ç¬¬ä¸‰ä¸ªæ˜¯å…·ä½“çš„æŒ‡ä»¤å’Œå‚æ•°ã€‚è¯¥å‡½æ•°è¿”å›ä¸€ä¸ªProgramResultç»“æœï¼Œè¡¨ç¤ºç¨‹åºçš„æ‰§è¡Œç»“æœã€‚è¯¥å‡½æ•°å†…éƒ¨è°ƒç”¨äº†å¦ä¸€ä¸ªå‡½æ•°:<code>Processor::process(program_id, accounts, instruction_data)</code>ï¼Œè¿™ä¸ªå‡½æ•°å…·ä½“æ‰§è¡Œäº†æŒ‡ä»¤ï¼Œæ˜¯æ•´ä¸ªæ™ºèƒ½åˆçº¦çš„å…³é”®ã€‚</p>
<h2 id="æŒ‡ä»¤Instruction"><a href="#æŒ‡ä»¤Instruction" class="headerlink" title="æŒ‡ä»¤Instruction"></a>æŒ‡ä»¤Instruction</h2><p>åœ¨å…·ä½“æ·±å…¥<code>Processor::process</code>å‰ï¼Œè®©æˆ‘ä»¬å…ˆçœ‹çœ‹è¿™ä¸ªåˆçº¦éœ€è¦å®ç°çš„æŒ‡ä»¤ï¼š<br>    - CreateTokenåˆ›å»ºä»£å¸<br>    - Minté“¸é€ ä»£å¸</p>
<p>æˆ‘ä»¬å°†å…¶å†™è¿›<code>instruction.rs</code>ä¸­ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> borsh::&#123;BorshDeserialize, BorshSerialize&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(BorshDeserialize, BorshSerialize)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">enum</span> <span class="title class_">TokenInstruction</span> &#123;</span><br><span class="line">    CreateToken&#123;decimals: <span class="type">u8</span>&#125;,</span><br><span class="line">    Mint&#123;amount: <span class="type">u64</span>&#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ä¸Šé¢ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ª<code>TokenInstruction</code>æšä¸¾æ¥å­˜å‚¨æˆ‘ä»¬çš„ä¸¤ä¸ªæŒ‡ä»¤ã€‚è¯¥<code>TokenInstruction</code>æšä¸¾å®ç°äº†<code>BorshDeserialize</code>å’Œ<code>BorshSerialize</code>ã€‚è¿™æ˜¯å› ä¸ºåœ¨åŒºå—é“¾ä¸­ï¼Œæ‰€æœ‰æ•°æ®ï¼ˆåŒ…æ‹¬æŒ‡ä»¤ï¼‰éƒ½ä»¥å­—èŠ‚æµ<code>byte stream</code>çš„å½¢å¼åœ¨èŠ‚ç‚¹ä¹‹é—´ä¼ è¾“ã€‚å› æ­¤æŒ‡ä»¤éœ€è¦å®ç°åºåˆ—åŒ–ï¼Œä»¥å°†æŒ‡ä»¤è½¬åŒ–ä¸ºå­—èŠ‚æµï¼Œä»¥ä¾¿åœ¨åŒºå—é“¾ä¸Šä¼ æ’­ï¼›åŒæ—¶éœ€è¦å®ç°ååºåˆ—åŒ–ï¼Œå°†å­—èŠ‚æµè¿˜åŸä¸ºç¨‹åºå¯ä»¥è¯†åˆ«å’Œæ“ä½œçš„ç»“æ„åŒ–æ•°æ®ã€‚</p>
<h2 id="Processor"><a href="#Processor" class="headerlink" title="Processor"></a>Processor</h2><p><code>processor.rs</code>ä¸­å…·ä½“å®ç°äº†<code>process</code>å‡½æ•°ï¼Œé¦–å…ˆå¯¼å…¥äº†å¿…è¦çš„åº“ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> solana_program::&#123;</span><br><span class="line">    account_info::&#123;next_account_info, AccountInfo&#125;, address_lookup_table::instruction, entrypoint::ProgramResult, msg, program::&#123;invoke, invoke_signed&#125;, pubkey::Pubkey, system_instruction, sysvar::&#123;rent::Rent, Sysvar&#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">use</span> spl_associated_token_account::instruction::create_associated_token_account;</span><br><span class="line"><span class="keyword">use</span> spl_token::&#123;instruction::&#123;initialize_mint, mint_to&#125;, state::Mint&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> crate::instruction::TokenInstruction;</span><br><span class="line"><span class="keyword">use</span> borsh::&#123;BorshDeserialize, BorshSerialize&#125;;</span><br></pre></td></tr></table></figure>

<p>å…¶æ¬¡ï¼Œå®šä¹‰äº†ä¸€ä¸ªç©ºçš„ç»“æ„ä½“<code>Processor</code>ï¼Œç”¨äºå°è£…<code>process</code>å‡½æ•°ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Processor</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Processor</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">process</span>(</span><br><span class="line">        program_id: &amp;Pubkey,</span><br><span class="line">        accounts: &amp;[AccountInfo],</span><br><span class="line">        instruction_data: &amp;[<span class="type">u8</span>],</span><br><span class="line">    ) <span class="punctuation">-&gt;</span> ProgramResult &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">instruction</span> = TokenInstruction::<span class="title function_ invoke__">try_from_slice</span>(instruction_data)?;</span><br><span class="line">        <span class="keyword">match</span> instruction &#123;</span><br><span class="line">            TokenInstruction::CreateToken &#123; decimals &#125; =&gt; <span class="keyword">Self</span>::<span class="title function_ invoke__">create_token</span>(accounts, decimals),</span><br><span class="line">            TokenInstruction::Mint &#123; amount &#125; =&gt; <span class="keyword">Self</span>::<span class="title function_ invoke__">mint_token</span>(accounts, amount),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ä¸Šé¢çš„<code>process</code>å‡½æ•°ä¸­ï¼Œé¦–å…ˆä½¿ç”¨äº†<code>try_from_slice</code>æ–¹æ³•å°†<code>instruction_data</code>è§£åºåˆ—åŒ–ä¸ºå®é™…çš„æŒ‡ä»¤ï¼Œéšåå¯¹æŒ‡ä»¤è¿›è¡Œæ¨¡å¼åŒ¹é…ï¼Œå¯¹ä¸åŒçš„æŒ‡ä»¤æ‰§è¡Œä¸åŒçš„æ“ä½œã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦é’ˆå¯¹ä¸¤ä¸ªä¸åŒçš„æŒ‡ä»¤ï¼š<code>CreateToken</code>å’Œ<code>Mint</code>ï¼Œæ„å»ºä¸åŒçš„å‡½æ•°ä»¥å®ç°æŒ‡ä»¤ã€‚</p>
<h3 id="CreatToken"><a href="#CreatToken" class="headerlink" title="CreatToken"></a>CreatToken</h3><p>è®©æˆ‘ä»¬å…ˆé’ˆå¯¹<code>CreateToken</code>æŒ‡ä»¤å®ç°<code>create_token</code>å‡½æ•°ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">create_token</span>(accounts: &amp;[AccountInfo], decimals: <span class="type">u8</span>) <span class="punctuation">-&gt;</span> ProgramResult &#123;&#125;</span><br></pre></td></tr></table></figure>
<p>é¦–å…ˆï¼Œè¯¥å‡½æ•°æ¥æ”¶å¿…é¡»çš„è´¦å·ä¿¡æ¯<code>accounts</code>å’Œéœ€è¦åˆ›å»ºçš„tokençš„ç²¾åº¦<code>decimal</code>ä¸¤ä¸ªå‚æ•°ï¼Œå¹¶è¿”å›ä¸€ä¸ª<code>ProgramResult</code>ç»“æœã€‚</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">accounts_iter</span> = &amp;<span class="keyword">mut</span> accounts.<span class="title function_ invoke__">iter</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="variable">mint_account</span> = <span class="title function_ invoke__">next_account_info</span>(accounts_iter)?;   </span><br><span class="line"><span class="keyword">let</span> <span class="variable">mint_authority</span> = <span class="title function_ invoke__">next_account_info</span>(accounts_iter)?;</span><br><span class="line"><span class="keyword">let</span> <span class="variable">payer</span> = <span class="title function_ invoke__">next_account_info</span>(accounts_iter)?;</span><br><span class="line"><span class="keyword">let</span> <span class="variable">rent_sysvar</span> = <span class="title function_ invoke__">next_account_info</span>(accounts_iter)?;</span><br><span class="line"><span class="keyword">let</span> <span class="variable">system_program</span> = <span class="title function_ invoke__">next_account_info</span>(accounts_iter)?;</span><br><span class="line"><span class="keyword">let</span> <span class="variable">token_program</span> = <span class="title function_ invoke__">next_account_info</span>(accounts_iter)?;</span><br></pre></td></tr></table></figure>
<p>éšåï¼Œå°†ä¼ å…¥çš„è´¦å·ä¿¡æ¯æ•°ç»„è½¬åŒ–ä¸ºè¿­ä»£å™¨ï¼Œå¹¶ä¾æ¬¡æå–å‡ºç¨‹åºæ‰€éœ€çš„è´¦æˆ·ä¿¡æ¯ã€‚</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">msg!(<span class="string">&quot;Creating mint account...&quot;</span>);</span><br><span class="line">msg!(<span class="string">&quot;Mint account is &#123;&#125;&quot;</span>, mint_account.key);</span><br></pre></td></tr></table></figure>
<p>æ‰“å°æ—¥å¿—ï¼Œè¡¨æ˜æ­£åœ¨åˆ›å»ºä»£å¸çš„Mintè´¦æˆ·ã€‚</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">create_account_ix</span> = &amp;system_instruction::<span class="title function_ invoke__">create_account</span>(</span><br><span class="line">    payer.key,</span><br><span class="line">    mint_account.key,</span><br><span class="line">    (Rent::<span class="title function_ invoke__">get</span>()?).<span class="title function_ invoke__">minimum_balance</span>(<span class="number">82</span>),</span><br><span class="line">    <span class="number">82</span>,</span><br><span class="line">    token_program.key,</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">invoke</span>(</span><br><span class="line">    create_account_ix,</span><br><span class="line">    &amp;[</span><br><span class="line">        mint_account.<span class="title function_ invoke__">clone</span>(),</span><br><span class="line">        payer.<span class="title function_ invoke__">clone</span>(),</span><br><span class="line">        system_program.<span class="title function_ invoke__">clone</span>(),</span><br><span class="line">        token_program.<span class="title function_ invoke__">clone</span>(),</span><br><span class="line">    ],</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>åœ¨è¿™ä¹‹åï¼Œè°ƒç”¨äº†<code>system_instrucion::create_account</code>æ–¹æ³•ï¼Œåˆ›å»ºä¸€ä¸ª<code>create_account_ix</code>æŒ‡ä»¤ï¼Œè¯¥æŒ‡ä»¤æ˜¯solanaç³»ç»ŸæŒ‡ä»¤ä¸­çš„åˆ›å»ºè´¦æˆ·æŒ‡ä»¤ã€‚éšåï¼Œä½¿ç”¨<code>invoke()</code>è°ƒç”¨è¯¥æŒ‡ä»¤ï¼ˆä¼ å…¥å¿…è¦çš„è´¦æˆ·ä¿¡æ¯ï¼‰ï¼Œå®ç°äº†åˆ›å»ºè´¦æˆ·è¿™ä¸€ä¸ªæ“ä½œã€‚</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">mint_init_ix</span> = <span class="title function_ invoke__">initialize_mint</span>(</span><br><span class="line">    token_program.key,</span><br><span class="line">    mint_account.key,</span><br><span class="line">    mint_authority.key,</span><br><span class="line">    <span class="literal">None</span>,</span><br><span class="line">    decimals,</span><br><span class="line">)?;</span><br><span class="line"></span><br><span class="line">msg!(<span class="string">&quot;initialize_mint account...&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">invoke_signed</span>(</span><br><span class="line">    &amp;mint_init_ix,</span><br><span class="line">    &amp;[</span><br><span class="line">        mint_account.<span class="title function_ invoke__">clone</span>(),</span><br><span class="line">        rent_sysvar.<span class="title function_ invoke__">clone</span>(),</span><br><span class="line">        token_program.<span class="title function_ invoke__">clone</span>(),</span><br><span class="line">        mint_authority.<span class="title function_ invoke__">clone</span>(),</span><br><span class="line">    ],</span><br><span class="line">    &amp;[],</span><br><span class="line">)?;</span><br></pre></td></tr></table></figure>
<p>ä¹‹åï¼Œæˆ‘ä»¬åˆè°ƒç”¨äº†<code>system_instrucion::initialize_mint</code>æ–¹æ³•ï¼Œåˆ›å»ºä¸€ä¸ª<code>mint_init_ix</code>æŒ‡ä»¤ï¼Œè¯¥æŒ‡ä»¤æ˜¯solanaç³»ç»ŸæŒ‡ä»¤ä¸­çš„åˆå§‹åŒ–Mintè´¦æˆ·æŒ‡ä»¤ã€‚éšåï¼Œä½¿ç”¨<code>invoke()</code>è°ƒç”¨è¯¥æŒ‡ä»¤ï¼ˆä¼ å…¥å¿…è¦çš„è´¦æˆ·ä¿¡æ¯ï¼‰ï¼Œå°†æˆ‘ä»¬åˆšåˆšåˆ›å»ºçš„è´¦æˆ·åˆå§‹åŒ–ä¸ºä¸€ä¸ªMintè´¦æˆ·ã€‚<code>Mint Account</code>æ˜¯ä¸€ç§ä»£å¸çš„æ ¹è´¦æˆ·ï¼Œæ§åˆ¶è¯¥ä»£å¸çš„ç”Ÿæˆã€é”€æ¯å’Œç®¡ç†ã€‚æ¯ç§ä»£å¸å¯¹åº”ä¸€ä¸ª<code>Mint Account</code>ã€‚</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">msg!(<span class="string">&quot;SPL Token Mint create success&quot;</span>);</span><br><span class="line">         </span><br><span class="line"><span class="title function_ invoke__">Ok</span>(()) </span><br></pre></td></tr></table></figure>
<p>æœ€åï¼Œæ‰“å°æ—¥å¿—<code>SPL Token Mint create success</code>è¡¨æ˜æˆåŠŸåˆ›å»ºäº†ä¸€ä¸ªSPL Token Mint accountï¼Œå¹¶è¿”å›<code>Ok(())</code>ã€‚</p>
<h3 id="Mint"><a href="#Mint" class="headerlink" title="Mint"></a>Mint</h3><p>åœ¨æˆåŠŸåˆ›å»ºå®Œäº†ä¸€ä¸ªMintè´¦æˆ·ä¹‹åï¼Œè®©æˆ‘ä»¬æ¥æ„å»º<code>mint_token</code>å‡½æ•°æ¥Mintä¸€å®šæ•°é‡çš„ä»£å¸åˆ°æŒ‡å®šçš„è´¦æˆ·ä¸­ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">mint_token</span>(accounts: &amp;[AccountInfo], amount: <span class="type">u64</span>) <span class="punctuation">-&gt;</span> ProgramResult &#123;&#125;</span><br></pre></td></tr></table></figure>
<p>è¯¥å‡½æ•°éœ€è¦æˆ‘ä»¬ä¼ å…¥ç›¸å…³è´¦æˆ·ä¿¡æ¯ä»¥åŠéœ€è¦mintçš„ä»£å¸æ•°é‡ï¼Œå¹¶è¿”å›ä¸€ä¸ª<code>ProgramResult</code>ã€‚</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">accounts_iter</span> = &amp;<span class="keyword">mut</span> accounts.<span class="title function_ invoke__">iter</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="variable">mint_account</span> = <span class="title function_ invoke__">next_account_info</span>(accounts_iter)?;</span><br><span class="line"><span class="keyword">let</span> <span class="variable">associated_token_account</span> = <span class="title function_ invoke__">next_account_info</span>(accounts_iter)?;</span><br><span class="line"><span class="keyword">let</span> <span class="variable">rent_sysvar</span> = <span class="title function_ invoke__">next_account_info</span>(accounts_iter)?;</span><br><span class="line"><span class="keyword">let</span> <span class="variable">payer</span> = <span class="title function_ invoke__">next_account_info</span>(accounts_iter)?;</span><br><span class="line"><span class="keyword">let</span> <span class="variable">system_program</span> = <span class="title function_ invoke__">next_account_info</span>(accounts_iter)?;</span><br><span class="line"><span class="keyword">let</span> <span class="variable">token_program</span> = <span class="title function_ invoke__">next_account_info</span>(accounts_iter)?;</span><br><span class="line"><span class="keyword">let</span> <span class="variable">associated_token_program</span> = <span class="title function_ invoke__">next_account_info</span>(accounts_iter)?;</span><br><span class="line"></span><br><span class="line">msg!(<span class="string">&quot;ATA is &#123;:?&#125;&quot;</span>, associated_token_account);</span><br></pre></td></tr></table></figure>
<p>åŒä¸Šä¸€ä¸ªå‡½æ•°ä¸€æ ·ï¼Œä»ä¼ å…¥çš„è´¦æˆ·ä¿¡æ¯ä¸­åŒ¹é…ç›¸å¯¹åº”çš„è´¦æˆ·åœ°å€ï¼Œå¹¶æ‰“å°æ—¥å¿—ã€‚</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> associated_token_account.<span class="title function_ invoke__">lamports</span>() == <span class="number">0</span> &#123;</span><br><span class="line">    msg!(<span class="string">&quot;Creating associated token account ...&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">create_ata_ix</span> = &amp;spl_associated_token_account::instruction::<span class="title function_ invoke__">create_associated_token_account</span>(</span><br><span class="line">        payer.key, </span><br><span class="line">        payer.key, </span><br><span class="line">        mint_account.key, </span><br><span class="line">        token_program.key,</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">invoke</span>(</span><br><span class="line">        create_ata_ix,</span><br><span class="line">        &amp;[</span><br><span class="line">            payer.<span class="title function_ invoke__">clone</span>(),</span><br><span class="line">            associated_token_account.<span class="title function_ invoke__">clone</span>(),</span><br><span class="line">            mint_account.<span class="title function_ invoke__">clone</span>(),</span><br><span class="line">            system_program.<span class="title function_ invoke__">clone</span>(),</span><br><span class="line">            token_program.<span class="title function_ invoke__">clone</span>(),</span><br><span class="line">            rent_sysvar.<span class="title function_ invoke__">clone</span>(),</span><br><span class="line">            associated_token_program.<span class="title function_ invoke__">clone</span>(),</span><br><span class="line">        ]</span><br><span class="line">    )?;</span><br></pre></td></tr></table></figure>
<p>é¦–å…ˆï¼Œç¡®è®¤ä¼ å…¥çš„åœ°å€ä¸­æ˜¯å¦å­˜åœ¨ä½™é¢ï¼Œå¦‚æœæ²¡æœ‰ä½™é¢ï¼Œåˆ™è¡¨æ˜è¯¥è´¦æˆ·å°šæœªè¢«åˆ›å»ºè¿‡ï¼Œå¯ä»¥ç»§ç»­è¿›è¡Œä¸‹é¢çš„æ“ä½œå°†å…¶åˆå§‹åŒ–ä¸ºä¸€ä¸ªataè´¦æˆ·ã€‚æ¥ä¸‹æ¥ï¼Œåˆ›å»ºä¸€ä¸ª<code>create_associated_token_account</code>çš„æŒ‡ä»¤ï¼Œå¹¶ä½¿ç”¨<code>invoke()</code>å‡½æ•°è°ƒç”¨å®ƒï¼Œç”Ÿæˆä¸€ä¸ªataè´¦æˆ·ã€‚</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">mint_ix</span> = &amp;<span class="title function_ invoke__">mint_to</span>(</span><br><span class="line">    token_program.key,</span><br><span class="line">    mint_account.key,</span><br><span class="line">    associated_token_account.key,</span><br><span class="line">    payer.key,</span><br><span class="line">    &amp;[payer.key],</span><br><span class="line">    amount</span><br><span class="line">)?;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">invoke</span>(</span><br><span class="line">    mint_ix,</span><br><span class="line">    &amp;[</span><br><span class="line">        mint_account.<span class="title function_ invoke__">clone</span>(),</span><br><span class="line">        payer.<span class="title function_ invoke__">clone</span>(),</span><br><span class="line">        associated_token_account.<span class="title function_ invoke__">clone</span>(),</span><br><span class="line">        token_program.<span class="title function_ invoke__">clone</span>(),</span><br><span class="line">    ]</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">msg!(<span class="string">&quot;Tokens minted to ata&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>ä¹‹åï¼Œå†åˆ›å»ºä¸€ä¸ª<code>mint_to</code>æŒ‡ä»¤ï¼Œè¡¨ç¤ºéœ€è¦å°†ä¸€å®šæ•°é‡çš„ä»£å¸mintå‡ºæ¥å¹¶è½¬è´¦è‡³ç»™å®šçš„ataè´¦æˆ·ä¸­ï¼Œå¹¶ä½¿ç”¨<code>invoke()</code>å‡½æ•°è°ƒç”¨å®ƒï¼Œå®Œæˆè¯¥æŒ‡ä»¤ã€‚</p>
<p>è‡³æ­¤ï¼Œæˆ‘ä»¬å°±æˆåŠŸæ„å»ºäº†ä¸¤ä¸ªæŒ‡ä»¤çš„å…·ä½“æ“ä½œå‡½æ•°ï¼Œå®Œæˆäº†è¿™ä¸€ä»½æ™ºèƒ½åˆçº¦ã€‚</p>
<h2 id="CLIè°ƒç”¨"><a href="#CLIè°ƒç”¨" class="headerlink" title="CLIè°ƒç”¨"></a>CLIè°ƒç”¨</h2><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ„å»ºä¸€ä¸ªcliæ¥è°ƒç”¨æˆ‘ä»¬åˆšåˆšåˆ›å»ºå¥½çš„SPL-Tokenæ™ºèƒ½åˆçº¦:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> borsh::&#123;BorshDeserialize, BorshSerialize&#125;;</span><br><span class="line"><span class="keyword">use</span> solana_client::rpc_client::&#123;<span class="keyword">self</span>, RpcClient&#125;;</span><br><span class="line"><span class="keyword">use</span> solana_sdk::account::Account;</span><br><span class="line"><span class="keyword">use</span> solana_sdk::address_lookup_table::instruction;</span><br><span class="line"><span class="keyword">use</span> solana_sdk::instruction::&#123;AccountMeta, Instruction&#125;;</span><br><span class="line"><span class="keyword">use</span> solana_sdk::signature::read_keypair_file;</span><br><span class="line"><span class="keyword">use</span> solana_sdk::pubkey::Pubkey;</span><br><span class="line"><span class="keyword">use</span> solana_sdk::signer::keypair::Keypair;</span><br><span class="line"><span class="keyword">use</span> solana_sdk::transaction::Transaction;</span><br><span class="line"><span class="keyword">use</span> std::<span class="type">str</span>::FromStr;</span><br><span class="line"><span class="keyword">use</span> solana_sdk::signer::Signer;</span><br><span class="line"><span class="keyword">use</span> solana_sdk::sysvar;</span><br><span class="line"><span class="keyword">use</span> spl_associated_token_account_client::address::get_associated_token_address;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(BorshDeserialize, BorshSerialize)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">enum</span> <span class="title class_">TokenInstruction</span> &#123;</span><br><span class="line">    CreateToken&#123;decimals: <span class="type">u8</span>&#125;,</span><br><span class="line">    Mint&#123;amount: <span class="type">u64</span>&#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é¦–å…ˆæˆ‘ä»¬å¯¼å…¥å¿…è¦çš„åº“ï¼Œä»¥åŠéœ€è¦è°ƒç”¨çš„æŒ‡ä»¤ã€‚</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[test]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">test_fn</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">rpc_client</span> = RpcClient::<span class="title function_ invoke__">new</span>(<span class="string">&quot;http://127.0.0.1:8899&quot;</span>.<span class="title function_ invoke__">to_string</span>());</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">payer</span> = <span class="title function_ invoke__">read_keypair_file</span>(<span class="string">&quot;/Users/wbjxyy/.config/solana/id.json&quot;</span>).<span class="title function_ invoke__">expect</span>(<span class="string">&quot;failed&quot;</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">program_id</span> = Pubkey::<span class="title function_ invoke__">from_str</span>(<span class="string">&quot;6SorUwdvqsn2LUsZp7zKHiQSVkWydBpStBgGyn7MBBwD&quot;</span>).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">mint_account</span> = Keypair::<span class="title function_ invoke__">new</span>();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;mint_account is : &#123;&#125;&quot;</span>, mint_account.<span class="title function_ invoke__">pubkey</span>().<span class="title function_ invoke__">to_string</span>());</span><br><span class="line"></span><br><span class="line">    _ = <span class="title function_ invoke__">create_token</span>(&amp;rpc_client, &amp;program_id, &amp;payer, &amp;mint_account, &amp;payer.<span class="title function_ invoke__">pubkey</span>(), <span class="number">6</span>);</span><br><span class="line">    _ = <span class="title function_ invoke__">mint</span>(&amp;rpc_client, &amp;program_id, &amp;payer, &amp;mint_account, <span class="number">100_000_000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>éšåæˆ‘ä»¬æ„å»ºä¸€ä¸ªæµ‹è¯•å‡½æ•°ï¼š</p>
<ul>
<li>é¦–å…ˆï¼Œä½¿ç”¨<code>RpcClient</code>æ–¹æ³•ï¼Œåˆ›å»ºäº†ä¸€ä¸ªè¿æ¥åˆ°æœ¬åœ°SolanaèŠ‚ç‚¹çš„å®¢æˆ·ç«¯ï¼ˆ<code>http://127.0.0.1:8899</code>æ˜¯æœ¬åœ°SolanaèŠ‚ç‚¹çš„RPCåœ°å€ï¼Œé»˜è®¤ç«¯å£ä¸º8899ï¼‰ï¼Œè¯¥æ–¹æ³•è¿”å›äº†ä¸€ä¸ª<code>RpcClient</code>å¯¹è±¡ï¼Œåç»­å¯ä»¥ä½¿ç”¨è¯¥å¯¹è±¡è°ƒç”¨é“¾ä¸Šæ–¹æ³•ã€‚</li>
<li>å…¶æ¬¡ï¼Œæˆ‘ä»¬ä½¿ç”¨<code>read_keypair_file</code>æ–¹æ³•ä»æ–‡ä»¶ä¸­è¯»å–å‡ºä¸€ä¸ªå¯†é’¥å¯¹(<code>KeyPair</code>)ï¼Œä½œä¸ºäº¤æ˜“ç­¾åè€…ï¼Œå¹¶æ”¯ä»˜ç›¸åº”çš„äº¤æ˜“è´¹ç”¨ã€‚</li>
<li>è¿™ä¹‹åï¼Œé€šè¿‡<code>Pubkey::from_str</code>è¯»å–æˆ‘ä»¬å…ˆå‰å°±éƒ¨ç½²å¥½çš„SPL-Tokenåˆçº¦ã€‚</li>
<li>å†é€šè¿‡<code>Keypair::new()</code>åˆ›å»ºä¸€ä¸ªå…¨æ–°çš„è´¦æˆ·ï¼Œç”¨äºåç»­å°†å…¶åˆå§‹åŒ–ä¸ºMintè´¦æˆ·</li>
<li>æœ€åï¼Œåˆ†åˆ«è°ƒç”¨<code>create_token</code>å’Œ<code>mint</code>ä¸¤ä¸ªå‡½æ•°ï¼ˆä¸æ˜¯åˆçº¦é‡Œçš„ä¸¤ä¸ªï¼‰ã€‚</li>
</ul>
<h3 id="CLIä¸­çš„create-tokenå‡½æ•°"><a href="#CLIä¸­çš„create-tokenå‡½æ•°" class="headerlink" title="CLIä¸­çš„create_tokenå‡½æ•°"></a>CLIä¸­çš„<code>create_token</code>å‡½æ•°</h3><p>ä¹‹åï¼Œæˆ‘ä»¬å†åˆ›å»ºä¸€ä¸ª<code>create_token</code>å‡½æ•°ï¼Œç”¨äºæ¨¡ä»¿åœ¨å®é™…æ“ä½œä¸­è°ƒç”¨SPL-Tokenåˆçº¦ä¸­çš„<code>CreateToken</code>æŒ‡ä»¤ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">create_token</span>(</span><br><span class="line">    rpc_client: &amp;RpcClient,</span><br><span class="line">    program_id: &amp;Pubkey,</span><br><span class="line">    payer: &amp;Keypair,</span><br><span class="line">    mint_account: &amp;Keypair, </span><br><span class="line">    mint_authority: &amp;Pubkey,    <span class="comment">//é“¸é€ æƒé™åœ°å€ï¼Œè¿™ä¸ªåœ°å€æœ‰æƒé“¸é€ ä»£å¸</span></span><br><span class="line">    decimals: <span class="type">u8</span>,</span><br><span class="line">) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;(), <span class="type">Box</span>&lt;<span class="keyword">dyn</span> std::error::Error&gt;&gt; &#123;&#125;</span><br></pre></td></tr></table></figure>
<p>é¦–å…ˆï¼Œè¯¥å‡½æ•°æ¥æ”¶å¦‚ä¸Šå…­ä¸ªå‚æ•°ï¼Œå…¶ä¸­ä¸€ä¸ªæ˜¯<code>&amp;RpcClient</code>å®¢æˆ·ç«¯ï¼Œä¸€ä¸ªæ˜¯<code>decimals</code>ä»£è¡¨Tokençš„ç²¾åº¦ï¼Œå‰©ä¸‹å››ä¸ªå‡æ˜¯è´¦æˆ·ä¿¡æ¯ï¼Œå¯¹åº”åˆçº¦ä¸­éœ€è¦ä¼ å…¥çš„<code>&amp;[AccountInfo]</code>ã€‚</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">instruction_data</span> = borsh::<span class="title function_ invoke__">to_vec</span>(&amp;TokenInstruction::CreateToken &#123; decimals &#125;).<span class="title function_ invoke__">unwrap</span>();</span><br></pre></td></tr></table></figure>
<p>å…ˆæŒ‡å®šè¦è°ƒç”¨çš„æŒ‡ä»¤ä¸º<code>CreateToken</code>å¹¶å°†å…¶åºåˆ—åŒ–ã€‚</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">accounts</span> = <span class="built_in">vec!</span>[</span><br><span class="line">    AccountMeta::<span class="title function_ invoke__">new</span>(mint_account.<span class="title function_ invoke__">pubkey</span>(), <span class="literal">true</span>),</span><br><span class="line">    AccountMeta::<span class="title function_ invoke__">new_readonly</span>(*mint_authority, <span class="literal">false</span>),</span><br><span class="line">    AccountMeta::<span class="title function_ invoke__">new_readonly</span>(payer.<span class="title function_ invoke__">pubkey</span>(), <span class="literal">false</span>),</span><br><span class="line">    AccountMeta::<span class="title function_ invoke__">new_readonly</span>(sysvar::rent::<span class="title function_ invoke__">id</span>(), <span class="literal">false</span>),</span><br><span class="line">    AccountMeta::<span class="title function_ invoke__">new_readonly</span>(solana_sdk::system_program::<span class="title function_ invoke__">id</span>(), <span class="literal">false</span>),</span><br><span class="line">    AccountMeta::<span class="title function_ invoke__">new_readonly</span>(spl_token::<span class="title function_ invoke__">id</span>(), <span class="literal">false</span>),</span><br><span class="line">];</span><br></pre></td></tr></table></figure>
<p>å°†ä¼ å…¥è¯¥å‡½æ•°çš„è´¦æˆ·ä¿¡æ¯å‚æ•°è½¬åŒ–ä¸ºåˆçº¦ä¸­<code>create_token</code>å‡½æ•°æ‰€éœ€çš„è´¦æˆ·ä¿¡æ¯å‚æ•°ã€‚</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">token_instruction</span> = Instruction&#123;</span><br><span class="line">    program_id: *program_id,</span><br><span class="line">    accounts,</span><br><span class="line">    data: instruction_data,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>å°†éœ€è¦è°ƒç”¨çš„åˆçº¦åœ°å€ï¼Œå¯¹åº”çš„è´¦æˆ·ä¿¡æ¯ä»¥åŠæŒ‡ä»¤æ‰“åŒ…æˆä¸€ä¸ªæŒ‡ä»¤ã€‚</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">latest_blockhash</span> = rpc_client.<span class="title function_ invoke__">get_latest_blockhash</span>()?;</span><br><span class="line"><span class="keyword">let</span> <span class="variable">tx</span> = Transaction::<span class="title function_ invoke__">new_signed_with_payer</span>(</span><br><span class="line">    &amp;[token_instruction],</span><br><span class="line">    <span class="title function_ invoke__">Some</span>(&amp;payer.<span class="title function_ invoke__">pubkey</span>()),      <span class="comment">//äº¤æ˜“è´¹ç”¨æ”¯ä»˜è€…çš„å…¬é’¥</span></span><br><span class="line">    &amp;[payer, mint_account],     <span class="comment">//ç”¨äºç­¾ç½²äº¤æ˜“çš„ç­¾åè€…æ•°ç»„</span></span><br><span class="line">    latest_blockhash</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>è·å–æœ€æ–°çš„blockhash, å¹¶åˆ›å»ºä¸€ä¸ªåŒ…å«ä¸Šé¢æŒ‡ä»¤çš„äº¤æ˜“ã€‚</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å‘é€äº¤æ˜“å¹¶ç­‰å¾…ç¡®è®¤</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">r</span> = rpc_client.<span class="title function_ invoke__">send_and_confirm_transaction</span>(&amp;tx)?;</span><br><span class="line"></span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, r);</span><br><span class="line"></span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;create token successfully&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">Ok</span>(())</span><br></pre></td></tr></table></figure>
<p>å‘é€äº¤æ˜“å¹¶ç­‰å¾…ç¡®è®¤ã€‚</p>
<h3 id="CLIä¸­çš„mintå‡½æ•°"><a href="#CLIä¸­çš„mintå‡½æ•°" class="headerlink" title="CLIä¸­çš„mintå‡½æ•°"></a>CLIä¸­çš„<code>mint</code>å‡½æ•°</h3><p><code>mint</code>å‡½æ•°çš„é€»è¾‘ä¸<code>create_token</code>å‡½æ•°åŸºæœ¬ä¸€è‡´ï¼Œè¿™é‡Œåªå±•ç¤ºä»£ç ï¼Œä¸å†è¿‡å¤šèµ˜è¿°ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">mint</span>(</span><br><span class="line">    rpc_client: &amp;RpcClient,</span><br><span class="line">    program_id: &amp;Pubkey,</span><br><span class="line">    payer: &amp;Keypair,</span><br><span class="line">    mint_account: &amp;Keypair, </span><br><span class="line">    amount: <span class="type">u64</span>,</span><br><span class="line">) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;(), <span class="type">Box</span>&lt;<span class="keyword">dyn</span> std::error::Error&gt;&gt; &#123;</span><br><span class="line">    <span class="comment">// æ ¹æ®payerçš„å…¬é’¥å’Œmint_accountçš„å…¬é’¥åˆ›å»ºä¸€ä¸ªataè´¦æˆ·</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">ata</span> = <span class="title function_ invoke__">get_associated_token_address</span>(&amp;payer.<span class="title function_ invoke__">pubkey</span>(), &amp;mint_account.<span class="title function_ invoke__">pubkey</span>());</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;ata is &#123;&#125;&quot;</span>, ata.<span class="title function_ invoke__">to_string</span>());</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">instruction_data</span> = borsh::<span class="title function_ invoke__">to_vec</span>(&amp;TokenInstruction::Mint &#123; amount &#125;).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">accounts</span> = <span class="built_in">vec!</span>[</span><br><span class="line">        AccountMeta::<span class="title function_ invoke__">new</span>(mint_account.<span class="title function_ invoke__">pubkey</span>(), <span class="literal">true</span>),</span><br><span class="line">        AccountMeta::<span class="title function_ invoke__">new</span>(ata, <span class="literal">false</span>),</span><br><span class="line">        AccountMeta::<span class="title function_ invoke__">new_readonly</span>(sysvar::rent::<span class="title function_ invoke__">id</span>(), <span class="literal">false</span>),</span><br><span class="line">        AccountMeta::<span class="title function_ invoke__">new</span>(payer.<span class="title function_ invoke__">pubkey</span>(), <span class="literal">true</span>),</span><br><span class="line">        AccountMeta::<span class="title function_ invoke__">new_readonly</span>(solana_sdk::system_program::<span class="title function_ invoke__">id</span>(), <span class="literal">false</span>),</span><br><span class="line">        AccountMeta::<span class="title function_ invoke__">new_readonly</span>(spl_token::<span class="title function_ invoke__">id</span>(), <span class="literal">false</span>),</span><br><span class="line">        AccountMeta::<span class="title function_ invoke__">new_readonly</span>(spl_associated_token_account::<span class="title function_ invoke__">id</span>(), <span class="literal">false</span>),</span><br><span class="line"></span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">token_instruction</span> = Instruction&#123;</span><br><span class="line">        program_id: *program_id,</span><br><span class="line">        accounts,</span><br><span class="line">        data: instruction_data,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">latest_blockhash</span> = rpc_client.<span class="title function_ invoke__">get_latest_blockhash</span>()?;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">tx</span> = Transaction::<span class="title function_ invoke__">new_signed_with_payer</span>(</span><br><span class="line">        &amp;[token_instruction],</span><br><span class="line">        <span class="title function_ invoke__">Some</span>(&amp;payer.<span class="title function_ invoke__">pubkey</span>()),</span><br><span class="line">        &amp;[payer, mint_account],</span><br><span class="line">        latest_blockhash</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å‘é€äº¤æ˜“å¹¶ç­‰å¾…ç¡®è®¤</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">r</span> = rpc_client.<span class="title function_ invoke__">send_and_confirm_transaction</span>(&amp;tx)?;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, r);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;mint token successfully&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/11/02/rust-concurrency2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Wobujiaoxyy3">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/11/02/rust-concurrency2/" class="post-title-link" itemprop="url">Rustè¿›é˜¶-å¹¶å‘2</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-11-02 20:36:24" itemprop="dateCreated datePublished" datetime="2024-11-02T20:36:24+08:00">2024-11-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-11-14 07:43:16" itemprop="dateModified" datetime="2024-11-14T07:43:16+08:00">2024-11-14</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="å…±äº«å†…å­˜"><a href="#å…±äº«å†…å­˜" class="headerlink" title="å…±äº«å†…å­˜"></a>å…±äº«å†…å­˜</h1><p>åœ¨ä¸Šä¸€èŠ‚è¯¾ä¸­ï¼Œæˆ‘ä»¬å­¦ä¹ äº†æ¶ˆæ¯ä¼ é€’å¹¶å‘æ¨¡å‹ï¼Œæ¶ˆæ¯ä¼ é€’å¹¶å‘æ¨¡å‹é€šè¿‡é€šé“ï¼ˆchannelï¼‰åœ¨å¤šä¸ªçº¿ç¨‹ä¹‹é—´ä¼ é€’æ¶ˆæ¯ï¼Œä»è€Œå®ç°å¹¶å‘ã€‚è€Œå®é™…ä¸Šæˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡<strong>å…±äº«å†…å­˜</strong>çš„æ–¹å¼æ¥å®ç°å¹¶å‘ã€‚ </p>
<p>åœ¨é€šè¿‡é€šé“è¿›è¡Œé€šä¿¡æ—¶ï¼Œæˆ‘ä»¬å®é™…ä¸Šæ˜¯åœ¨é€šè¿‡æ¶ˆæ¯ä¼ é€’çš„æ–¹å¼è¿›è¡Œé€šä¿¡ï¼Œè¿™ç§æ–¹å¼ç±»ä¼¼äº<strong>æ‰€æœ‰æƒ</strong>ï¼Œä¸€æ—¦æˆ‘ä»¬å°†å€¼çš„æ‰€æœ‰æƒè½¬ç§»è‡³Channelä¸­ï¼Œæˆ‘ä»¬å°±æ— æ³•å†ä½¿ç”¨è¯¥å€¼ã€‚è€Œå…±äº«å†…å­˜å¹¶å‘åˆ™ç±»ä¼¼äºå¤šæ‰€æœ‰æƒï¼Œå¤šä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶è¯»å†™åŒä¸€å—å†…å­˜ã€‚</p>
<h2 id="äº’æ–¥é”-Mutex"><a href="#äº’æ–¥é”-Mutex" class="headerlink" title="äº’æ–¥é” Mutex"></a>äº’æ–¥é” Mutex</h2><p>äº’æ–¥é”<code>Mutex</code>æ˜¯Rustæ ‡å‡†åº“æä¾›çš„ç”¨äºå…±äº«å†…å­˜çš„å¹¶å‘åŸè¯­ã€‚å®ƒæ˜¯<code>multipule exlusion</code>çš„ç¼©å†™ï¼Œæ„ä¸º<strong>å¤šçº¿ç¨‹äº’æ–¥</strong>ã€‚<code>Mutex</code>è®©å¤šä¸ªçº¿ç¨‹å¹¶å‘çš„è®¿é—®åŒä¸€ä¸ªå€¼å˜æˆäº†æ’é˜Ÿè®¿é—®ï¼šåŒä¸€æ—¶é—´ï¼Œåªå…è®¸ä¸€ä¸ªçº¿ç¨‹<code>A</code>è®¿é—®è¯¥å€¼ï¼Œå…¶ä»–çº¿ç¨‹<code>B</code>åˆ™éœ€è¦ç­‰å¾…çº¿ç¨‹<code>A</code>è®¿é—®ç»“æŸã€‚</p>
<p>å¦‚æœæƒ³è¦è®¿é—®æ•°æ®ï¼š</p>
<ul>
<li>çº¿ç¨‹<code>A</code>éœ€è¦å…ˆè·å–<code>Mutex</code>çš„é”(<code>lock</code>)ï¼Œåªæœ‰è·å–åˆ°é”ï¼Œæ‰èƒ½è®¿é—®æ•°æ®ã€‚</li>
<li>lockæ•°æ®ç»“æ„æ˜¯<code>Mutex</code>çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒèƒ½è·Ÿè¸ªè°å¯¹æ•°æ®æ‹¥æœ‰ç‹¬å è®¿é—®æƒ</li>
<li><code>mutex</code>é€šå¸¸è¢«æè¿°ä¸ºï¼šé€šè¿‡é”å®šç³»ç»Ÿæ¥ä¿æŠ¤å®ƒæ‰€æŒæœ‰çš„æ•°æ®</li>
</ul>
<h2 id="Mutex-çš„ä¸¤æ¡è§„åˆ™"><a href="#Mutex-çš„ä¸¤æ¡è§„åˆ™" class="headerlink" title="Mutex çš„ä¸¤æ¡è§„åˆ™"></a>Mutex çš„ä¸¤æ¡è§„åˆ™</h2><ul>
<li>åœ¨ä½¿ç”¨æ•°æ®ä¹‹å‰ï¼Œå¿…é¡»å°è¯•è·å–é”ï¼ˆ<code>lock</code>ï¼‰</li>
<li>åœ¨ä½¿ç”¨å®Œ<code>mutex</code>æ‰€ä¿æŠ¤çš„æ•°æ®åï¼Œå¿…é¡»é‡Šæ”¾é”ï¼ˆ<code>unlock</code>ï¼‰ï¼Œä»¥ä¾¿å…¶ä»–çš„çº¿ç¨‹å¯ä»¥è·å–é”</li>
</ul>
<h2 id="ä½¿ç”¨-Mutex"><a href="#ä½¿ç”¨-Mutex" class="headerlink" title="ä½¿ç”¨ Mutex"></a>ä½¿ç”¨ Mutex</h2><h3 id="å•çº¿ç¨‹ä¸­ä½¿ç”¨Mutex"><a href="#å•çº¿ç¨‹ä¸­ä½¿ç”¨Mutex" class="headerlink" title="å•çº¿ç¨‹ä¸­ä½¿ç”¨Mutex"></a>å•çº¿ç¨‹ä¸­ä½¿ç”¨Mutex</h3><p>è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªä¾‹å­æ¥çœ‹çœ‹å•çº¿ç¨‹ä¸­å¦‚ä½•ä½¿ç”¨<code>Mutex</code>ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::sync::Mutex;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// åˆ›å»ºä¸€ä¸ªMutexæ™ºèƒ½æŒ‡é’ˆ</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">m</span> = Mutex::<span class="title function_ invoke__">new</span>(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// lockè¿”å›çš„æ˜¯Resultç±»å‹</span></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">num</span> = m.<span class="title function_ invoke__">lock</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">        *num = <span class="number">6</span>;</span><br><span class="line">        <span class="comment">// ç¦»å¼€ä½œç”¨åŸŸæ—¶ï¼Œè‡ªåŠ¨é‡Šæ”¾é”</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;m = &#123;&#125;&quot;</span>, m);  <span class="comment">// æ‰“å°ç»“æœä¸ºï¼šm = Mutex &#123; data: 6 &#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ä¸Šé¢çš„ä»£ç ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨<code>Mutex::new(5)</code>åˆ›å»ºäº†ä¸€ä¸ª<code>Mutex</code>æ™ºèƒ½æŒ‡é’ˆï¼Œå¹¶å°†å…¶åˆå§‹å€¼è®¾ç½®ä¸º5ã€‚æ¥ç€ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†<code>m.lock()</code>æ–¹æ³•æ¥ä¸º<code>m</code>ç”³è¯·ä¸€ä¸ª<strong>é”</strong>ï¼Œå¹¶å°†å…¶èµ‹å€¼ç»™<code>num</code>ã€‚è¯¥æ–¹æ³•ä¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼Œç›´åˆ°è·å–åˆ°é”ã€‚å› æ­¤å½“å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®è¯¥æ•°æ®æ—¶ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½è·å–åˆ°é”ï¼Œå…¶å®ƒçº¿ç¨‹åªèƒ½é˜»å¡ç€ç­‰å¾…ï¼Œè¿™æ ·å°±ä¿è¯äº†æ•°æ®èƒ½è¢«å®‰å…¨çš„ä¿®æ”¹ï¼</p>
<p><code>m.lock()</code>æ–¹æ³•ä¹Ÿæœ‰å¯èƒ½è¿”å›ä¸€ä¸ªé”™è¯¯ï¼Œä¾‹å¦‚å½“å‰æ­£åœ¨æŒæœ‰é”çš„çº¿ç¨‹<code>panic</code>äº†ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå…¶å®ƒçº¿ç¨‹ä¸å¯èƒ½å†è·å¾—é”ï¼Œå› æ­¤<code>lock</code>æ–¹æ³•ä¼šè¿”å›ä¸€ä¸ªé”™è¯¯ã€‚</p>
<p>å®é™…ä¸Šï¼Œ<code>lock</code>æ–¹æ³•è¿”å›çš„æ˜¯ä¸€ä¸ª<code>MutexGuard</code>ç±»å‹çš„æ™ºèƒ½æŒ‡é’ˆï¼Œå®ƒå®ç°äº†<code>Deref</code>ç‰¹å¾ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥åƒè§£å¼•ç”¨ä¸€ä¸ªå¸¸è§„çš„æŒ‡é’ˆä¸€æ ·ï¼Œç›´æ¥è®¿é—®<code>Mutex</code>ä¸­çš„æ•°æ®ã€‚åŒæ—¶ï¼Œå®ƒè¿˜å®ç°äº†<code>Drop</code>ç‰¹å¾ï¼Œå½“<code>MutexGuard</code>ç¦»å¼€ä½œç”¨åŸŸæ—¶ï¼Œä¼šè‡ªåŠ¨é‡Šæ”¾é”ï¼Œå› æ­¤ä¸éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨è°ƒç”¨<code>unlock</code>æ–¹æ³•ã€‚</p>
<h3 id="å¤šçº¿ç¨‹ä¸­ä½¿ç”¨-Mutex"><a href="#å¤šçº¿ç¨‹ä¸­ä½¿ç”¨-Mutex" class="headerlink" title="å¤šçº¿ç¨‹ä¸­ä½¿ç”¨ Mutex"></a>å¤šçº¿ç¨‹ä¸­ä½¿ç”¨ Mutex</h3><p>è®©æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹é¢ä¸€ä¸ªä¾‹å­ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::sync::Mutex;</span><br><span class="line"><span class="keyword">use</span> std::thread;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// åˆ›å»ºä¸€ä¸ªMutexæ™ºèƒ½æŒ‡é’ˆ</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">counter</span> = Mutex::<span class="title function_ invoke__">new</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">handles</span> = <span class="built_in">vec!</span>[];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»º10ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹å°†è®¡æ•°å™¨åŠ 1</span></span><br><span class="line">    <span class="keyword">for</span> <span class="variable">_</span> <span class="keyword">in</span> <span class="number">0</span>..<span class="number">10</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">handle</span> = thread::<span class="title function_ invoke__">spawn</span>(<span class="keyword">move</span> || &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">num</span> = counter.<span class="title function_ invoke__">lock</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">            *num += <span class="number">1</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">        handles.<span class="title function_ invoke__">push</span>(handle);</span><br><span class="line">    &#125;   </span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç­‰å¾…æ‰€æœ‰çº¿ç¨‹ç»“æŸ</span></span><br><span class="line">    <span class="keyword">for</span> <span class="variable">handle</span> <span class="keyword">in</span> handles &#123;</span><br><span class="line">        handle.<span class="title function_ invoke__">join</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Result: &#123;&#125;&quot;</span>, *counter.<span class="title function_ invoke__">lock</span>().<span class="title function_ invoke__">unwrap</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ä¸Šé¢çš„çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬è¯•å›¾åˆ›å»ºä¸€ä¸ªè¢«<code>Mutex</code>ä¿æŠ¤çš„è®¡æ•°å™¨ï¼Œå¹¶åˆ›å»ºäº†10ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹å°†è®¡æ•°å™¨åŠ <code>1</code>ã€‚æœ€åï¼Œæ‰“å°å‡ºè®¡æ•°å™¨çš„å€¼ã€‚ä½†å¾ˆé—æ†¾çš„æ˜¯ï¼Œè¿™æ®µä»£ç å¹¶ä¸èƒ½æ­£å¸¸å·¥ä½œã€‚åŸå› åœ¨äº<code>counter</code>å˜é‡å·²ç»è¢«<code>move</code>ç§»åŠ¨åˆ°äº†çº¿ç¨‹ä¸­ï¼Œä¸»çº¿ç¨‹æ— æ³•å†è®¿é—®è¯¥å˜é‡ã€‚</p>
<p>é‚£ä¹ˆï¼Œæˆ‘ä»¬ä¹‹å‰å­¦è¿‡<code>Rc&lt;T&gt;</code>æ™ºèƒ½æŒ‡é’ˆï¼Œå®ƒå…è®¸æˆ‘ä»¬åœ¨å¤šä¸ªåœ°æ–¹å…±äº«æ‰€æœ‰æƒã€‚é‚£ä¹ˆï¼Œæˆ‘ä»¬æ˜¯å¦å¯ä»¥ç”¨<code>Rc&lt;Mutex&lt;T&gt;&gt;</code>æ¥è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿ</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::rc::Rc;</span><br><span class="line"><span class="keyword">use</span> std::sync::Mutex;</span><br><span class="line"><span class="keyword">use</span> std::thread;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// é€šè¿‡`Rc`å®ç°`Mutex`çš„å¤šæ‰€æœ‰æƒ</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">counter</span> = Rc::<span class="title function_ invoke__">new</span>(Mutex::<span class="title function_ invoke__">new</span>(<span class="number">0</span>));</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">handles</span> = <span class="built_in">vec!</span>[];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> <span class="variable">_</span> <span class="keyword">in</span> <span class="number">0</span>..<span class="number">10</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">counter</span> = Rc::<span class="title function_ invoke__">clone</span>(&amp;counter);</span><br><span class="line">        <span class="comment">// åˆ›å»ºå­çº¿ç¨‹ï¼Œå¹¶å°†`Mutex`çš„æ‰€æœ‰æƒæ‹·è´ä¼ å…¥åˆ°å­çº¿ç¨‹ä¸­</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">handle</span> = thread::<span class="title function_ invoke__">spawn</span>(<span class="keyword">move</span> || &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">num</span> = counter.<span class="title function_ invoke__">lock</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line"></span><br><span class="line">            *num += <span class="number">1</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">        handles.<span class="title function_ invoke__">push</span>(handle);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç­‰å¾…æ‰€æœ‰å­çº¿ç¨‹å®Œæˆ</span></span><br><span class="line">    <span class="keyword">for</span> <span class="variable">handle</span> <span class="keyword">in</span> handles &#123;</span><br><span class="line">        handle.<span class="title function_ invoke__">join</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¾“å‡ºæœ€ç»ˆçš„è®¡æ•°ç»“æœ</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Result: &#123;&#125;&quot;</span>, *counter.<span class="title function_ invoke__">lock</span>().<span class="title function_ invoke__">unwrap</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œï¼Œç”±äºå­çº¿ç¨‹éœ€è¦é€šè¿‡<code>move</code>æ‹¿èµ°é”çš„æ‰€æœ‰æƒï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ä½¿ç”¨å¤šæ‰€æœ‰æƒæ¥ä¿è¯æ¯ä¸ªçº¿ç¨‹éƒ½æ‹¿åˆ°æ•°æ®çš„ç‹¬ç«‹æ‰€æœ‰æƒï¼Œä»è€Œé¿å…ä¸»çº¿ç¨‹æ— æ³•è®¿é—®<code>counter</code>å˜é‡ã€‚ä½†æ˜¯ï¼Œé—æ†¾åˆæ¥äº†ï¼Œå½“æˆ‘ä»¬è¿è¡Œè¯¥ç¨‹åºæ—¶ï¼Œä¼šæŠ¥é”™ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">error[E0277]: `Rc&lt;Mutex&lt;i32&gt;&gt;` cannot be sent between threads safely</span><br><span class="line">                // `Rc`æ— æ³•åœ¨çº¿ç¨‹ä¸­å®‰å…¨çš„ä¼ è¾“</span><br><span class="line">   --&gt; src/main.rs:11:22</span><br><span class="line">    |</span><br><span class="line">13  |           let handle = thread::spawn(move || &#123;</span><br><span class="line">    |  ______________________^^^^^^^^^^^^^_-</span><br><span class="line">    | |                      |</span><br><span class="line">    | |                      `Rc&lt;Mutex&lt;i32&gt;&gt;` cannot be sent between threads safely</span><br><span class="line">14  | |             let mut num = counter.lock().unwrap();</span><br><span class="line">15  | |</span><br><span class="line">16  | |             *num += 1;</span><br><span class="line">17  | |         &#125;);</span><br><span class="line">    | |_________- within this `[closure@src/main.rs:11:36: 15:10]`</span><br><span class="line">    |</span><br><span class="line">    = help: within `[closure@src/main.rs:11:36: 15:10]`, the trait `Send` is not implemented for `Rc&lt;Mutex&lt;i32&gt;&gt;`</span><br><span class="line">     // `Rc`æ²¡æœ‰å®ç°`Send`ç‰¹å¾</span><br><span class="line">    = note: required because it appears within the type `[closure@src/main.rs:11:36: 15:10]`</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢çš„é”™è¯¯ä¿¡æ¯å‘Šè¯‰æˆ‘ä»¬ï¼Œ<code>Rc</code>æ²¡æœ‰å®ç°<code>Send</code>ç‰¹å¾ï¼Œå› æ­¤æ— æ³•åœ¨çº¿ç¨‹é—´å®‰å…¨çš„ä¼ è¾“ã€‚è¿™å¬èµ·æ¥æœ‰ç‚¹éš¾ç†è§£ï¼Œ<code>Rc</code>ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„å—ï¼Ÿå•çº¿ç¨‹ä¸­ï¼Œ<code>Rc</code>ç¡®å®å¯ä»¥å®‰å…¨çš„è¿›è¡Œä½¿ç”¨ï¼Œä½†æ˜¯å½“<code>Rc</code>è¢«ç”¨åœ¨å¤šçº¿ç¨‹ä¸­æ—¶ï¼Œå°±ä¼šå˜å¾—ä¸å®‰å…¨ã€‚åŸå› åœ¨äº<code>Rc</code>æœ¬èº«æ˜¯ä¸å¯å˜çš„ï¼Œå®ƒæ— æ³•è‡ªåŠ¨æ›´æ–°å¼•ç”¨è®¡æ•°ï¼Œå› æ­¤å½“å¤šä¸ªçº¿ç¨‹åŒæ—¶ä¿®æ”¹å¼•ç”¨è®¡æ•°æ—¶ï¼Œå°±ä¼šå¯¼è‡´æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ã€‚æƒ³è±¡ä¸€ä¸‹ï¼Œå¦‚æœä¸€ä¸ªçº¿ç¨‹æ­£åœ¨ä¿®æ”¹å¼•ç”¨è®¡æ•°ï¼Œè€Œå¦ä¸€ä¸ªçº¿ç¨‹æ­£åœ¨è¯»å–å¼•ç”¨è®¡æ•°ï¼Œé‚£ä¹ˆå°±ä¼šå¯¼è‡´æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ã€‚</p>
<h4 id="å¤šçº¿ç¨‹å®‰å…¨çš„Arc"><a href="#å¤šçº¿ç¨‹å®‰å…¨çš„Arc" class="headerlink" title="å¤šçº¿ç¨‹å®‰å…¨çš„Arc&lt;T&gt;"></a>å¤šçº¿ç¨‹å®‰å…¨çš„<code>Arc&lt;T&gt;</code></h4><p><code>Arc&lt;T&gt;</code>æ˜¯<code>Rc&lt;T&gt;</code>çš„å¤šçº¿ç¨‹ç‰ˆæœ¬ï¼Œå®ƒé€šè¿‡<code>Atomic</code>åŸå­æ“ä½œå®ç°äº†çº¿ç¨‹å®‰å…¨çš„å¼•ç”¨è®¡æ•°ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>Arc&lt;Mutex&lt;T&gt;&gt;</code>æ¥æ›¿ä»£<code>Rc&lt;Mutex&lt;T&gt;&gt;</code>ï¼Œä»è€Œè§£å†³å¤šçº¿ç¨‹ä¸­<code>Mutex</code>çš„é—®é¢˜ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œ<code>Arc</code>ä¸<code>Rc</code>çš„APIåŸºæœ¬ä¸€è‡´ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ç›´æ¥å°†<code>Rc</code>æ›¿æ¢ä¸º<code>Arc</code>ã€‚</p>
<p>é‚£ä¹ˆå°±å¼•å‡ºäº†ä¸€ä¸ªé—®é¢˜ï¼Œä¸ºä»€ä¹ˆæ‰€æœ‰çš„åŸºç¡€ç±»å‹éƒ½ä¸æ˜¯åŸå­çš„ï¼Œä¸ºä»€ä¹ˆæ ‡å‡†åº“ç±»å‹ä¸é»˜è®¤ä½¿ç”¨<code>Arc</code>å‘¢ï¼ŸåŸå› åœ¨äºå®ç°åŸå­æ€§éœ€è¦é¢å¤–çš„æ€§èƒ½å¼€é”€ã€‚</p>
<p>æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬ä½¿ç”¨<code>Arc&lt;T&gt;</code>æ¥å®ç°å¤šçº¿ç¨‹ä¸­<code>Mutex</code>çš„è®¿é—®ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::sync::&#123;Arc, Mutex&#125;;</span><br><span class="line"><span class="keyword">use</span> std::thread;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">counter</span> = Arc::<span class="title function_ invoke__">new</span>(Mutex::<span class="title function_ invoke__">new</span>(<span class="number">0</span>));</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">handles</span> = <span class="built_in">vec!</span>[];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> <span class="variable">_</span> <span class="keyword">in</span> <span class="number">0</span>..<span class="number">10</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">counter</span> = Arc::<span class="title function_ invoke__">clone</span>(&amp;counter);</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">handle</span> = thread::<span class="title function_ invoke__">spawn</span>(<span class="keyword">move</span> || &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">num</span> = counter.<span class="title function_ invoke__">lock</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line"></span><br><span class="line">            *num += <span class="number">1</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">        handles.<span class="title function_ invoke__">push</span>(handle);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> <span class="variable">handle</span> <span class="keyword">in</span> handles &#123;</span><br><span class="line">        handle.<span class="title function_ invoke__">join</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Result: &#123;&#125;&quot;</span>, *counter.<span class="title function_ invoke__">lock</span>().<span class="title function_ invoke__">unwrap</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»¥ä¸Šä»£ç å¯ä»¥é¡ºåˆ©è¿è¡Œï¼Œæ‰“å°ç»“æœä¸ºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Result: 10</span><br></pre></td></tr></table></figure>

<h3 id="Rc-RefCell-Versus-Arc-Mutex"><a href="#Rc-RefCell-Versus-Arc-Mutex" class="headerlink" title="Rc&lt;T&gt;&#x2F;RefCell&lt;T&gt; Versus Arc&lt;T&gt;&#x2F;Mutex&lt;T&gt;"></a><code>Rc&lt;T&gt;</code>&#x2F;<code>RefCell&lt;T&gt;</code> Versus <code>Arc&lt;T&gt;</code>&#x2F;<code>Mutex&lt;T&gt;</code></h3><ul>
<li><code>Mutex&lt;T&gt;</code>ä¹Ÿæä¾›äº†å†…éƒ¨å¯å˜æ€§ï¼Œå’Œ<code>RefCell&lt;T&gt;</code>ç±»ä¼¼ï¼Œä½†æ˜¯<code>Mutex&lt;T&gt;</code>éœ€è¦åœ¨è®¿é—®æ•°æ®ä¹‹å‰å…ˆè·å–é”ï¼Œå› æ­¤æ€§èƒ½ä¸Šä¸å¦‚<code>RefCell&lt;T&gt;</code>ã€‚</li>
<li>æˆ‘ä»¬ä½¿ç”¨<code>RefCell&lt;T&gt;</code>æ¥æ”¹å˜<code>Rc&lt;T&gt;</code>é‡Œé¢çš„å†…å®¹ã€‚</li>
<li>æˆ‘ä»¬ä½¿ç”¨<code>Mutex&lt;T&gt;</code>æ¥æ”¹å˜<code>Arc&lt;T&gt;</code>é‡Œé¢çš„å†…å®¹ã€‚</li>
<li><code>Mutex&lt;T&gt;</code>æœ‰æ­»é”çš„é£é™©ã€‚</li>
</ul>
<h2 id="Sendå’ŒSyncç‰¹å¾"><a href="#Sendå’ŒSyncç‰¹å¾" class="headerlink" title="Sendå’ŒSyncç‰¹å¾"></a><code>Send</code>å’Œ<code>Sync</code>ç‰¹å¾</h2><ul>
<li><code>Send</code>ç‰¹å¾ï¼šå…è®¸åœ¨çº¿ç¨‹é—´å®‰å…¨çš„ä¼ è¾“æ•°æ®</li>
<li><code>Sync</code>ç‰¹å¾ï¼šå…è®¸åœ¨çº¿ç¨‹é—´å®‰å…¨çš„å…±äº«æ•°æ®</li>
</ul>
<p>Rustè¯­è¨€ä¸­ï¼Œæ‰€æœ‰åŸºæœ¬ç±»å‹éƒ½å®ç°äº†<code>Send</code>å’Œ<code>Sync</code>ç‰¹å¾ï¼Œå› æ­¤å®ƒä»¬åœ¨çº¿ç¨‹é—´å¯ä»¥å®‰å…¨çš„ä¼ è¾“å’Œå…±äº«ã€‚ä½†æ˜¯ï¼Œè¿™å¹¶ä¸æ˜¯Rustè¯­è¨€æœ¬èº«çš„ç‰¹æ€§ï¼Œè€Œæ˜¯æ¥è‡ªæ ‡å‡†åº“ã€‚ </p>
<h3 id="Sendï¼šå…è®¸åœ¨çº¿ç¨‹é—´å®‰å…¨çš„è½¬ç§»æ‰€æœ‰æƒ"><a href="#Sendï¼šå…è®¸åœ¨çº¿ç¨‹é—´å®‰å…¨çš„è½¬ç§»æ‰€æœ‰æƒ" class="headerlink" title="Sendï¼šå…è®¸åœ¨çº¿ç¨‹é—´å®‰å…¨çš„è½¬ç§»æ‰€æœ‰æƒ"></a>Sendï¼šå…è®¸åœ¨çº¿ç¨‹é—´å®‰å…¨çš„è½¬ç§»æ‰€æœ‰æƒ</h3><p><code>Send</code>ç‰¹å¾å…è®¸åœ¨çº¿ç¨‹é—´å®‰å…¨çš„è½¬ç§»æ‰€æœ‰æƒã€‚å¦‚æœä¸€ä¸ªç±»å‹å®ç°äº†<code>Send</code>ç‰¹å¾ï¼Œé‚£ä¹ˆå®ƒå°±å¯ä»¥è¢«å®‰å…¨çš„ç§»åŠ¨åˆ°å¦ä¸€ä¸ªçº¿ç¨‹ä¸­ã€‚Rustä¸­å‡ ä¹æ‰€æœ‰çš„ç±»å‹éƒ½å®ç°äº†<code>Send</code>ç‰¹å¾ï¼Œé™¤äº†<code>Rc&lt;T&gt;</code>ã€‚</p>
<p>ä»»ä½•å®Œå…¨ç”±<code>Send</code>ç±»å‹ç»„æˆçš„ç±»å‹ä¹Ÿæ˜¯<code>Send</code>ç±»å‹ã€‚<br>é™¤äº†åŸå§‹æŒ‡é’ˆï¼ˆ<code>*T</code>ï¼‰ä¹‹å¤–ï¼Œæ‰€æœ‰æŒ‡é’ˆéƒ½å®ç°äº†<code>Send</code>ç‰¹å¾ã€‚</p>
<h3 id="Syncï¼šå…è®¸åœ¨çº¿ç¨‹é—´å®‰å…¨çš„å…±äº«æ•°æ®"><a href="#Syncï¼šå…è®¸åœ¨çº¿ç¨‹é—´å®‰å…¨çš„å…±äº«æ•°æ®" class="headerlink" title="Syncï¼šå…è®¸åœ¨çº¿ç¨‹é—´å®‰å…¨çš„å…±äº«æ•°æ®"></a>Syncï¼šå…è®¸åœ¨çº¿ç¨‹é—´å®‰å…¨çš„å…±äº«æ•°æ®</h3><p><code>Sync</code>ç‰¹å¾å…è®¸åœ¨çº¿ç¨‹é—´å®‰å…¨çš„å…±äº«æ•°æ®ï¼Œä¹Ÿå³å¤šçº¿ç¨‹è®¿é—®ã€‚å¦‚æœä¸€ä¸ªç±»å‹å®ç°äº†<code>Sync</code>ç‰¹å¾ï¼Œé‚£ä¹ˆå®ƒå°±å¯ä»¥å®‰å…¨çš„è¢«å¤šä¸ªçº¿ç¨‹å¼•ç”¨ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼š</p>
<ul>
<li>å¦‚æœ<code>T</code>å®ç°äº†<code>Sync</code>ï¼Œé‚£ä¹ˆ<code>&amp;T</code>å°±æ˜¯<code>Send</code>ã€‚</li>
<li>æ‰€æœ‰<code>Send</code>ç±»å‹éƒ½å®ç°äº†<code>Sync</code>ã€‚</li>
<li>åŸºç¡€ç±»å‹éƒ½å®ç°äº†<code>Sync</code>ï¼Œå› æ­¤ä»»ä½•å®Œå…¨ç”±<code>Sync</code>ç±»å‹ç»„æˆçš„ç±»å‹ä¹Ÿå®ç°äº†<code>Sync</code>ã€‚</li>
<li><code>Rc&lt;T&gt;</code>æ²¡æœ‰å®ç°<code>Sync</code>ï¼Œ<code>RefCell&lt;T&gt;</code>å’Œ<code>Cell&lt;T&gt;</code>ä¹Ÿæ²¡æœ‰å®ç°<code>Sync</code>ã€‚</li>
<li>è€Œ<code>Mutex&lt;T&gt;</code>å’Œ<code>Arc&lt;T&gt;</code>éƒ½å®ç°äº†<code>Sync</code>ã€‚</li>
</ul>
<h2 id="è¯¾åä½œä¸š"><a href="#è¯¾åä½œä¸š" class="headerlink" title="è¯¾åä½œä¸š"></a>è¯¾åä½œä¸š</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä»»åŠ¡æè¿°</span></span><br><span class="line"><span class="comment">// ä½ éœ€è¦ç¼©å†™ä¸€ä¸ªç®€å•çš„å¤šçº¿ç¨‹ä»»åŠ¡è°ƒåº¦å™¨ï¼Œå®ƒèƒ½å¤Ÿæ¥æ”¶å¤šä¸ªä»»åŠ¡ï¼Œå¹¶å°†è¿™äº›ä»»åŠ¡åˆ†å‘åˆ°å¤šä¸ªå·¥ä½œçº¿ç¨‹ä¸­æ‰§è¡Œã€‚è°ƒåº¦å™¨ä½¿ç”¨ Channel è¿›è¡Œä»»åŠ¡çš„åˆ†å‘å’Œç»“æœçš„æ”¶é›†ã€‚ä½ éœ€è¦ä½¿ç”¨ Rust çš„ Send å’Œ Sync ç‰¹æ€§æ¥ç¡®ä¿ä»»åŠ¡è°ƒåº¦å™¨åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­çš„å®‰å…¨æ€§ã€‚</span></span><br><span class="line"><span class="comment">// å…·ä½“è¦æ±‚</span></span><br><span class="line"><span class="comment">// ä»»åŠ¡ç»“æ„ï¼š</span></span><br><span class="line"><span class="comment">// å®šä¹‰ä¸€ä¸ª Task ç»“æ„ä½“ï¼Œè¡¨ç¤ºéœ€è¦æ‰§è¡Œçš„ä»»åŠ¡ã€‚ä»»åŠ¡åŒ…å«ä¸€ä¸ªå”¯ä¸€çš„ id å’Œä¸€ä¸ªç”¨äºæ‰§è¡Œçš„é—­åŒ…ã€‚</span></span><br><span class="line"><span class="comment">// è°ƒåº¦å™¨ç»“æ„ï¼š</span></span><br><span class="line"><span class="comment">// åˆ›å»ºä¸€ä¸ª Scheduler ç»“æ„ä½“ï¼ŒåŒ…å«ä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—å’Œä¸€ä¸ªçº¿ç¨‹æ± ã€‚è°ƒåº¦å™¨åº”å½“ä½¿ç”¨ channel æ¥åˆ†å‘ä»»åŠ¡åˆ°ä¸åŒçš„å·¥ä½œçº¿ç¨‹ã€‚</span></span><br><span class="line"><span class="comment">// åŠŸèƒ½å®ç°ï¼š</span></span><br><span class="line"><span class="comment">// è°ƒåº¦å™¨åº”å½“å…·æœ‰ä»¥ä¸‹åŠŸèƒ½:</span></span><br><span class="line"><span class="comment">// æ·»åŠ ä»»åŠ¡ï¼šå‘è°ƒåº¦å™¨æ·»åŠ ä¸€ä¸ªä»»åŠ¡ã€‚</span></span><br><span class="line"><span class="comment">// å¯åŠ¨è°ƒåº¦å™¨ï¼šå¯åŠ¨å¤šä¸ªçº¿ç¨‹ï¼Œå¼€å§‹ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­è·å–ä»»åŠ¡å¹¶æ‰§è¡Œã€‚</span></span><br><span class="line"><span class="comment">// è·å–ç»“æœï¼šåœ¨æ‰€æœ‰ä»»åŠ¡å®Œæˆåï¼Œæ”¶é›†å¹¶æ‰“å°æ¯ä¸ªä»»åŠ¡çš„æ‰§è¡Œç»“æœã€‚</span></span><br><span class="line"><span class="comment">// å¤šçº¿ç¨‹å®‰å…¨ï¼š</span></span><br><span class="line"><span class="comment">// é€šè¿‡ä½¿ç”¨ Arc å’Œ Mutex ç¡®ä¿ä»»åŠ¡é˜Ÿåˆ—åœ¨å¤šä¸ªçº¿ç¨‹ä¹‹é—´çš„å®‰å…¨è®¿é—®ã€‚</span></span><br><span class="line"><span class="comment">// ç¡®ä¿ä»»åŠ¡çš„ç»“æœèƒ½å¤Ÿæ­£ç¡®åœ°åœ¨çº¿ç¨‹ä¹‹é—´ä¼ é€’å’Œæ”¶é›†ã€‚</span></span><br><span class="line"><span class="comment">// é—®é¢˜æç¤ºï¼š</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ä»»åŠ¡é˜Ÿåˆ—ï¼š</span></span><br><span class="line"><span class="comment">// ä½¿ç”¨ Mutex æ¥ä¿æŠ¤ä»»åŠ¡é˜Ÿåˆ—ï¼Œç¡®ä¿å¤šä¸ªçº¿ç¨‹ä¸ä¼šåŒæ—¶ä¿®æ”¹é˜Ÿåˆ—ä¸­çš„æ•°æ®ã€‚</span></span><br><span class="line"><span class="comment">// ä½¿ç”¨ Arc æ¥å…±äº«ä»»åŠ¡é˜Ÿåˆ—çš„æ‰€æœ‰æƒï¼Œä½¿å¾—å¤šä¸ªçº¿ç¨‹èƒ½å¤Ÿè®¿é—®åŒä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—ã€‚</span></span><br><span class="line"><span class="comment">// ä»»åŠ¡åˆ†å‘ï¼š</span></span><br><span class="line"><span class="comment">// ä½¿ç”¨ channel æ¥å°†ä»»åŠ¡çš„å®ŒæˆçŠ¶æ€å‘é€å›ä¸»çº¿ç¨‹ï¼Œä»è€Œå¯ä»¥åœ¨ä¸»çº¿ç¨‹ä¸­æ”¶é›†å’Œæ‰“å°ä»»åŠ¡å®Œæˆçš„ç»“æœã€‚</span></span><br><span class="line"><span class="comment">// çº¿ç¨‹æ± ï¼š</span></span><br><span class="line"><span class="comment">// é€šè¿‡å¾ªç¯åˆ›å»ºå¤šä¸ªå·¥ä½œçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­å–å‡ºä»»åŠ¡å¹¶æ‰§è¡Œã€‚çº¿ç¨‹æ± çš„å¤§å°å¯ä»¥é€šè¿‡ Scheduler çš„æ„é€ å‡½æ•°æ¥æŒ‡å®š</span></span><br><span class="line"><span class="comment">// ä»»åŠ¡æ‰§è¡Œï¼š</span></span><br><span class="line"><span class="comment">// æ¯ä¸ªä»»åŠ¡éƒ½åº”è¯¥æ˜¯ä¸€ä¸ªé—­åŒ…ï¼Œä½¿ç”¨ Box&lt;dyn FnOnce()&gt;å°†å…¶å­˜å‚¨åœ¨ Task ç»“æ„ä½“ä¸­ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> std::collections::VecDeque;</span><br><span class="line"><span class="keyword">use</span> std::sync::&#123;mpsc, Arc, Mutex&#125;;</span><br><span class="line"><span class="keyword">use</span> std::thread;</span><br><span class="line"><span class="keyword">use</span> std::time::Duration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Task</span> &#123;</span><br><span class="line">    task_id: <span class="type">usize</span>,</span><br><span class="line">    job: <span class="type">Box</span>&lt;<span class="keyword">dyn</span> <span class="title function_ invoke__">FnOnce</span>() + <span class="built_in">Send</span> + <span class="symbol">&#x27;static</span>&gt;,    <span class="comment">// ä»»åŠ¡é—­åŒ…</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Task</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">new</span>&lt;F&gt;(task_id: <span class="type">usize</span>, job: F) <span class="punctuation">-&gt;</span> Task </span><br><span class="line">    <span class="keyword">where</span> F: <span class="title function_ invoke__">FnOnce</span>() + <span class="built_in">Send</span> + <span class="symbol">&#x27;static</span>,</span><br><span class="line">    &#123;</span><br><span class="line">        Task &#123;</span><br><span class="line">            task_id,</span><br><span class="line">            job: <span class="type">Box</span>::<span class="title function_ invoke__">new</span>(job),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Scheduler</span> &#123;</span><br><span class="line">    tasks: Arc&lt;Mutex&lt;VecDeque&lt;Task&gt;&gt;&gt;,    <span class="comment">// ä»»åŠ¡é˜Ÿåˆ—ï¼ŒVecDequeæ˜¯åŒç«¯é˜Ÿåˆ—</span></span><br><span class="line">    num_workers: <span class="type">usize</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Scheduler</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">new</span>(num_workers: <span class="type">usize</span>) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        Scheduler &#123;</span><br><span class="line">            tasks: Arc::<span class="title function_ invoke__">new</span>(Mutex::<span class="title function_ invoke__">new</span>(VecDeque::<span class="title function_ invoke__">new</span>())),</span><br><span class="line">            num_workers,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">add_task</span>&lt;F&gt;(&amp;<span class="keyword">self</span>, task_id: <span class="type">usize</span>, job: F)</span><br><span class="line">    <span class="keyword">where</span> F: <span class="title function_ invoke__">FnOnce</span>() + <span class="built_in">Send</span> + <span class="symbol">&#x27;static</span>,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">tasks</span> = <span class="keyword">self</span>.tasks.<span class="title function_ invoke__">lock</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">        tasks.<span class="title function_ invoke__">push_back</span>(Task::<span class="title function_ invoke__">new</span>(task_id, job));   <span class="comment">// å°†ä»»åŠ¡æ·»åŠ åˆ°ä»»åŠ¡é˜Ÿåˆ—çš„æœ«å°¾</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">activate</span>(&amp;<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> (tx, rx) = mpsc::<span class="title function_ invoke__">channel</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> <span class="variable">worker_id</span> <span class="keyword">in</span> <span class="number">1</span>..=<span class="keyword">self</span>.num_workers &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">tasks</span> = Arc::<span class="title function_ invoke__">clone</span>(&amp;<span class="keyword">self</span>.tasks);</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">tx</span> = tx.<span class="title function_ invoke__">clone</span>();</span><br><span class="line"></span><br><span class="line">            thread::<span class="title function_ invoke__">spawn</span>(<span class="keyword">move</span> || <span class="keyword">loop</span> &#123;</span><br><span class="line">                <span class="keyword">let</span> <span class="variable">task_opt</span> = &#123;</span><br><span class="line">                    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">tasks</span> = tasks.<span class="title function_ invoke__">lock</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">                    tasks.<span class="title function_ invoke__">pop_front</span>()</span><br><span class="line">                &#125;;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Some</span>(task) = task_opt &#123;</span><br><span class="line">                    <span class="built_in">println!</span>(<span class="string">&quot;Worker &#123;&#125; is executing task &#123;&#125;&quot;</span>, worker_id, task.task_id);</span><br><span class="line">                    (task.job)();</span><br><span class="line">                    tx.<span class="title function_ invoke__">send</span>(task.task_id).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                thread::<span class="title function_ invoke__">sleep</span>(Duration::<span class="title function_ invoke__">from_secs</span>(<span class="number">1</span>));</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="title function_ invoke__">drop</span>(tx);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">let</span> <span class="variable">Ok</span>(task_id) = rx.<span class="title function_ invoke__">recv</span>() &#123;</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;Task &#123;&#125; completed&quot;</span>, task_id);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;All tasks are completed.&quot;</span>);</span><br><span class="line">    &#125;    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// åˆ›å»ºè°ƒåº¦å™¨ï¼ŒæŒ‡å®šçº¿ç¨‹æ± å¤§å°ä¸º 4</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">scheduler</span> = Scheduler::<span class="title function_ invoke__">new</span>(<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ·»åŠ ä»»åŠ¡åˆ°è°ƒåº¦å™¨</span></span><br><span class="line">    <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">0</span>..<span class="number">10</span> &#123;</span><br><span class="line">        scheduler.<span class="title function_ invoke__">add_task</span>(i, <span class="keyword">move</span> || &#123;</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;Executing task &#123;&#125;&quot;</span>, i);</span><br><span class="line">            thread::<span class="title function_ invoke__">sleep</span>(Duration::<span class="title function_ invoke__">from_secs</span>(<span class="number">2</span>)); <span class="comment">// æ¨¡æ‹Ÿä»»åŠ¡è€—æ—¶</span></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¯åŠ¨è°ƒåº¦å™¨ï¼Œå¼€å§‹æ‰§è¡Œä»»åŠ¡</span></span><br><span class="line">    scheduler.<span class="title function_ invoke__">activate</span>();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;All tasks have been processed.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/11/02/rust-concurrency/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Wobujiaoxyy3">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/11/02/rust-concurrency/" class="post-title-link" itemprop="url">äºŒåäº”ã€Rustè¿›é˜¶-å¹¶å‘</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-11-02 09:03:11" itemprop="dateCreated datePublished" datetime="2024-11-02T09:03:11+08:00">2024-11-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-11-14 07:43:02" itemprop="dateModified" datetime="2024-11-14T07:43:02+08:00">2024-11-14</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="å¹¶å‘-Concurrency"><a href="#å¹¶å‘-Concurrency" class="headerlink" title="å¹¶å‘ Concurrency"></a>å¹¶å‘ Concurrency</h1><p>å®‰å…¨å’Œé«˜æ•ˆçš„å¤„ç†å¹¶å‘æ˜¯Rustè¯­è¨€çš„ä¸»è¦ç›®æ ‡ä¹‹ä¸€ã€‚éšç€ç°ä»£å¤„ç†å™¨çš„æ ¸å¿ƒæ•°ä¸æ–­å¢åŠ ï¼Œå¹¶å‘å’Œå¹¶è¡Œå·²ç»æˆä¸ºæ—¥å¸¸ç¼–ç¨‹ä¸å¯æˆ–ç¼ºçš„ä¸€éƒ¨åˆ†ï¼Œç”šè‡³äºGoè¯­è¨€å·²ç»å°†å¹¶å‘ç®€åŒ–åˆ°ä¸€ä¸ª<code>go</code>å…³é”®å­—å°±å¯ä»¥ã€‚</p>
<p>å¯æƒœçš„æ˜¯ï¼Œåœ¨Rustä¸­ç”±äºè¯­è¨€è®¾è®¡ç†å¿µã€å®‰å…¨ã€æ€§èƒ½çš„å¤šæ–¹é¢è€ƒè™‘ï¼Œå¹¶æ²¡æœ‰é‡‡ç”¨Goè¯­è¨€å¤§é“è‡³ç®€çš„æ–¹å¼ï¼Œè€Œæ˜¯é€‰æ‹©äº†å¤šçº¿ç¨‹ä¸<code>async/await</code>ç›¸ç»“åˆï¼Œä¼˜ç‚¹æ˜¯å¯æ§æ€§æ›´å¼ºã€æ€§èƒ½æ›´é«˜ï¼Œç¼ºç‚¹æ˜¯å¤æ‚åº¦å¹¶ä¸ä½ï¼Œå½“ç„¶è¿™ä¹Ÿæ˜¯ç³»ç»Ÿçº§è¯­è¨€çš„åº”æœ‰é€‰æ‹©ï¼šä½¿ç”¨å¤æ‚åº¦æ¢å–å¯æ§æ€§å’Œæ€§èƒ½ã€‚</p>
<h2 id="å¹¶å‘ä¸å¹¶è¡Œ"><a href="#å¹¶å‘ä¸å¹¶è¡Œ" class="headerlink" title="å¹¶å‘ä¸å¹¶è¡Œ"></a>å¹¶å‘ä¸å¹¶è¡Œ</h2><p>å¹¶å‘ï¼ˆConcurrencyï¼‰å’Œå¹¶è¡Œï¼ˆParallelismï¼‰æ˜¯ä¸¤ä¸ªéå¸¸ç›¸ä¼¼çš„æ¦‚å¿µï¼Œè™½ç„¶æˆ‘ä»¬å¹³æ—¶ç»Ÿç§°å¹¶å‘ä¸å¹¶è¡Œä¸ºå¹¶å‘ï¼Œä½†å®ƒä»¬ä¹‹é—´å­˜åœ¨ä¸€äº›ç»†å¾®çš„å·®åˆ«ã€‚</p>
<p>å¹¶å‘æ˜¯æŒ‡ç³»ç»Ÿèƒ½å¤ŸåŒæ—¶å¤„ç†å¤šä¸ªä»»åŠ¡çš„èƒ½åŠ›ï¼Œè¿™äº›ä»»åŠ¡å¯èƒ½å¤„äºä¸åŒçš„çŠ¶æ€ï¼Œä½†å®ƒä»¬å…±äº«åŒä¸€ä¸ªå¤„ç†å™¨ã€‚å¹¶å‘é€šå¸¸æ¶‰åŠä»»åŠ¡çš„åˆ‡æ¢å’Œè°ƒåº¦ï¼Œä½¿å¾—å¤šä¸ªä»»åŠ¡è™½ç„¶åœ¨æ—¶é—´ä¸Šäº¤æ›¿æ‰§è¡Œï¼Œä½†æ˜¯çœ‹èµ·æ¥å°±åƒæ˜¯åŒæ—¶è¿è¡Œçš„ã€‚</p>
<p>å¹¶è¡Œåˆ™æ˜¯æŒ‡ç³»ç»Ÿèƒ½å¤ŸåŒæ—¶æ‰§è¡Œå¤šä¸ªä»»åŠ¡çš„èƒ½åŠ›ï¼Œè¿™äº›ä»»åŠ¡åœ¨ä¸åŒçš„å¤„ç†å™¨ä¸Šè¿è¡Œï¼Œæ¯ä¸ªä»»åŠ¡éƒ½å ç”¨ä¸€ä¸ªç‹¬ç«‹çš„å¤„ç†å™¨ã€‚å¹¶è¡Œé€šå¸¸æ¶‰åŠä»»åŠ¡çš„åˆ†é…å’Œæ‰§è¡Œï¼Œä½¿å¾—å¤šä¸ªä»»åŠ¡çœ‹èµ·æ¥æ˜¯åŒæ—¶è¿è¡Œçš„ã€‚</p>
<h2 id="è¿›ç¨‹ä¸çº¿ç¨‹"><a href="#è¿›ç¨‹ä¸çº¿ç¨‹" class="headerlink" title="è¿›ç¨‹ä¸çº¿ç¨‹"></a>è¿›ç¨‹ä¸çº¿ç¨‹</h2><p>åœ¨å¤§å¤šæ•°çš„æ“ä½œç³»ç»ŸOSä¸­ï¼Œä»£ç è¿è¡Œåœ¨è¿›ç¨‹ï¼ˆprocessï¼‰ä¸­ï¼ŒOSåŒæ—¶ç®¡ç†é‡Œé¢çš„å¤šä¸ªè¿›ç¨‹ã€‚</p>
<p>åœ¨æˆ‘ä»¬çš„ç¨‹åºä¸­ï¼Œå„ç‹¬ç«‹éƒ¨åˆ†å¯ä»¥åŒæ—¶è¿è¡Œï¼Œè¿è¡Œè¿™äº›ç‹¬ç«‹éƒ¨åˆ†çš„å°±æ˜¯çº¿ç¨‹ï¼ˆthreadï¼‰ã€‚</p>
<h3 id="å¤šçº¿ç¨‹è¿è¡Œ"><a href="#å¤šçº¿ç¨‹è¿è¡Œ" class="headerlink" title="å¤šçº¿ç¨‹è¿è¡Œ"></a>å¤šçº¿ç¨‹è¿è¡Œ</h3><p>å¤šçº¿ç¨‹è¿è¡Œå¯ä»¥æå‡ç¨‹åºçš„æ€§èƒ½è¡¨ç°ï¼Œä½†æ˜¯ä¹Ÿä¼šå¢åŠ å¤æ‚åº¦ï¼Œæ— æ³•ä¿éšœå„çº¿ç¨‹çš„æ‰§è¡Œé¡ºåºï¼ŒåŒæ—¶å¸¦æ¥å®‰å…¨é—®é¢˜ï¼š</p>
<ul>
<li>ç«æ€æ¡ä»¶ï¼ˆRace Conditionï¼‰ï¼šå¤šä¸ªçº¿ç¨‹ä»¥éä¸€è‡´æ€§çš„é¡ºåºåŒæ—¶è®¿é—®æ•°æ®èµ„æºï¼Œå¯¼è‡´æ•°æ®ä¸ä¸€è‡´ã€‚</li>
<li>æ­»é”ï¼ˆDeadlockï¼‰ï¼šå¤šä¸ªçº¿ç¨‹ç›¸äº’ç­‰å¾…å¯¹æ–¹é‡Šæ”¾èµ„æºï¼Œå¯¼è‡´æ‰€æœ‰çº¿ç¨‹éƒ½æ— æ³•ç»§ç»­æ‰§è¡Œã€‚</li>
<li>æ´»é”ï¼ˆLivelockï¼‰ï¼šå¤šä¸ªçº¿ç¨‹ä¸æ–­å°è¯•è§£å†³å†²çªï¼Œä½†å§‹ç»ˆæ— æ³•æˆåŠŸï¼Œå¯¼è‡´æ‰€æœ‰çº¿ç¨‹éƒ½æ— æ³•ç»§ç»­æ‰§è¡Œã€‚</li>
<li>ä¸€äº›å› ä¸ºå¤šçº¿ç¨‹å¯¼è‡´çš„å¾ˆéšæ™¦çš„BUGï¼Œéš¾ä»¥å¤ç°å¹¶è§£å†³ã€‚</li>
</ul>
<h2 id="å®ç°çº¿ç¨‹çš„æ–¹å¼"><a href="#å®ç°çº¿ç¨‹çš„æ–¹å¼" class="headerlink" title="å®ç°çº¿ç¨‹çš„æ–¹å¼"></a>å®ç°çº¿ç¨‹çš„æ–¹å¼</h2><p>ä¸åŒè¯­è¨€å¯¹äºçº¿ç¨‹çš„å®ç°å¤§ç›¸å¾„åº­ï¼š</p>
<ul>
<li>ç”±äºæ“ä½œç³»ç»Ÿæä¾›äº†åˆ›å»ºçº¿ç¨‹çš„APIï¼Œå› æ­¤éƒ¨åˆ†è¯­è¨€ä¼šç›´æ¥è°ƒç”¨è¯¥ API æ¥åˆ›å»ºçº¿ç¨‹ï¼Œå› æ­¤æœ€ç»ˆç¨‹åºå†…çš„çº¿ç¨‹æ•°å’Œè¯¥ç¨‹åºå ç”¨çš„æ“ä½œç³»ç»Ÿçº¿ç¨‹æ•°ç›¸ç­‰ï¼Œä¸€èˆ¬ç§°ä¹‹ä¸º<strong>1:1çº¿ç¨‹æ¨¡å‹</strong>ï¼Œä¾‹å¦‚ Rustã€‚è¿™ç§è®¾è®¡çš„ä¼˜ç‚¹æ˜¯è¿è¡Œæ—¶ï¼ˆruntimeï¼‰è¾ƒå°ã€‚<br>-è¿˜æœ‰äº›è¯­è¨€åœ¨å†…éƒ¨å®ç°äº†è‡ªå·±çš„çº¿ç¨‹æ¨¡å‹ï¼ˆç»¿è‰²çº¿ç¨‹ã€åç¨‹ï¼‰ï¼Œç¨‹åºå†…éƒ¨çš„ M ä¸ªçº¿ç¨‹æœ€åä¼šä»¥æŸç§æ˜ å°„æ–¹å¼ä½¿ç”¨ N ä¸ªæ“ä½œç³»ç»Ÿçº¿ç¨‹å»è¿è¡Œï¼Œå› æ­¤ç§°ä¹‹ä¸º<strong>M:Nçº¿ç¨‹æ¨¡å‹</strong>ï¼Œå…¶ä¸­ M å’Œ N å¹¶æ²¡æœ‰ç‰¹å®šçš„å½¼æ­¤é™åˆ¶å…³ç³»ã€‚ä¸€ä¸ªå…¸å‹çš„ä»£è¡¨å°±æ˜¯ Go è¯­è¨€ã€‚è¿™ç§è®¾è®¡åˆ™éœ€è¦è¾ƒå¤§çš„è¿è¡Œæ—¶ã€‚<br>-è¿˜æœ‰äº›è¯­è¨€ä½¿ç”¨äº† Actor æ¨¡å‹ï¼ŒåŸºäºæ¶ˆæ¯ä¼ é€’è¿›è¡Œå¹¶å‘ï¼Œä¾‹å¦‚ Erlang è¯­è¨€ã€‚</li>
</ul>
<h2 id="åœ¨Rustä¸­åˆ›å»ºçº¿ç¨‹"><a href="#åœ¨Rustä¸­åˆ›å»ºçº¿ç¨‹" class="headerlink" title="åœ¨Rustä¸­åˆ›å»ºçº¿ç¨‹"></a>åœ¨Rustä¸­åˆ›å»ºçº¿ç¨‹</h2><p>åœ¨Rustä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>thread::spawn</code>å‡½æ•°æ¥åˆ›å»ºçº¿ç¨‹ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::thread;</span><br><span class="line"><span class="keyword">use</span> std::time::Duration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    thread::<span class="title function_ invoke__">spawn</span>(|| &#123; <span class="comment">// å­çº¿ç¨‹ï¼Œä¸»çº¿ç¨‹ç»“æŸæ—¶ï¼Œå­çº¿ç¨‹ä¹Ÿä¼šç»“æŸ</span></span><br><span class="line">        <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">1</span>..<span class="number">10</span> &#123;</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;hi number &#123;&#125; from the spawned thread!&quot;</span>, i);</span><br><span class="line">            thread::<span class="title function_ invoke__">sleep</span>(Duration::<span class="title function_ invoke__">from_millis</span>(<span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">1</span>..<span class="number">5</span> &#123; <span class="comment">// ä¸»çº¿ç¨‹ï¼Œåœ¨i=4æ—¶ï¼Œä¸»çº¿ç¨‹ç»“æŸ</span></span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;hi number &#123;&#125; from the main thread!&quot;</span>, i);</span><br><span class="line">        thread::<span class="title function_ invoke__">sleep</span>(Duration::<span class="title function_ invoke__">from_millis</span>(<span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æœ‰å‡ ç‚¹å€¼å¾—æ³¨æ„ï¼š</p>
<ul>
<li>çº¿ç¨‹å†…éƒ¨çš„ä»£ç ä½¿ç”¨é—­åŒ…æ¥æ‰§è¡Œã€‚</li>
<li><code>main</code>çº¿ç¨‹ä¸€æ—¦ç»“æŸï¼Œç¨‹åºå°±ç«‹åˆ»ç»“æŸï¼Œå› æ­¤éœ€è¦ä¿æŒå®ƒçš„å­˜æ´»ï¼Œç›´åˆ°å…¶å®ƒå­çº¿ç¨‹å®Œæˆè‡ªå·±çš„ä»»åŠ¡ã€‚åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œä¸»çº¿ç¨‹åœ¨<code>i=4</code>æ—¶ï¼Œå­çº¿ç¨‹è¿˜åœ¨è¿è¡Œï¼Œå› æ­¤ä¼šè¾“å‡º<code>hi number 5 from the spawned thread!</code>ï¼Œä½†æ˜¯ä¹‹åä¸»çº¿ç¨‹ç»“æŸï¼Œå­çº¿ç¨‹ä¹Ÿä¼šç»“æŸã€‚</li>
<li><code>thread::sleep</code>ä¼šè®©å½“å‰çº¿ç¨‹ä¼‘çœ æŒ‡å®šçš„æ—¶é—´ï¼Œéšåå…¶å®ƒçº¿ç¨‹ä¼šè¢«è°ƒåº¦è¿è¡Œï¼Œå› æ­¤å°±ç®—ä½ çš„ç”µè„‘åªæœ‰ä¸€ä¸ª CPU æ ¸å¿ƒï¼Œè¯¥ç¨‹åºä¹Ÿä¼šè¡¨ç°çš„å¦‚åŒå¤š CPU æ ¸å¿ƒä¸€èˆ¬ï¼Œè¿™å°±æ˜¯å¹¶å‘ï¼</li>
</ul>
<p>è®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¾“å‡ºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">hi number 1 from the main thread!</span><br><span class="line">hi number 1 from the spawned thread!</span><br><span class="line">hi number 2 from the main thread!</span><br><span class="line">hi number 2 from the spawned thread!</span><br><span class="line">hi number 3 from the main thread!</span><br><span class="line">hi number 3 from the spawned thread!</span><br><span class="line">hi number 4 from the spawned thread!</span><br><span class="line">hi number 4 from the main thread!</span><br><span class="line">hi number 5 from the spawned thread!</span><br></pre></td></tr></table></figure>
<p>å¦‚æœå¤šè¿è¡Œå‡ æ¬¡ï¼Œä½ ä¼šå‘ç°å¥½åƒæ¯æ¬¡è¾“å‡ºä¼šä¸å¤ªä¸€æ ·ï¼Œå› ä¸ºï¼šè™½è¯´çº¿ç¨‹å¾€å¾€æ˜¯è½®æµæ‰§è¡Œçš„ï¼Œä½†æ˜¯è¿™ä¸€ç‚¹æ— æ³•è¢«ä¿è¯ï¼çº¿ç¨‹è°ƒåº¦çš„æ–¹å¼å¾€å¾€å–å†³äºä½ ä½¿ç”¨çš„æ“ä½œç³»ç»Ÿã€‚æ€»ä¹‹ï¼Œ<strong>åƒä¸‡ä¸è¦ä¾èµ–çº¿ç¨‹çš„æ‰§è¡Œé¡ºåº</strong>ã€‚</p>
<h3 id="ç­‰å¾…å­çº¿ç¨‹ç»“æŸ"><a href="#ç­‰å¾…å­çº¿ç¨‹ç»“æŸ" class="headerlink" title="ç­‰å¾…å­çº¿ç¨‹ç»“æŸ"></a>ç­‰å¾…å­çº¿ç¨‹ç»“æŸ</h3><p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬å‘ç°äº†ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯å½“ä¸»çº¿ç¨‹ç»“æŸæ—¶ï¼Œå­çº¿ç¨‹ä¹Ÿå°†éšä¹‹ç«‹åˆ»ç»“æŸã€‚é‚£å¦‚æœæˆ‘ä»¬æƒ³è¦è®©ä¸Šé¢çš„å­çº¿ç¨‹ä»1é¡ºåºæ‰“å°åˆ°9ï¼Œè¯¥æ€ä¹ˆåšå‘¢ï¼Ÿ</p>
<p>æ­¤æ—¶æˆ‘ä»¬å¯ä»¥é€šè¿‡<code>join</code>æ–¹æ³•æ¥ç­‰å¾…å­çº¿ç¨‹ç»“æŸã€‚<code>thread::spawn</code>çš„è¿”å›å€¼æ˜¯ä¸€ä¸ª<code>JoinHandle</code>ï¼Œå®ƒæ˜¯ä¸€ä¸ªæ™ºèƒ½æŒ‡é’ˆï¼Œå¯ä»¥è®©æˆ‘ä»¬ç­‰å¾…çº¿ç¨‹çš„ç»“æŸã€‚<code>JoinHandle</code>æŒæœ‰å€¼çš„æ‰€æœ‰æƒï¼Œè°ƒç”¨å…¶<code>join</code>æ–¹æ³•æ—¶ï¼Œä¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼Œç›´åˆ°å¯¹åº”çš„çº¿ç¨‹ç»“æŸã€‚</p>
<p><code>join</code>æ–¹æ³•ï¼šè°ƒç”¨<code>handle.join()</code>ä¼šé˜»å¡å½“å‰çº¿ç¨‹çš„è¿è¡Œï¼Œç›´åˆ°<code>handle</code>å¯¹åº”çš„çº¿ç¨‹ç»ˆç»“ã€‚</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::thread;</span><br><span class="line"><span class="keyword">use</span> std::time::Duration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">handle</span> = thread::<span class="title function_ invoke__">spawn</span>(|| &#123;</span><br><span class="line">        <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">1</span>..<span class="number">5</span> &#123;</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;hi number &#123;&#125; from the spawned thread!&quot;</span>, i);</span><br><span class="line">            thread::<span class="title function_ invoke__">sleep</span>(Duration::<span class="title function_ invoke__">from_millis</span>(<span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    handle.<span class="title function_ invoke__">join</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">1</span>..<span class="number">5</span> &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;hi number &#123;&#125; from the main thread!&quot;</span>, i);</span><br><span class="line">        thread::<span class="title function_ invoke__">sleep</span>(Duration::<span class="title function_ invoke__">from_millis</span>(<span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç”±äº<code>hanle.join</code>è¿”å›çš„æ˜¯<code>Option</code>ç±»å‹çš„å€¼ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ä½¿ç”¨<code>unwrap</code>æ¥è§£åŒ…ã€‚åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬åœ¨å­çº¿ç¨‹åæ·»åŠ äº†<code>handle.join().unwrap()</code>ï¼Œæ­¤æ—¶<code>main</code>çº¿ç¨‹ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°å­çº¿ç¨‹ç»“æŸä¹‹åæ‰ä¼šè‡ªå·±è¾“å‡ºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">hi number 1 from the spawned thread!</span><br><span class="line">hi number 2 from the spawned thread!</span><br><span class="line">hi number 3 from the spawned thread!</span><br><span class="line">hi number 4 from the spawned thread!</span><br><span class="line">hi number 1 from the main thread!</span><br><span class="line">hi number 2 from the main thread!</span><br><span class="line">hi number 3 from the main thread!</span><br><span class="line">hi number 4 from the main thread!</span><br></pre></td></tr></table></figure>
<p>ä»¥ä¸Šè¾“å‡ºæ¸…æ™°çš„å±•ç¤ºäº†çº¿ç¨‹é˜»å¡çš„ä½œç”¨ã€‚</p>
<h3 id="åœ¨çº¿ç¨‹é—­åŒ…ä¸­ä½¿ç”¨move"><a href="#åœ¨çº¿ç¨‹é—­åŒ…ä¸­ä½¿ç”¨move" class="headerlink" title="åœ¨çº¿ç¨‹é—­åŒ…ä¸­ä½¿ç”¨move"></a>åœ¨çº¿ç¨‹é—­åŒ…ä¸­ä½¿ç”¨move</h3><p>åœ¨å…ˆå‰çš„é—­åŒ…ç« èŠ‚ä¸­ï¼Œæˆ‘ä»¬æœ‰è®²è¿‡<code>move</code>å…³é”®å­—åœ¨é—­åŒ…ä¸­çš„ä½¿ç”¨å¯ä»¥è®©è¯¥é—­åŒ…æ‹¿èµ°ç¯å¢ƒä¸­æŸä¸ªå€¼çš„æ‰€æœ‰æƒï¼ŒåŒæ ·åœ°ï¼Œä½ å¯ä»¥ä½¿ç”¨<code>move</code>æ¥å°†å€¼çš„æ‰€æœ‰æƒä»ä¸€ä¸ªçº¿ç¨‹è½¬ç§»åˆ°å¦å¤–ä¸€ä¸ªçº¿ç¨‹ã€‚</p>
<p>é¦–å…ˆï¼Œæ¥çœ‹çœ‹åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­ç›´æ¥ä½¿ç”¨å¦ä¸€ä¸ªçº¿ç¨‹ä¸­çš„æ•°æ®ä¼šå¦‚ä½•ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::thread;</span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">v</span> = <span class="built_in">vec!</span>[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">handle</span> = thread::<span class="title function_ invoke__">spawn</span>(|| &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;Here&#x27;s a vector: &#123;:?&#125;&quot;</span>, v);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    handle.<span class="title function_ invoke__">join</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œå­çº¿ç¨‹ä¸­çš„é—­åŒ…æ•è·äº†ä¸»çº¿ç¨‹ä¸­çš„å˜é‡<code>v</code>ï¼Œè®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¾“å‡ºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">error[E0373]: closure may outlive the current function, but it borrows `v`, which is owned by the current function</span><br><span class="line"> --&gt; src/main.rs:6:32</span><br><span class="line">  |</span><br><span class="line">6 |     let handle = thread::spawn(|| &#123;</span><br><span class="line">  |                                ^^ may outlive borrowed value `v`</span><br><span class="line">7 |         println!(&quot;Here&#x27;s a vector: &#123;:?&#125;&quot;, v);</span><br><span class="line">  |                                           - `v` is borrowed here</span><br><span class="line">  |</span><br><span class="line">note: function requires argument type to outlive `&#x27;static`</span><br><span class="line"> --&gt; src/main.rs:6:18</span><br><span class="line">  |</span><br><span class="line">6 |       let handle = thread::spawn(|| &#123;</span><br><span class="line">  |  __________________^</span><br><span class="line">7 | |         println!(&quot;Here&#x27;s a vector: &#123;:?&#125;&quot;, v);</span><br><span class="line">8 | |     &#125;);</span><br><span class="line">  | |______^</span><br><span class="line">help: to force the closure to take ownership of `v` (and any other referenced variables), use the `move` keyword</span><br><span class="line">  |</span><br><span class="line">6 |     let handle = thread::spawn(move || &#123;</span><br><span class="line">  |                                ++++</span><br></pre></td></tr></table></figure>
<p>å…¶å®ä¸Šè¿°ä»£ç æœ¬èº«å¹¶æ²¡æœ‰é—®é¢˜ï¼Œé—®é¢˜åœ¨äº Rust æ— æ³•ç¡®å®šæ–°çš„çº¿ç¨‹ä¼šæ´»å¤šä¹…ï¼ˆå¤šä¸ªçº¿ç¨‹çš„ç»“æŸé¡ºåºå¹¶ä¸æ˜¯å›ºå®šçš„ï¼‰ï¼Œæ‰€ä»¥ä¹Ÿæ— æ³•ç¡®å®šæ–°çº¿ç¨‹æ‰€å¼•ç”¨çš„<code>v</code> æ˜¯å¦åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­ä¸€ç›´åˆæ³•ã€‚</p>
<p>å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨<code>move</code>å…³é”®å­—æ¥å°†<code>v</code>çš„æ‰€æœ‰æƒè½¬ç§»åˆ°å­çº¿ç¨‹ä¸­ï¼Œè¿™æ ·å­çº¿ç¨‹å°±å¯ä»¥éšæ„ä½¿ç”¨<code>v</code>äº†ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::thread;</span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">v</span> = <span class="built_in">vec!</span>[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">handle</span> = thread::<span class="title function_ invoke__">spawn</span>(<span class="keyword">move</span> || &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;Here&#x27;s a vector: &#123;:?&#125;&quot;</span>, v);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    handle.<span class="title function_ invoke__">join</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬éœ€è¦è®°ä½ï¼Œçº¿ç¨‹çš„å¯åŠ¨æ—¶é—´ç‚¹å’Œç»“æŸæ—¶é—´ç‚¹æ˜¯ä¸ç¡®å®šçš„ï¼Œå¦‚æœæˆ‘ä»¬ä¸æ·»åŠ <code>move</code>å…³é”®å­—ï¼Œé‚£ä¹ˆä¸»çº¿ç¨‹ä¸­çš„<code>v</code>å¯èƒ½ä¼šåœ¨å­çº¿ç¨‹ç»“æŸä¹‹å‰è¢«é‡Šæ”¾ï¼Œå¯¼è‡´å­çº¿ç¨‹æ— æ³•æ­£å¸¸ä½¿ç”¨ã€‚</p>
<h1 id="å¤šçº¿ç¨‹é€šä¿¡"><a href="#å¤šçº¿ç¨‹é€šä¿¡" class="headerlink" title="å¤šçº¿ç¨‹é€šä¿¡"></a>å¤šçº¿ç¨‹é€šä¿¡</h1><p>åœ¨å¤šçº¿ç¨‹é—´æœ‰å¤šç§æ–¹å¼å¯ä»¥å…±äº«ã€ä¼ é€’æ•°æ®ã€‚</p>
<h2 id="æ¶ˆæ¯ä¼ é€’"><a href="#æ¶ˆæ¯ä¼ é€’" class="headerlink" title="æ¶ˆæ¯ä¼ é€’"></a>æ¶ˆæ¯ä¼ é€’</h2><p>ä¸€ç§å¾ˆæµè¡Œä¸”èƒ½ä¿è¯å®‰å…¨å¹¶å‘çš„æŠ€æœ¯å°±æ˜¯ï¼š<strong>æ¶ˆæ¯ä¼ é€’</strong>ã€‚çº¿ç¨‹(<code>Actor</code>)é€šè¿‡å½¼æ­¤å‘é€æ¶ˆæ¯ï¼ˆæ•°æ®ï¼‰æ¥è¿›è¡Œé€šä¿¡ã€‚</p>
<p>åœ¨Goè¯­è¨€ä¸­æœ‰ä¸€å¥å¾ˆç»å…¸çš„è¯ï¼š<strong>Donâ€™t communicate by sharing memory, share memory by communicating</strong>ã€‚</p>
<p>ä¸Goè¯­è¨€å†…ç½®çš„<code>chan</code>ä¸åŒï¼ŒRust æ˜¯åœ¨æ ‡å‡†åº“é‡Œæä¾›äº†æ¶ˆæ¯é€šé“(<code>channel</code>)ã€‚</p>
<h3 id="æ¶ˆæ¯é€šé“Channel"><a href="#æ¶ˆæ¯é€šé“Channel" class="headerlink" title="æ¶ˆæ¯é€šé“Channel"></a>æ¶ˆæ¯é€šé“Channel</h3><p>æ¶ˆæ¯é€šé“(<code>channel</code>)æ˜¯Rustæ ‡å‡†åº“æä¾›çš„ä¸€ç§çº¿ç¨‹é—´é€šä¿¡æœºåˆ¶ï¼Œå®ƒå¯ä»¥è®©å¤šä¸ªçº¿ç¨‹ä¹‹é—´å®‰å…¨åœ°ä¼ é€’æ•°æ®ï¼Œå®ƒç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼šå‘é€ç«¯(<code>Sender</code>)å’Œæ¥æ”¶ç«¯(<code>Receiver</code>)ã€‚</p>
<p>è°ƒç”¨<code>channel</code>çš„<code>send</code>æ–¹æ³•å¯ä»¥å‘é€æ¶ˆæ¯ï¼Œè°ƒç”¨<code>Receiver</code>çš„<code>recv</code>æ–¹æ³•å¯ä»¥æ£€æŸ¥å’Œæ¥æ”¶åˆ°è¾¾çš„æ¶ˆæ¯ã€‚</p>
<p>å¦‚æœå‘é€ç«¯æˆ–è€…æ¥æ”¶ç«¯ä¸­çš„ä»»æ„ä¸€ç«¯è¢«ä¸¢å¼ƒäº†ï¼Œé‚£ä¹ˆ<code>channel</code>å°±ä¼šè¢«å…³é—­ï¼Œæ­¤æ—¶<code>recv</code>æ–¹æ³•ä¼šè¿”å›ä¸€ä¸ªé”™è¯¯ã€‚</p>
<p>æ˜¾è€Œæ˜“è§çš„æ˜¯ï¼Œä¸€ä¸ªé€šé“åº”è¯¥æ”¯æŒå¤šä¸ªå‘é€è€…å’Œæ¥æ”¶è€…ã€‚ä½†æ˜¯ï¼Œåœ¨å®é™…ä½¿ç”¨é€šé“çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ä¸åŒçš„é€šé“ç±»å‹æ¥æ»¡è¶³è¯¸å¦‚ï¼š</p>
<ul>
<li>å•ä¸ªå‘é€è€…å’Œå•ä¸ªæ¥æ”¶è€…</li>
<li>å¤šä¸ªå‘é€è€…å’Œå•ä¸ªæ¥æ”¶è€…</li>
<li>å•ä¸ªå‘é€è€…å’Œå¤šä¸ªæ¥æ”¶è€…</li>
<li>å¤šä¸ªå‘é€è€…å’Œå¤šä¸ªæ¥æ”¶è€…<br>çš„å¤šä¸ªåº”ç”¨åœºæ™¯ã€‚è®©æˆ‘ä»¬å…ˆä»<strong>å¤šå‘é€è€…ï¼Œå•æ¥æ”¶è€…</strong>çš„åœºæ™¯å¼€å§‹è®²èµ·ï¼š</li>
</ul>
<h3 id="å¤šå‘é€è€…ï¼Œå•æ¥æ”¶è€…"><a href="#å¤šå‘é€è€…ï¼Œå•æ¥æ”¶è€…" class="headerlink" title="å¤šå‘é€è€…ï¼Œå•æ¥æ”¶è€…"></a>å¤šå‘é€è€…ï¼Œå•æ¥æ”¶è€…</h3><p>æ ‡å‡†åº“æä¾›äº†é€šé“<code>std::sync::mpsc</code>ï¼Œå…¶ä¸­<code>mpsc</code>æ˜¯<code>multiple producer, single consumer</code>çš„ç¼©å†™ï¼Œä»£è¡¨äº†è¯¥é€šé“æ”¯æŒå¤šä¸ªå‘é€è€…ï¼Œä½†æ˜¯åªæ”¯æŒå”¯ä¸€çš„æ¥æ”¶è€…ã€‚<br>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ”¯æŒäº†å¤šä¸ªå‘é€è€…ï¼Œè‡ªç„¶ä¹Ÿå°±æ”¯æŒäº†å•ä¸ªå‘é€è€…ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>mspc::channel</code>å‡½æ•°æ¥åˆ›å»ºä¸€ä¸ªé€šé“ï¼Œè¿™ä¸ªå‡½æ•°ä¼šè¿”å›ä¸€ä¸ªå…ƒç»„ï¼Œå…ƒç»„ä¸­ç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯å‘é€ç«¯ï¼Œç¬¬äºŒä¸ªå…ƒç´ æ˜¯æ¥æ”¶ç«¯ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">use</span> std::sync::mpsc;</span><br><span class="line"><span class="keyword">use</span> std::thread;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// åˆ›å»ºä¸€ä¸ªæ¶ˆæ¯é€šé“, è¿”å›ä¸€ä¸ªå…ƒç»„ï¼š(å‘é€è€…ï¼Œæ¥æ”¶è€…)</span></span><br><span class="line">    <span class="keyword">let</span> (tx, rx) = mpsc::<span class="title function_ invoke__">channel</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºçº¿ç¨‹ï¼Œå¹¶å‘é€æ¶ˆæ¯</span></span><br><span class="line">    thread::<span class="title function_ invoke__">spawn</span>(<span class="keyword">move</span> || &#123;</span><br><span class="line">        <span class="comment">// å‘é€ä¸€ä¸ªæ•°å­—1, sendæ–¹æ³•è¿”å›Result&lt;T,E&gt;ï¼Œé€šè¿‡unwrapè¿›è¡Œå¿«é€Ÿé”™è¯¯å¤„ç†</span></span><br><span class="line">        tx.<span class="title function_ invoke__">send</span>(<span class="number">1</span>).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ä¸‹é¢ä»£ç å°†æŠ¥é”™ï¼Œå› ä¸ºç¼–è¯‘å™¨è‡ªåŠ¨æ¨å¯¼å‡ºé€šé“ä¼ é€’çš„å€¼æ˜¯i32ç±»å‹ï¼Œé‚£ä¹ˆOption&lt;i32&gt;ç±»å‹å°†äº§ç”Ÿä¸åŒ¹é…é”™è¯¯</span></span><br><span class="line">        <span class="comment">// tx.send(Some(1)).unwrap()</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åœ¨ä¸»çº¿ç¨‹ä¸­æ¥æ”¶å­çº¿ç¨‹å‘é€çš„æ¶ˆæ¯å¹¶è¾“å‡º</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;receive &#123;&#125;&quot;</span>, rx.<span class="title function_ invoke__">recv</span>().<span class="title function_ invoke__">unwrap</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è®©æˆ‘ä»¬å†æ¥è§£è¯»ä¸‹ä¸Šé¢çš„ä»£ç ï¼š</p>
<ul>
<li><code>tx</code>,<code>rx</code>å¯¹åº”å‘é€è€…å’Œæ¥æ”¶è€…ï¼Œå®ƒä»¬çš„ç±»å‹ç”±ç¼–è¯‘å™¨è‡ªåŠ¨æ¨å¯¼: <code>tx.send(1)</code>å‘é€äº†æ•´æ•°ï¼Œå› æ­¤å®ƒä»¬åˆ†åˆ«æ˜¯<code>mpsc::Sender&lt;i32&gt;</code>å’Œ<code>mpsc::Receiver&lt;i32&gt;</code>ç±»å‹ï¼Œéœ€è¦æ³¨æ„ï¼Œç”±äºå†…éƒ¨æ˜¯æ³›å‹å®ç°ï¼Œä¸€æ—¦ç±»å‹è¢«æ¨å¯¼ç¡®å®šï¼Œè¯¥é€šé“å°±åªèƒ½ä¼ é€’å¯¹åº”ç±»å‹çš„å€¼, ä¾‹å¦‚æ­¤ä¾‹ä¸­é<code>i32</code>ç±»å‹çš„å€¼å°†å¯¼è‡´ç¼–è¯‘é”™è¯¯ã€‚</li>
<li><code>send</code>æ–¹æ³•å‘é€æƒ³è¦å‘é€çš„æ•°æ®ï¼Œå¹¶è¿”å›<code>Result&lt;T,E&gt;</code>ï¼Œå¦‚æœå‘é€å¤±è´¥ï¼Œåˆ™è¿”å›<code>Err</code>ï¼ŒæˆåŠŸåˆ™è¿”å›<code>Ok</code>ã€‚</li>
<li><code>recv</code>æ–¹æ³•ä¼šé˜»æ­¢å½“å‰çº¿ç¨‹çš„æ‰§è¡Œï¼Œç›´åˆ°å®ƒä»é€šé“ä¸­æ¥æ”¶åˆ°æ¶ˆæ¯ï¼Œå°±ä¼šè¿”å›<code>Result&lt;T,E&gt;</code>ï¼Œå¦‚æœæ¥æ”¶å¤±è´¥ï¼Œåˆ™è¿”å›<code>Err</code>ï¼ŒæˆåŠŸåˆ™è¿”å›<code>Ok</code>ã€‚</li>
</ul>
<h3 id="ä¸é˜»å¡çš„try-recvæ–¹æ³•"><a href="#ä¸é˜»å¡çš„try-recvæ–¹æ³•" class="headerlink" title="ä¸é˜»å¡çš„try_recvæ–¹æ³•"></a>ä¸é˜»å¡çš„<code>try_recv</code>æ–¹æ³•</h3><p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†<code>recv</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼Œç›´åˆ°æ¥æ”¶åˆ°æ¶ˆæ¯ã€‚å¦‚æœæˆ‘ä»¬ä¸å¸Œæœ›é˜»å¡å½“å‰çº¿ç¨‹ï¼Œå¯ä»¥ä½¿ç”¨<code>try_recv</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¸ä¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼Œè€Œæ˜¯ç«‹å³è¿”å›<code>Result&lt;T,E&gt;</code>ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::sync::mpsc;</span><br><span class="line"><span class="keyword">use</span> std::thread;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> (tx, rx) = mpsc::<span class="title function_ invoke__">channel</span>();</span><br><span class="line"></span><br><span class="line">    thread::<span class="title function_ invoke__">spawn</span>(<span class="keyword">move</span> || &#123;</span><br><span class="line">        tx.<span class="title function_ invoke__">send</span>(<span class="number">1</span>).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;receive &#123;:?&#125;&quot;</span>, rx.<span class="title function_ invoke__">try_recv</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç”±äºå­çº¿ç¨‹çš„åˆ›å»ºéœ€è¦æ—¶é—´ï¼Œå› æ­¤<code>println!</code>å’Œ<code>try_recv</code>æ–¹æ³•ä¼šå…ˆæ‰§è¡Œï¼Œè€Œæ­¤æ—¶å­çº¿ç¨‹çš„æ¶ˆæ¯è¿˜æœªè¢«å‘å‡ºã€‚<code>try_recv</code>ä¼šå°è¯•ç«‹å³è¯»å–ä¸€æ¬¡æ¶ˆæ¯ï¼Œå› ä¸ºæ¶ˆæ¯æ²¡æœ‰å‘å‡ºï¼Œæ­¤æ¬¡è¯»å–æœ€ç»ˆä¼šæŠ¥é”™ï¼Œä¸”ä¸»çº¿ç¨‹è¿è¡Œç»“æŸï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">receive Err(Empty)</span><br></pre></td></tr></table></figure>
<p>å¦‚ä¸Šï¼Œ<code>try_recv</code>è¿”å›äº†ä¸€ä¸ªé”™è¯¯ï¼Œé”™è¯¯å†…å®¹æ˜¯Emptyï¼Œä»£è¡¨é€šé“å¹¶æ²¡æœ‰æ¶ˆæ¯ã€‚å¦‚æœä½ å°è¯•æŠŠ<code>println!</code>å¤åˆ¶ä¸€äº›è¡Œï¼Œå°±ä¼šå‘ç°ä¸€ä¸ªæœ‰è¶£çš„è¾“å‡ºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">receive Err(Empty)</span><br><span class="line">receive Ok(1)</span><br><span class="line">receive Err(Disconnected)</span><br></pre></td></tr></table></figure>
<p>å¦‚ä¸Šï¼Œå½“å­çº¿ç¨‹åˆ›å»ºæˆåŠŸä¸”å‘é€æ¶ˆæ¯åï¼Œä¸»çº¿ç¨‹ä¼šæ¥æ”¶åˆ°<code>Ok(1)</code>çš„æ¶ˆæ¯å†…å®¹ï¼Œç´§æ¥ç€å­çº¿ç¨‹ç»“æŸï¼Œå‘é€è€…ä¹Ÿéšç€è¢«<code>drop</code>ï¼Œæ­¤æ—¶æ¥æ”¶è€…åˆä¼šæŠ¥é”™ï¼Œä½†æ˜¯è¿™æ¬¡é”™è¯¯åŸå› æœ‰æ‰€ä¸åŒï¼š<code>Disconnected</code>ä»£è¡¨å‘é€è€…å·²ç»è¢«å…³é—­ã€‚</p>
<p>ä»ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºä¸€ä¸ªå¯ç¤ºï¼šé€šå¸¸éœ€è¦ä½¿ç”¨å¾ªç¯è°ƒç”¨æ¥æ£€æŸ¥<code>try_recv</code>çš„ç»“æœã€‚</p>
<h3 id="mspc-sender-clone"><a href="#mspc-sender-clone" class="headerlink" title="mspc::sender::clone"></a><code>mspc::sender::clone</code></h3><p>åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å§‹ç»ˆä½¿ç”¨äº†å•å‘é€è€…ï¼Œå•æ¥å—è€…çš„é€šé“ã€‚å¦‚æœæˆ‘ä»¬éœ€è¦å¤šä¸ªå‘é€è€…ï¼Œè¯¥æ€ä¹ˆåšå‘¢ï¼Ÿ</p>
<p>æ ‡å‡†åº“ä¸ºæˆ‘ä»¬æä¾›äº†<code>clone</code>æ–¹æ³•ï¼Œå¯ä»¥å…‹éš†å‘é€è€…ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::sync::mpsc;</span><br><span class="line"><span class="keyword">use</span> std::thread;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> (tx, rx) = mpsc::<span class="title function_ invoke__">channel</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">tx1</span> = mpsc::Sender::<span class="title function_ invoke__">clone</span>(&amp;tx);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">tx2</span> = mpsc::Sender::<span class="title function_ invoke__">clone</span>(&amp;tx);</span><br><span class="line"></span><br><span class="line">thread::<span class="title function_ invoke__">spawn</span>(<span class="keyword">move</span> || &#123;</span><br><span class="line">    tx1.<span class="title function_ invoke__">send</span>(<span class="number">1</span>).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">thread::<span class="title function_ invoke__">spawn</span>(<span class="keyword">move</span> || &#123;</span><br><span class="line">        tx2.<span class="title function_ invoke__">send</span>(<span class="number">2</span>).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;receive &#123;:?&#125;&quot;</span>, rx.<span class="title function_ invoke__">recv</span>().<span class="title function_ invoke__">unwrap</span>());</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;receive &#123;:?&#125;&quot;</span>, rx.<span class="title function_ invoke__">recv</span>().<span class="title function_ invoke__">unwrap</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="è¯¾åä¹ é¢˜"><a href="#è¯¾åä¹ é¢˜" class="headerlink" title="è¯¾åä¹ é¢˜"></a>è¯¾åä¹ é¢˜</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¯¾åä¹ é¢˜1ï¼šå®ç°å¤šçº¿ç¨‹æ–‡ä»¶å¤„ç†å™¨</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// â€¢ä»»åŠ¡æè¿°</span></span><br><span class="line"><span class="comment">// 	â€¢ä½ éœ€è¦ç¼–å†™ä¸€ä¸ªå¤šçº¿ç¨‹æ–‡ä»¶å¤„ç†å™¨ã€‚å®ƒä»ä¸€ä¸ªé€šé“ï¼ˆchannelï¼‰ä¸­æ¥æ”¶æ–‡ä»¶è·¯å¾„ï¼Œå¹¶åœ¨çº¿ç¨‹æ± ä¸­å¤„ç†è¿™äº›æ–‡ä»¶ã€‚æ–‡ä»¶å¤„ç†çš„å…·ä½“ä»»åŠ¡å¯ä»¥æ˜¯è¯»å–æ–‡ä»¶å†…å®¹å¹¶æ‰“å°åˆ°æ§åˆ¶å°ã€‚ä½ éœ€è¦ä½¿ç”¨ Rust çš„å¸¦ç¼“å†²åŒºçš„ channel æ¥æ§åˆ¶å¹¶å‘çº¿ç¨‹çš„æ•°é‡ï¼Œä»è€Œé™åˆ¶åŒæ—¶å¤„ç†çš„æ–‡ä»¶æ•°é‡ã€‚</span></span><br><span class="line"><span class="comment">// â€¢å…·ä½“è¦æ±‚</span></span><br><span class="line"><span class="comment">// 	â€¢æ–‡ä»¶å¤„ç†ä»»åŠ¡ï¼š</span></span><br><span class="line"><span class="comment">// 	â€¢å®šä¹‰ä¸€ä¸ªå‡½æ•° process_fileï¼Œè¯¥å‡½æ•°æ¥å—ä¸€ä¸ªæ–‡ä»¶è·¯å¾„ï¼Œè¯»å–æ–‡ä»¶å†…å®¹ï¼Œå¹¶å°†å†…å®¹æ‰“å°åˆ°æ§åˆ¶å°ã€‚</span></span><br><span class="line"><span class="comment">// â€¢å¤šçº¿ç¨‹æ§åˆ¶ï¼š</span></span><br><span class="line"><span class="comment">// 	â€¢åˆ›å»ºä¸€ä¸ªå¸¦ç¼“å†²åŒºçš„ channelï¼Œç”¨äºåœ¨ä¸»çº¿ç¨‹å’Œå·¥ä½œçº¿ç¨‹ä¹‹é—´ä¼ é€’æ–‡ä»¶è·¯å¾„ã€‚</span></span><br><span class="line"><span class="comment">// 	â€¢ä½¿ç”¨å¤šçº¿ç¨‹æ¥å®ç°æ–‡ä»¶å¤„ç†çš„å¹¶å‘æ€§ï¼Œé™åˆ¶çº¿ç¨‹çš„å¹¶å‘æ•°é‡ï¼ˆä¾‹å¦‚ï¼Œæœ€å¤šåŒæ—¶å¤„ç† 4 ä¸ªæ–‡ä»¶ï¼‰ã€‚</span></span><br><span class="line"><span class="comment">// â€¢ä¸»çº¿ç¨‹ä½œä¸ºç”Ÿäº§è€…ï¼š</span></span><br><span class="line"><span class="comment">// 	â€¢ä¸»çº¿ç¨‹è´Ÿè´£å‘é€šé“å‘é€æ–‡ä»¶è·¯å¾„ã€‚å‡è®¾æˆ‘ä»¬æœ‰ 10 ä¸ªæ–‡ä»¶è·¯å¾„è¦å¤„ç†ã€‚</span></span><br><span class="line"><span class="comment">// â€¢å·¥ä½œçº¿ç¨‹ä½œä¸ºæ¶ˆè´¹è€…ï¼š</span></span><br><span class="line"><span class="comment">// 	â€¢åˆ›å»ºå¤šä¸ªå·¥ä½œçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹ä»é€šé“ä¸­æ¥æ”¶æ–‡ä»¶è·¯å¾„ï¼Œå¹¶è°ƒç”¨ process_file å‡½æ•°æ¥å¤„ç†æ–‡ä»¶ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> std::sync::mpsc;</span><br><span class="line"><span class="keyword">use</span> std::thread;</span><br><span class="line"><span class="keyword">use</span> std::fs;</span><br><span class="line"><span class="keyword">use</span> std::sync::Arc;   </span><br><span class="line"><span class="keyword">use</span> std::sync::Mutex; </span><br><span class="line"><span class="keyword">use</span> std::io::Error;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">create_test_file</span>() <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;(), Error&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">dir_path</span> = <span class="string">&quot;test_files&quot;</span>;</span><br><span class="line">    fs::<span class="title function_ invoke__">create_dir_all</span>(dir_path)?;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">1</span>..=<span class="number">10</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">file_path</span> = <span class="built_in">format!</span>(<span class="string">&quot;&#123;&#125;/file_&#123;&#125;.txt&quot;</span>, dir_path, i);</span><br><span class="line">        fs::<span class="title function_ invoke__">write</span>(file_path, <span class="built_in">format!</span>(<span class="string">&quot;&#123;&#125;&#123;&#125;&#123;&#125;&quot;</span>, i, i, i))?;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">process_file</span>(file_path: <span class="type">String</span>) &#123;</span><br><span class="line">    <span class="comment">// è¯»å–æ–‡ä»¶å†…å®¹</span></span><br><span class="line">    <span class="keyword">match</span> fs::<span class="title function_ invoke__">read_to_string</span>(&amp;file_path) &#123;</span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(content) =&gt; &#123;</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;å¤„ç†æ–‡ä»¶: &#123;&#125;&quot;</span>, file_path);</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;æ–‡ä»¶å†…å®¹:\n&#123;&#125;&quot;</span>, content);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_ invoke__">Err</span>(e) =&gt; <span class="built_in">println!</span>(<span class="string">&quot;è¯»å–æ–‡ä»¶ &#123;&#125; æ—¶å‘ç”Ÿé”™è¯¯: &#123;&#125;&quot;</span>, file_path, e),</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Err</span>(e) = <span class="title function_ invoke__">create_test_file</span>() &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;åˆ›å»ºæµ‹è¯•æ–‡ä»¶æ—¶å‘ç”Ÿé”™è¯¯: &#123;&#125;&quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> (tx, rx) = mpsc::<span class="title function_ invoke__">channel</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">rx</span> = Arc::<span class="title function_ invoke__">new</span>(Mutex::<span class="title function_ invoke__">new</span>(rx));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">handles</span> = <span class="built_in">vec!</span>[];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> <span class="variable">id</span> <span class="keyword">in</span> <span class="number">0</span>..<span class="number">4</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">rx</span> = Arc::<span class="title function_ invoke__">clone</span>(&amp;rx);</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">handle</span> = thread::<span class="title function_ invoke__">spawn</span>(<span class="keyword">move</span> || &#123;</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;å·¥ä½œçº¿ç¨‹ &#123;&#125; å·²å¯åŠ¨&quot;</span>, id);</span><br><span class="line">            <span class="keyword">loop</span> &#123;</span><br><span class="line">                <span class="comment">// è·å–é”å¹¶ç«‹å³é‡Šæ”¾ï¼Œåªåœ¨æ¥æ”¶æ¶ˆæ¯æ—¶çŸ­æš‚æŒæœ‰é”</span></span><br><span class="line">                <span class="keyword">let</span> <span class="variable">received</span> = rx.<span class="title function_ invoke__">lock</span>().<span class="title function_ invoke__">unwrap</span>().<span class="title function_ invoke__">try_recv</span>();</span><br><span class="line">                <span class="keyword">match</span> received &#123;</span><br><span class="line">                    <span class="title function_ invoke__">Ok</span>(file_path) =&gt; &#123;</span><br><span class="line">                        <span class="title function_ invoke__">process_file</span>(file_path);</span><br><span class="line">                        thread::<span class="title function_ invoke__">sleep</span>(std::time::Duration::<span class="title function_ invoke__">from_millis</span>(<span class="number">1000</span>));</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="title function_ invoke__">Err</span>(mpsc::TryRecvError::Empty) =&gt; &#123;</span><br><span class="line">                        <span class="comment">// é€šé“ä¸ºç©ºï¼ŒçŸ­æš‚ç­‰å¾…åé‡è¯•</span></span><br><span class="line">                        thread::<span class="title function_ invoke__">sleep</span>(std::time::Duration::<span class="title function_ invoke__">from_millis</span>(<span class="number">10</span>));</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="title function_ invoke__">Err</span>(mpsc::TryRecvError::Disconnected) =&gt; &#123;</span><br><span class="line">                        <span class="comment">// é€šé“å·²å…³é—­ï¼Œé€€å‡ºå¾ªç¯</span></span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;å·¥ä½œçº¿ç¨‹ &#123;&#125; å·²ç»“æŸ&quot;</span>, id);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        handles.<span class="title function_ invoke__">push</span>(handle);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">1</span>..=<span class="number">10</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">path</span> = <span class="built_in">format!</span>(<span class="string">&quot;test_files/file_&#123;&#125;.txt&quot;</span>, i);</span><br><span class="line">        tx.<span class="title function_ invoke__">send</span>(path).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;å·²å‘é€æ–‡ä»¶è·¯å¾„: file_&#123;&#125;.txt&quot;</span>, i);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">drop</span>(tx);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> <span class="variable">handle</span> <span class="keyword">in</span> handles &#123;</span><br><span class="line">        handle.<span class="title function_ invoke__">join</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¯¾åä¹ é¢˜2ï¼šä½¿ç”¨Channelå®ç°ç¨‹åºçš„ä¼˜é›…åœæ­¢</span></span><br><span class="line"><span class="comment">// â€¢ ä»»åŠ¡æè¿°</span></span><br><span class="line"><span class="comment">//     ã€‚åœ¨è¿™é“ç»ƒä¹ ä¸­ï¼Œä½ éœ€è¦ç¼–å†™ä¸€ä¸ªå¤šçº¿ç¨‹ç¨‹åºï¼Œè¯¥ç¨‹åºä¼šåˆ›å»ºå¤šä¸ªå·¥ä½œçº¿ç¨‹ï¼ŒæŒç»­å¤„ç†ä»»åŠ¡ã€‚åœ¨æ¥æ”¶åˆ°åœæ­¢ä¿¡å·æ—¶ï¼Œæ‰€æœ‰å·¥ä½œçº¿ç¨‹åº”è¯¥ä¼˜é›…åœ°åœæ­¢å·¥ä½œï¼Œå¹¶ç¡®ä¿æ‰€æœ‰æœªå®Œæˆçš„ä»»åŠ¡éƒ½è¢«å¤„ç†å®Œæ¯•ã€‚</span></span><br><span class="line"><span class="comment">//     ä½ å°†ä½¿ç”¨Rustçš„channelæ¥å®ç°ä»»åŠ¡çš„è°ƒåº¦å’Œä¼˜é›…åœæ­¢æœºåˆ¶ã€‚</span></span><br><span class="line"><span class="comment">// â€¢ å…·ä½“è¦æ±‚</span></span><br><span class="line"><span class="comment">//     â€¢ å·¥ä½œçº¿ç¨‹ï¼š</span></span><br><span class="line"><span class="comment">//         åˆ›å»ºä¸€ä¸ªå·¥ä½œçº¿ç¨‹æ± ï¼Œå·¥ä½œçº¿ç¨‹ä»é€šé“æ¥æ”¶ä»»åŠ¡å¹¶å¤„ç†ã€‚</span></span><br><span class="line"><span class="comment">//         å·¥ä½œçº¿ç¨‹åº”èƒ½å¤Ÿå“åº”åœæ­¢ä¿¡å·ï¼Œå¹¶åœ¨å®Œæˆå½“å‰ä»»åŠ¡åä¼˜é›…åœ°é€€å‡ºã€‚</span></span><br><span class="line"><span class="comment">//     â€¢ ä»»åŠ¡ç»“æ„ï¼š</span></span><br><span class="line"><span class="comment">//         ä»»åŠ¡å¯ä»¥æ˜¯ç®€å•çš„æ‰“å°æ“ä½œï¼Œæ¨¡æ‹Ÿä¸€äº›è€—æ—¶å·¥ä½œï¼Œä¾‹å¦‚æ‰“å°ä»»åŠ¡IDå¹¶æš‚åœä¸€æ®µæ—¶é—´ã€‚</span></span><br><span class="line"><span class="comment">//     â€¢ ä¼˜é›…åœæ­¢ï¼š</span></span><br><span class="line"><span class="comment">//         é€šè¿‡å‘é€ä¸€ä¸ªç‰¹æ®Šçš„åœæ­¢ä¿¡å·ï¼Œé€šçŸ¥æ‰€æœ‰å·¥ä½œçº¿ç¨‹åœæ­¢æ¥æ”¶æ–°çš„ä»»åŠ¡ï¼Œå¹¶åœ¨å®Œæˆå½“å‰ä»»åŠ¡åé€€å‡ºã€‚</span></span><br><span class="line"><span class="comment">//         ç¡®ä¿æ‰€æœ‰å·²æ¥æ”¶çš„ä»»åŠ¡éƒ½è¢«å¤„ç†å®Œæ¯•ã€‚</span></span><br><span class="line"><span class="comment">//     â€¢ ä¸»çº¿ç¨‹æ§åˆ¶ï¼š</span></span><br><span class="line"><span class="comment">//         ä¸»çº¿ç¨‹åº”å½“èƒ½å¤Ÿå‘é€ä»»åŠ¡ï¼Œä¹Ÿèƒ½å¤Ÿåœ¨é€‚å½“çš„æ—¶å€™å‘é€åœæ­¢ä¿¡å·ï¼Œè§¦å‘å·¥ä½œçº¿ç¨‹çš„ä¼˜é›…åœæ­¢ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> std::sync::&#123;mpsc, Arc, Mutex&#125;;</span><br><span class="line"><span class="keyword">use</span> std::thread;</span><br><span class="line"><span class="keyword">use</span> std::time::Duration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">Message</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">NewTask</span>(<span class="type">u32</span>),</span><br><span class="line">    Stop,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Worker</span> &#123;</span><br><span class="line">    id: <span class="type">usize</span>,</span><br><span class="line">    thread: <span class="type">Option</span>&lt;thread::JoinHandle&lt;()&gt;&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Worker</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">new</span>(id: <span class="type">usize</span>, receiver: Arc&lt;Mutex&lt;mpsc::Receiver&lt;Message&gt;&gt;&gt;) <span class="punctuation">-&gt;</span> Worker &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">thread</span> = thread::<span class="title function_ invoke__">spawn</span>(<span class="keyword">move</span> || <span class="keyword">loop</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">message</span> = receiver.<span class="title function_ invoke__">lock</span>().<span class="title function_ invoke__">unwrap</span>().<span class="title function_ invoke__">recv</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">match</span> message &#123;</span><br><span class="line">                Message::<span class="title function_ invoke__">NewTask</span>(task_id) =&gt; &#123;</span><br><span class="line">                    <span class="built_in">println!</span>(<span class="string">&quot;å·¥ä½œçº¿ç¨‹&#123;&#125;æ­£åœ¨å¤„ç†ä»»åŠ¡&#123;&#125;&quot;</span>, id, task_id);</span><br><span class="line">                    thread::<span class="title function_ invoke__">sleep</span>(Duration::<span class="title function_ invoke__">from_secs</span>(<span class="number">1</span>));</span><br><span class="line">                    <span class="built_in">println!</span>(<span class="string">&quot;å·¥ä½œçº¿ç¨‹&#123;&#125;å®Œæˆä»»åŠ¡&#123;&#125;&quot;</span>, id, task_id);</span><br><span class="line">                &#125;</span><br><span class="line">                Message::Stop =&gt; &#123;</span><br><span class="line">                    <span class="built_in">println!</span>(<span class="string">&quot;å·¥ä½œçº¿ç¨‹&#123;&#125;æ”¶åˆ°åœæ­¢ä¿¡å·&quot;</span>, id);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        Worker &#123; id, thread: <span class="title function_ invoke__">Some</span>(thread) &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> (tx, rx) = mpsc::<span class="title function_ invoke__">channel</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">rx</span> = Arc::<span class="title function_ invoke__">new</span>(Mutex::<span class="title function_ invoke__">new</span>(rx));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">handles</span> = <span class="built_in">vec!</span>[];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> <span class="variable">worker_id</span> <span class="keyword">in</span> <span class="number">1</span>..=<span class="number">4</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">worker</span> = Worker::<span class="title function_ invoke__">new</span>(worker_id, Arc::<span class="title function_ invoke__">clone</span>(&amp;rx));</span><br><span class="line">        handles.<span class="title function_ invoke__">push</span>(worker);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">1</span>..=<span class="number">10</span> &#123;</span><br><span class="line">        tx.<span class="title function_ invoke__">send</span>(Message::<span class="title function_ invoke__">NewTask</span>(i)).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;ä¸»çº¿ç¨‹å‘é€ä»»åŠ¡ &#123;&#125;&quot;</span>, i);</span><br><span class="line">        thread::<span class="title function_ invoke__">sleep</span>(Duration::<span class="title function_ invoke__">from_millis</span>(<span class="number">100</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> <span class="variable">_</span> <span class="keyword">in</span> <span class="number">0</span>..handles.<span class="title function_ invoke__">len</span>() &#123;</span><br><span class="line">        tx.<span class="title function_ invoke__">send</span>(Message::Stop).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> <span class="variable">handle</span> <span class="keyword">in</span> handles &#123;</span><br><span class="line">        handle.thread.<span class="title function_ invoke__">unwrap</span>().<span class="title function_ invoke__">join</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;æ‰€æœ‰ä»»åŠ¡å®Œæˆ&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/11/02/rust-test/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Wobujiaoxyy3">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/11/02/rust-test/" class="post-title-link" itemprop="url">äºŒåå››ã€Rustæµ‹è¯•</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2024-11-02 00:44:06 / Modified: 09:02:00" itemprop="dateCreated datePublished" datetime="2024-11-02T00:44:06+08:00">2024-11-02</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h1><p>Ruståœ¨å·¥ç¨‹åŒ–æ–¹é¢å®Œç¾çš„æ”¯æŒäº†å„ç§æµ‹è¯•é…ç½®ï¼ŒåŒ…æ‹¬<code>Unit Test</code>å•å…ƒæµ‹è¯•ã€<code>Integration Test</code>é›†æˆæµ‹è¯•ã€<code>Doc Test</code>æ–‡æ¡£æµ‹è¯•ã€<code>Bench Test</code>åŸºå‡†æµ‹è¯•ã€<code>Example Test</code>ç¤ºä¾‹æµ‹è¯•ç­‰ã€‚</p>
<h2 id="å•å…ƒæµ‹è¯•-Unit-Test"><a href="#å•å…ƒæµ‹è¯•-Unit-Test" class="headerlink" title="å•å…ƒæµ‹è¯• Unit Test"></a>å•å…ƒæµ‹è¯• Unit Test</h2><p>å•å…ƒæµ‹è¯•ç›®æ ‡æ˜¯æµ‹è¯•æŸä¸€ä¸ªä»£ç å•å…ƒ(ä¸€èˆ¬éƒ½æ˜¯å‡½æ•°)ï¼ŒéªŒè¯è¯¥å•å…ƒæ˜¯å¦èƒ½æŒ‰ç…§é¢„æœŸè¿›è¡Œå·¥ä½œï¼Œä¾‹å¦‚æµ‹è¯•ä¸€ä¸ª<code>add</code>å‡½æ•°ï¼ŒéªŒè¯å½“ç»™äºˆä¸¤ä¸ªè¾“å…¥æ—¶ï¼Œæœ€ç»ˆè¿”å›çš„å’Œæ˜¯å¦ç¬¦åˆé¢„æœŸã€‚</p>
<p>æˆ‘ä»¬é¦–å…ˆä½¿ç”¨<code>cargo new --lib rust-lib</code>åˆ›å»ºä¸€ä¸ªåº“é¡¹ç›®ï¼Œæ­¤æ—¶æ‰“å¼€<code>lib.rs</code>æ–‡ä»¶ï¼Œå¯ä»¥çœ‹åˆ°å¦‚ä¸‹ä»£ç ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">add</span>(left: <span class="type">usize</span>, right: <span class="type">usize</span>) <span class="punctuation">-&gt;</span> <span class="type">usize</span> &#123;</span><br><span class="line">    left + right</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[cfg(test)]</span></span><br><span class="line"><span class="keyword">mod</span> tests &#123;</span><br><span class="line">    <span class="keyword">use</span> super::*;   <span class="comment">// ä½¿ç”¨super::*æ¥è®¿é—®çˆ¶æ¨¡å—ä¸­çš„æ‰€æœ‰å…¬å…±é¡¹</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">it_works</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">result</span> = <span class="title function_ invoke__">add</span>(<span class="number">2</span>, <span class="number">2</span>);</span><br><span class="line">        <span class="built_in">assert_eq!</span>(result, <span class="number">4</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸²ä»£ç å°±æ˜¯ä¸€ä¸ªå•å…ƒæµ‹è¯•çš„æ¨¡å—ã€‚åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä»£ç ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆä½¿ç”¨<code>#[cfg(test)]</code>å±æ€§æ¥æ ‡è®°æµ‹è¯•æ¨¡å—<code>mod tests</code>ï¼Œç„¶åä½¿ç”¨<code>#[test]</code>å±æ€§æ¥æ ‡è®°æµ‹è¯•å‡½æ•°<code>it_works</code>ã€‚  </p>
<h3 id="æ¡ä»¶ç¼–è¯‘-cfg-test"><a href="#æ¡ä»¶ç¼–è¯‘-cfg-test" class="headerlink" title="æ¡ä»¶ç¼–è¯‘#[cfg(test)]"></a>æ¡ä»¶ç¼–è¯‘<code>#[cfg(test)]</code></h3><p>ä¸Šé¢ä»£ç ä¸­çš„<code>#[cfg(test)]</code>æ ‡æ³¨å¯ä»¥å‘Šè¯‰Ruståªæœ‰åœ¨<code>cargo test</code>æ—¶æ‰ç¼–è¯‘å’Œè¿è¡Œæ¨¡å—<code>tests</code>ï¼Œå…¶å®ƒæ—¶å€™å½“è¿™æ®µä»£ç æ˜¯ç©ºæ°”å³å¯ï¼Œä¾‹å¦‚åœ¨<code>cargo build</code>æ—¶ã€‚è¿™ä¹ˆåšæœ‰å‡ ä¸ªå¥½å¤„ï¼š</p>
<ul>
<li>èŠ‚çœæ„å»ºä»£ç æ—¶çš„ç¼–è¯‘æ—¶é—´</li>
<li>å‡å°ç¼–è¯‘å‡ºçš„å¯æ‰§è¡Œæ–‡ä»¶çš„ä½“ç§¯</li>
</ul>
<h3 id="ä½¿ç”¨assert-å®"><a href="#ä½¿ç”¨assert-å®" class="headerlink" title="ä½¿ç”¨assert!å®"></a>ä½¿ç”¨<code>assert!</code>å®</h3><p>åœ¨ä¸Šé¢çš„æµ‹è¯•æ¨¡å—ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨<code>assert_eq!</code>å®æ¥æ–­è¨€<code>add</code>å‡½æ•°çš„è¿”å›å€¼æ˜¯å¦ç­‰äº<code>4</code>ã€‚<code>assert!</code>å®æ˜¯<code>assert_eq!</code>å®çš„ç®€åŒ–ç‰ˆï¼Œå®ƒç”¨äºæ–­è¨€ä¸€ä¸ªæ¡ä»¶ä¸ºçœŸã€‚å¦‚æœæ¡ä»¶ä¸ºå‡ï¼Œ<code>assert!</code>å®ä¼šç«‹å³ç»ˆæ­¢ç¨‹åºï¼Œå¹¶è¾“å‡ºé”™è¯¯ä¿¡æ¯ã€‚</p>
<p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­<code>assert_eq!(result, 4);</code>æ˜¾ç„¶æ˜¯æˆåŠŸçš„ï¼Œå› æ­¤è¯¥è¯­å¥è¿”å›äº†ä¸€ä¸ªå•å…ƒç±»å‹<code>()</code>ã€‚ä½†å¦‚æœæ–­è¨€å¤±è´¥ï¼Œ<code>assert!</code>å®ä¼šè¾“å‡ºé”™è¯¯ä¿¡æ¯ï¼Œå¹¶è¿”å›ä¸€ä¸ª<code>panic!</code>ï¼Œä½¿å¾—æµ‹è¯•å¤±è´¥ã€‚</p>
<p>ä½†å¦‚ä¸Šé¢æ‰€è¯´ï¼Œ <code>assert!</code>å®è‡ªå·±æŠ›å‡ºçš„é”™è¯¯ä¿¡æ¯åªä¼šå‘Šè¯‰æˆ‘ä»¬é”™è¯¯å‘ç”Ÿçš„åœ°æ–¹ï¼Œå¹¶æ²¡æœ‰æä¾›æ›´å¤šçš„ä¿¡æ¯ï¼Œåœ¨æœ‰äº›æ—¶å€™ä¼šè®©äººä¸€å¤´é›¾æ°´ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ä¸º<code>assert!</code>å®æä¾›ä¸€ä¸ªå¯é€‰çš„é”™è¯¯ä¿¡æ¯ï¼Œè¿™æ ·å¯ä»¥å¸®åŠ©æˆ‘ä»¬æ›´å¥½çš„å®šä½é”™è¯¯ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">assert!</span>(result == <span class="number">4</span>, <span class="string">&quot;è®¡ç®—é”™è¯¯ï¼Œresultä¸º&#123;&#125;ï¼Œä¸ç­‰äº4&quot;</span>, result);</span><br></pre></td></tr></table></figure>
<p>è¿™æ®µä»£ç è·Ÿä¹‹å‰å¹¶æ— ä¸åŒï¼Œåªæ˜¯ä¸º<code>assert!</code>æ–°å¢äº†å‡ ä¸ªæ ¼å¼åŒ–å‚æ•°ï¼Œè¿™ç§ä½¿ç”¨æ–¹å¼ä¸<code>format!</code>å¹¶æ— åŒºåˆ«ï¼Œä½†æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°æ›´åŠ ç²¾ç¡®çš„æŠ¥é”™ä¿¡æ¯ã€‚</p>
<h3 id="ä½¿ç”¨Result"><a href="#ä½¿ç”¨Result" class="headerlink" title="ä½¿ç”¨Result&lt;T, E&gt;"></a>ä½¿ç”¨<code>Result&lt;T, E&gt;</code></h3><p>æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨åœ¨å•å…ƒæµ‹è¯•ä¸­è®©å‡½æ•°è¿”å›ä¸€ä¸ª<code>Result&lt;(), E&gt;</code>ï¼Œè¿™æ ·å¯ä»¥å¸®åŠ©æˆ‘ä»¬æ›´å¥½çš„å¤„ç†é”™è¯¯ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[test]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">feature_test</span>() <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;(), <span class="type">String</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="number">2</span> + <span class="number">2</span> == <span class="number">5</span> &#123;</span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="title function_ invoke__">Err</span>(<span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;2 + 2 != 5&quot;</span>))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚æœå‡½æ•°è¿”å›<code>Ok(())</code>ï¼Œåˆ™æµ‹è¯•é€šè¿‡;ä½†è‹¥æµ‹è¯•å¤±è´¥ï¼Œåˆ™è¿”å›<code>Err(String)</code>ï¼Œå¹¶è¾“å‡ºé”™è¯¯ä¿¡æ¯ã€‚</p>
<h3 id="ä½¿ç”¨should-panic"><a href="#ä½¿ç”¨should-panic" class="headerlink" title="ä½¿ç”¨should_panic"></a>ä½¿ç”¨<code>should_panic</code></h3><p>æƒ³è±¡ä¸€ä¸‹ï¼Œå¦‚æœä¸€ä¸ªå‡½æ•°åœ¨æŸäº›æƒ…å†µä¸‹ä¼šæŠ›å‡ºé”™è¯¯ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•æµ‹è¯•è¿™ç§æƒ…å†µå‘¢ï¼Ÿä¸ºæ­¤ï¼ŒRustä¸ºæˆ‘ä»¬æä¾›äº†<code>should_panic</code>å±æ€§ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[test]</span></span><br><span class="line"><span class="meta">#[should_panic]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">test_todo</span>() &#123;</span><br><span class="line">    todo!()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ä½¿ç”¨<code>should_panic</code>å±æ€§æ—¶ï¼Œå¦‚æœæµ‹è¯•å‡½æ•°æˆåŠŸæŠ›å‡ºé”™è¯¯ï¼Œåˆ™æµ‹è¯•æˆæœï¼Œä½†å¦‚æœæ²¡æœ‰æŠ›å‡ºé”™è¯¯ï¼Œåˆ™æµ‹è¯•å¤±è´¥ã€‚</p>
<h4 id="ä½¿ç”¨expected"><a href="#ä½¿ç”¨expected" class="headerlink" title="ä½¿ç”¨expected"></a>ä½¿ç”¨<code>expected</code></h4><p>åœ¨ä¸Šé¢æˆ‘ä»¬æåˆ°å¯ä»¥ä½¿ç”¨<code>should_panic</code>å±æ€§æ¥æµ‹è¯•å‡½æ•°æ˜¯å¦æŠ›å‡ºé”™è¯¯ï¼Œä½†æœ‰æ—¶å€™æˆ‘ä»¬å¸Œæœ›æµ‹è¯•å‡½æ•°æŠ›å‡ºçš„é”™è¯¯ä¿¡æ¯ä¸æˆ‘ä»¬é¢„æœŸçš„ä¸€è‡´ï¼Œè¿™æ—¶æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨<code>expected</code>å±æ€§ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[test]</span></span><br><span class="line"><span class="meta">#[should_panic(expected = <span class="string">&quot;è®¡ç®—é”™è¯¯&quot;</span>)]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">test_todo</span>() &#123;</span><br><span class="line">    <span class="built_in">panic!</span>(<span class="string">&quot;è®¡ç®—é”™è¯¯&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>expected</code>å±æ€§ç”¨äºæŒ‡å®šæˆ‘ä»¬æœŸæœ›æµ‹è¯•å‡½æ•°æŠ›å‡ºçš„é”™è¯¯ä¿¡æ¯ï¼Œå¦‚æœæµ‹è¯•å‡½æ•°æŠ›å‡ºçš„é”™è¯¯ä¿¡æ¯ä¸æœŸæœ›çš„ä¸ä¸€è‡´ï¼Œåˆ™æµ‹è¯•å¤±è´¥ã€‚</p>
<h3 id="ä½¿ç”¨ignore"><a href="#ä½¿ç”¨ignore" class="headerlink" title="ä½¿ç”¨ignore"></a>ä½¿ç”¨<code>ignore</code></h3><p>åœ¨æœ‰äº›æ—¶å€™ï¼Œæˆ‘ä»¬å¸Œæœ›è·³è¿‡æŸä¸ªæµ‹è¯•ï¼Œè¿™æ—¶æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>ignore</code>å±æ€§ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[test]</span></span><br><span class="line"><span class="meta">#[ignore]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">test_ignore</span>() &#123;</span><br><span class="line">    todo!()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™æ ·ï¼Œåœ¨æ‰§è¡Œ<code>cargo test</code>æ—¶ï¼Œ<code>test_ignore</code>å‡½æ•°å°†è¢«è·³è¿‡ã€‚</p>
<h3 id="ä½¿ç”¨cargo-test-test-test-name"><a href="#ä½¿ç”¨cargo-test-test-test-name" class="headerlink" title="ä½¿ç”¨cargo test --test test_name"></a>ä½¿ç”¨<code>cargo test --test test_name</code></h3><p>åœ¨æœ‰äº›æ—¶å€™ï¼Œæˆ‘ä»¬å¸Œæœ›åªè¿è¡ŒæŸä¸€ä¸ªæµ‹è¯•ï¼Œè¿™æ—¶æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>cargo test --test test_name</code>å‘½ä»¤ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ cargo <span class="built_in">test</span> --<span class="built_in">test</span> test_name</span><br></pre></td></tr></table></figure>
<p>æ­¤æ—¶ï¼Œåªæœ‰å‡½æ•°åä¸º<code>test_name</code>çš„æµ‹è¯•ä¼šè¢«è¿è¡Œã€‚</p>
<h2 id="é›†æˆæµ‹è¯•-Integration-Test"><a href="#é›†æˆæµ‹è¯•-Integration-Test" class="headerlink" title="é›†æˆæµ‹è¯• Integration Test"></a>é›†æˆæµ‹è¯• Integration Test</h2><p>åœ¨å•å…ƒæµ‹è¯•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨<code>lib.rs</code>æ–‡ä»¶ä¸­ç¼–å†™æµ‹è¯•ä»£ç ï¼Œä½†è¿™æ ·ä¼šä½¿å¾—æµ‹è¯•ä»£ç ä¸ä¸šåŠ¡ä»£ç è€¦åˆåœ¨ä¸€èµ·ï¼Œä¸ä¾¿äºç®¡ç†ã€‚ä¸ºæ­¤ï¼ŒRustä¸ºæˆ‘ä»¬æä¾›äº†é›†æˆæµ‹è¯•ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥åœ¨ä¸<code>src</code>ç›®å½•å¹³çº§çš„<code>tests</code>ç›®å½•ä¸­ç¼–å†™é›†æˆæµ‹è¯•ä»£ç ï¼ŒRustä¼šè‡ªåŠ¨å°†<code>tests</code>ç›®å½•ä¸­çš„æ‰€æœ‰<code>.rs</code>æ–‡ä»¶è¯†åˆ«ä¸ºé›†æˆæµ‹è¯•æ–‡ä»¶ã€‚</p>
<p>é›†æˆæµ‹è¯•ä¸å•å…ƒæµ‹è¯•è¿˜æœ‰ä¸€ç‚¹ä¸åŒï¼šå•å…ƒæµ‹è¯•æ˜¯å¯¹ä»£ç å•å…ƒè¿›è¡Œæµ‹è¯•ï¼Œè€Œé›†æˆæµ‹è¯•å°±æ˜¯å¯¹æŸä¸€ä¸ªåŠŸèƒ½æˆ–è€…æ¥å£è¿›è¡Œæµ‹è¯•ã€‚å› æ­¤å•å…ƒæµ‹è¯•çš„é€šè¿‡ï¼Œå¹¶ä¸ä»£è¡¨é›†æˆæµ‹è¯•å°±ä¼šé€šè¿‡ï¼šå±€éƒ¨ä¸Šåæ˜ ä¸å‡ºçš„é—®é¢˜ï¼Œåœ¨å…¨å±€ä¸Šå¾ˆå¯èƒ½ä¼šæš´éœ²å‡ºæ¥ã€‚</p>
<p>è®©æˆ‘ä»¬åœ¨<code>tests</code>ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ª<code>integration.rs</code>æ–‡ä»¶ï¼Œå¹¶ç¼–å†™å¦‚ä¸‹ä»£ç ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> rust_lib::add;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[test]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">test_add</span>() &#123;</span><br><span class="line">    <span class="built_in">assert_eq!</span>(<span class="title function_ invoke__">add</span>(<span class="number">2</span>, <span class="number">2</span>), <span class="number">4</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>é¦–å…ˆä¸å•å…ƒæµ‹è¯•ä¸åŒçš„æ˜¯ï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰ä½¿ç”¨<code>mod</code>åˆ›å»ºæµ‹è¯•æ¨¡å—ï¼Œä¹Ÿæ²¡æœ‰ä½¿ç”¨<code>#[cfg(test)]</code>æ ‡æ³¨ã€‚è¿™æ˜¯å› ä¸ºé›†æˆæµ‹è¯•æœ¬èº«å°±åœ¨<code>tests</code>ç›®å½•ä¸­ï¼Œè¯´æ˜äº†å®ƒçš„ç‰¹æ®Šç”¨é€”ï¼Œå› æ­¤æ— éœ€é¢å¤–æ ‡æ³¨ã€‚å…¶æ¬¡ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†<code>use</code>å…³é”®å­—å¯¼å…¥äº†<code>add</code>å‡½æ•°ï¼Œè¿™æ˜¯å› ä¸ºé›†æˆæµ‹è¯•ä¸å•å…ƒæµ‹è¯•ä¸åŒï¼Œå®ƒä¸åœ¨<code>lib.rs</code>æ–‡ä»¶ä¸­ï¼Œå› æ­¤éœ€è¦æ‰‹åŠ¨å¯¼å…¥åæ‰èƒ½è¿›è¡Œæµ‹è¯•ã€‚</p>
<p>å¦‚æœæ­¤æ—¶æˆ‘ä»¬ç›´æ¥è¿è¡Œ<code>cargo test</code>ï¼Œä¼šè¾“å‡ºå¦‚ä¸‹ä¿¡æ¯ï¼š</p>
<figure class="highlight plaintext"><figcaption><span>cargo test</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">     Running unittests (target/debug/deps/adder-8a400aa2b5212836)</span><br><span class="line"></span><br><span class="line">running 1 test</span><br><span class="line">test tests::it_works ... ok</span><br><span class="line"></span><br><span class="line">test result: ok. 1 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s</span><br><span class="line"></span><br><span class="line">     Running tests/integration_test.rs (target/debug/deps/integration_test-2d3aeee6f15d1f20)</span><br><span class="line"></span><br><span class="line">running 1 test</span><br><span class="line">test it_adds_two ... ok</span><br><span class="line"></span><br><span class="line">test result: ok. 1 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s</span><br><span class="line"></span><br><span class="line">   Doc-tests adder</span><br><span class="line"></span><br><span class="line">running 0 tests</span><br><span class="line"></span><br><span class="line">test result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°åœ¨ä¸Šè¿°è¾“å‡ºä¸­ï¼Œæµ‹è¯•çš„å†…å®¹å…±æœ‰3ä¸ªéƒ¨åˆ†ï¼šå•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•å’Œæ–‡æ¡£æµ‹è¯•ã€‚</p>
<p>ä½†å¦‚æœæ­¤æ—¶æˆ‘ä»¬åªå¸Œæœ›è¿›è¡Œé›†æˆæµ‹è¯•ï¼Œå°±å¯ä»¥ä½¿ç”¨<code>cargo test --test integration</code>å‘½ä»¤ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ cargo <span class="built_in">test</span> --<span class="built_in">test</span> integration</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸å•å…ƒæµ‹è¯•ä¸­çš„<code>cargo test --test test_name</code>å‘½ä»¤ç±»ä¼¼ï¼Œåªä¸è¿‡å°†<code>test_name</code>æ›¿æ¢ä¸º<code>integration</code>å³å¯ã€‚</p>
<h3 id="å…±äº«æ¨¡å—"><a href="#å…±äº«æ¨¡å—" class="headerlink" title="å…±äº«æ¨¡å—"></a>å…±äº«æ¨¡å—</h3><p>åœ¨é›†æˆæµ‹è¯•çš„<code>tests</code>ç›®å½•ä¸‹ï¼Œæ¯ä¸€ä¸ªæ–‡ä»¶éƒ½æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„åŒ…ï¼Œè¿™ç§ç»„ç»‡æ–¹å¼å¯ä»¥å¾ˆå¥½çš„å¸®åŠ©æˆ‘ä»¬ç†æ¸…æµ‹è¯•ä»£ç çš„å…³ç³»ï¼Œä½†æ˜¯å¦‚æœå¤§å®¶æƒ³è¦åœ¨å¤šä¸ªæ–‡ä»¶ä¸­å…±äº«åŒä¸€ä¸ªåŠŸèƒ½è¯¥æ€ä¹ˆåšï¼Ÿä¾‹å¦‚å‡½æ•°<code>setup</code>å¯ä»¥ç”¨äºçŠ¶æ€åˆå§‹åŒ–ï¼Œç„¶åå¤šä¸ªæµ‹è¯•åŒ…éƒ½éœ€è¦ä½¿ç”¨è¯¥å‡½æ•°è¿›è¡ŒçŠ¶æ€çš„åˆå§‹åŒ–ã€‚</p>
<p>ä¹Ÿè®¸ä½ ä¼šæƒ³è¦åˆ›å»ºä¸€ä¸ª<code>tests/common.rs</code>æ–‡ä»¶ï¼Œç„¶åå°†<code>setup</code>å‡½æ•°æ”¾å…¥å…¶ä¸­ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">setup</span>() &#123;</span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–ä¸€äº›æµ‹è¯•çŠ¶æ€</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä½†æ˜¯å½“æˆ‘ä»¬è¿è¡Œ<code>cargo test</code>åï¼Œä¼šå‘ç°<strong>è¯¥å‡½æ•°è¢«å½“ä½œé›†æˆæµ‹è¯•å‡½æ•°è¿è¡Œäº†</strong>ï¼Œå³ä½¿å®ƒå¹¶æ²¡æœ‰åŒ…å«ä»»ä½•æµ‹è¯•åŠŸèƒ½ï¼Œä¹Ÿæ²¡æœ‰è¢«å…¶å®ƒæµ‹è¯•æ–‡ä»¶æ‰€è°ƒç”¨:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ cargo <span class="built_in">test</span></span><br><span class="line">     Running tests/common.rs (target/debug/deps/common-5c21f4f2c87696fb)</span><br><span class="line"></span><br><span class="line">running 0 tests</span><br><span class="line"></span><br><span class="line"><span class="built_in">test</span> result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished <span class="keyword">in</span> 0.00s</span><br></pre></td></tr></table></figure>
<p>æ˜¾ç„¶ï¼Œè¿™ä¸ªç»“æœå¹¶ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ã€‚ä¸ºäº†é¿å…è¿™ç§è¾“å‡ºï¼Œæˆ‘ä»¬ä¸èƒ½åˆ›å»º<code>tests/common.rs</code>ï¼Œè€Œæ˜¯è¦åˆ›å»º<code>tests/common/mod.rs</code>ï¼Œæ­¤æ—¶å†è¿è¡Œ<code>cargo test</code>å°±ä¸ä¼šå†çœ‹åˆ°ç›¸åº”çš„è¾“å‡ºã€‚ åŸå› æ˜¯é€šè¿‡è¿™ç§æ–‡ä»¶ç»„ç»‡å’Œå‘½åæ–¹å¼ï¼ŒRustä¸å†å°†<code>common</code>æ¨¡å—çœ‹ä½œæ˜¯é›†æˆæµ‹è¯•æ–‡ä»¶ã€‚</p>
<p>æ€»ç»“æ¥è¯´ï¼Œ<code>tests</code>ç›®å½•ä¸‹çš„å­ç›®å½•ä¸­çš„æ–‡ä»¶ä¸ä¼šè¢«å½“ä½œç‹¬ç«‹çš„åŒ…ï¼Œä¹Ÿä¸ä¼šæœ‰æµ‹è¯•è¾“å‡ºã€‚</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> adder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">mod</span> common;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[test]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">it_adds_two</span>() &#123;</span><br><span class="line">    common::<span class="title function_ invoke__">setup</span>();</span><br><span class="line">    <span class="built_in">assert_eq!</span>(<span class="number">4</span>, adder::<span class="title function_ invoke__">add_two</span>(<span class="number">2</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ­¤æ—¶ï¼Œå°±å¯ä»¥åœ¨æµ‹è¯•ä¸­è°ƒç”¨<code>common</code>ä¸­çš„å…±äº«å‡½æ•°äº†ï¼Œä¸è¿‡è¿˜æœ‰ä¸€ç‚¹å€¼å¾—æ³¨æ„ï¼Œä¸ºäº†ä½¿ç”¨<code>common</code>ï¼Œè¿™é‡Œä½¿ç”¨äº†<code>mod common</code>çš„æ–¹å¼æ¥å£°æ˜è¯¥æ¨¡å—ã€‚</p>
<h2 id="æ–‡æ¡£æµ‹è¯•-Doc-Test"><a href="#æ–‡æ¡£æµ‹è¯•-Doc-Test" class="headerlink" title="æ–‡æ¡£æµ‹è¯• Doc Test"></a>æ–‡æ¡£æµ‹è¯• Doc Test</h2><p>åœ¨ä¸Šé¢æˆ‘ä»¬è¿è¡Œ<code>cargo test</code>æ—¶ï¼Œä¼šå‘ç°ç»ˆç«¯è¾“å‡ºçš„æµ‹è¯•ä¿¡æ¯åŒ…æ‹¬äº†å•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•å’Œæ–‡æ¡£æµ‹è¯•ã€‚åœ¨å‰é¢æˆ‘ä»¬å·²ç»æåˆ°äº†å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•ï¼Œæ¥ä¸‹æ¥è®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æ–‡æ¡£æµ‹è¯•ã€‚</p>
<p>æ–‡æ¡£æµ‹è¯•åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œä¸€éƒ¨åˆ†æ˜¯é’ˆå¯¹æ¨¡å—çš„æµ‹è¯•ï¼Œè€Œå¦ä¸€éƒ¨åˆ†åˆ™æ˜¯é’ˆå¯¹å‡½æ•°çš„æµ‹è¯•ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡<code>///</code>æ¥è¿›è¡Œä¹¦å†™æ–‡æ¡£æµ‹è¯•ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Add to number</span></span><br><span class="line"><span class="comment">/// # Examples</span></span><br><span class="line"><span class="comment">/// ``` rust</span></span><br><span class="line"><span class="comment">/// assert_eq!(rust_lib::add(2, 2), 4);</span></span><br><span class="line"><span class="comment">/// ``` </span></span><br></pre></td></tr></table></figure>
<p>ä»¥ä¸Šä»£ç æœ‰å‡ ç‚¹éœ€è¦æ³¨æ„ï¼š</p>
<ul>
<li>æ–‡æ¡£æ³¨é‡Šéœ€è¦ä½äº<code>lib</code>ç±»å‹çš„åŒ…ä¸­ï¼Œä¾‹å¦‚<code>src/lib.rs</code>ä¸­</li>
<li>æ–‡æ¡£æ³¨é‡Šå¯ä»¥ä½¿ç”¨markdownè¯­æ³•ï¼ä¾‹å¦‚<code># Examples</code>çš„æ ‡é¢˜ï¼Œä»¥åŠä»£ç å—é«˜äº®</li>
<li>è¢«æ³¨é‡Šçš„å¯¹è±¡éœ€è¦ä½¿ç”¨<code>pub</code>å¯¹å¤–å¯è§ï¼Œè®°ä½ï¼šæ–‡æ¡£æ³¨é‡Šæ˜¯ç»™ç”¨æˆ·çœ‹çš„ï¼Œå†…éƒ¨å®ç°ç»†èŠ‚ä¸åº”è¯¥è¢«æš´éœ²å‡ºå»</li>
</ul>
<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡<code>cargo test --doc</code>æ¥è¿è¡Œæ–‡æ¡£æµ‹è¯•ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ cargo <span class="built_in">test</span> --doc</span><br></pre></td></tr></table></figure>

<p>åŒæ—¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨<code>//!</code>æ¥ä¸ºæ¨¡å—è¿›è¡Œæµ‹è¯•ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//! A library for adding numbers</span></span><br><span class="line"><span class="comment">//!</span></span><br><span class="line"><span class="comment">//! # utils</span></span><br><span class="line"><span class="comment">//! ```rust</span></span><br><span class="line"><span class="comment">//! assert_eq!(rust_lib::utils::add(2, 2), 4);</span></span><br><span class="line"><span class="comment">//! ```</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">mod</span> utils &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">add</span>(left: <span class="type">usize</span>, right: <span class="type">usize</span>) <span class="punctuation">-&gt;</span> <span class="type">usize</span> &#123;</span><br><span class="line">        left + right</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="åŸºå‡†æµ‹è¯•-Bench-Test"><a href="#åŸºå‡†æµ‹è¯•-Bench-Test" class="headerlink" title="åŸºå‡†æµ‹è¯• Bench Test"></a>åŸºå‡†æµ‹è¯• Bench Test</h2><p>å‡ ä¹æ‰€æœ‰å¼€å‘éƒ½çŸ¥é“ï¼Œå¦‚æœè¦æµ‹é‡ç¨‹åºçš„æ€§èƒ½ï¼Œå°±éœ€è¦æ€§èƒ½æµ‹è¯•ã€‚</p>
<p>æ€§èƒ½æµ‹è¯•åŒ…å«äº†ä¸¤ç§ï¼šå‹åŠ›æµ‹è¯•å’ŒåŸºå‡†æµ‹è¯•ã€‚å‰è€…æ˜¯é’ˆå¯¹æ¥å£ APIï¼Œæ¨¡æ‹Ÿå¤§é‡ç”¨æˆ·å»è®¿é—®æ¥å£ç„¶åç”Ÿæˆæ¥å£çº§åˆ«çš„æ€§èƒ½æ•°æ®ï¼›è€Œåè€…æ˜¯é’ˆå¯¹ä»£ç ï¼Œå¯ä»¥ç”¨æ¥æµ‹è¯•æŸä¸€æ®µä»£ç çš„è¿è¡Œé€Ÿåº¦ï¼Œä¾‹å¦‚ä¸€ä¸ªæ’åºç®—æ³•ã€‚</p>
<p>Rustä¸­æä¾›äº†<code>#[bench]</code>å±æ€§æ¥æ ‡è®°åŸºå‡†æµ‹è¯•ï¼Œå¹¶ä½¿ç”¨<code>criterion</code>åº“æ¥ç”Ÿæˆæ€§èƒ½æ•°æ®ã€‚</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#![feature(test)]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">crate</span> test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">add_two</span>(a: <span class="type">i32</span>) <span class="punctuation">-&gt;</span> <span class="type">i32</span> &#123;</span><br><span class="line">    a + <span class="number">2</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[cfg(test)]</span></span><br><span class="line"><span class="keyword">mod</span> tests &#123;</span><br><span class="line">    <span class="keyword">use</span> super::*;</span><br><span class="line">    <span class="keyword">use</span> test::Bencher;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">it_works</span>() &#123;</span><br><span class="line">        <span class="built_in">assert_eq!</span>(<span class="number">4</span>, <span class="title function_ invoke__">add_two</span>(<span class="number">2</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[bench]</span>    <span class="comment">// ä½¿ç”¨#[bench]å±æ€§æ¥æ ‡è®°åŸºå‡†æµ‹è¯•</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">bench_add_two</span>(b: &amp;<span class="keyword">mut</span> Bencher) &#123;</span><br><span class="line">        b.<span class="title function_ invoke__">iter</span>(|| <span class="title function_ invoke__">add_two</span>(<span class="number">2</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ç›®å½•ç»“æ„è§„èŒƒ"><a href="#ç›®å½•ç»“æ„è§„èŒƒ" class="headerlink" title="ç›®å½•ç»“æ„è§„èŒƒ"></a>ç›®å½•ç»“æ„è§„èŒƒ</h2><p>æœ€åï¼Œè®©æˆ‘ä»¬æ¥å›é¡¾ä¸€ä¸‹æ•´ä¸ªé¡¹ç›®çš„ç›®å½•è§„èŒƒï¼›</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">â”œâ”€â”€ Cargo.toml</span><br><span class="line">â”œâ”€â”€ Cargo.lock</span><br><span class="line">â”œâ”€â”€ src/</span><br><span class="line">â”‚   â”œâ”€â”€ lib.rs        <span class="comment"># åº“ä»£ç </span></span><br><span class="line">â”‚   â”œâ”€â”€ main.rs       <span class="comment"># äºŒè¿›åˆ¶ä»£ç </span></span><br><span class="line">â”‚   â”œâ”€â”€ bin/          <span class="comment"># é¢å¤–çš„äºŒè¿›åˆ¶æ–‡ä»¶</span></span><br><span class="line">â”‚   â”‚   â””â”€â”€ demo.rs</span><br><span class="line">â”‚   â””â”€â”€ utils/        <span class="comment"># å†…éƒ¨æ¨¡å—</span></span><br><span class="line">â”‚       â”œâ”€â”€ mod.rs</span><br><span class="line">â”‚       â””â”€â”€ math.rs</span><br><span class="line">â”œâ”€â”€ tests/            <span class="comment"># é›†æˆæµ‹è¯•ç›®å½•</span></span><br><span class="line">â”‚   â”œâ”€â”€ common/       <span class="comment"># æµ‹è¯•å…¬å…±æ¨¡å—</span></span><br><span class="line">â”‚   â”‚   â””â”€â”€ mod.rs</span><br><span class="line">â”‚   â””â”€â”€ integration_test.rs</span><br><span class="line">â”œâ”€â”€ benches/          <span class="comment"># åŸºå‡†æµ‹è¯•ç›®å½•</span></span><br><span class="line">â”‚   â””â”€â”€ bench.rs</span><br><span class="line">â”œâ”€â”€ examples/         <span class="comment"># ç¤ºä¾‹ä»£ç </span></span><br><span class="line">â”‚   â””â”€â”€ demo.rs</span><br><span class="line">â””â”€â”€ docs/            <span class="comment"># æ–‡æ¡£</span></span><br><span class="line">    â””â”€â”€ api.md</span><br></pre></td></tr></table></figure>

<h2 id="è¯¾åä¹ é¢˜"><a href="#è¯¾åä¹ é¢˜" class="headerlink" title="è¯¾åä¹ é¢˜"></a>è¯¾åä¹ é¢˜</h2>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/11/01/rust-iterator-associated-types/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Wobujiaoxyy3">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/11/01/rust-iterator-associated-types/" class="post-title-link" itemprop="url">äºŒåä¸‰ã€Rustè¿›é˜¶-è¿­ä»£å™¨ä¸å…³è”ç±»å‹</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-11-01 18:43:59" itemprop="dateCreated datePublished" datetime="2024-11-01T18:43:59+08:00">2024-11-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-11-14 07:43:58" itemprop="dateModified" datetime="2024-11-14T07:43:58+08:00">2024-11-14</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="è¿­ä»£å™¨Iterator"><a href="#è¿­ä»£å™¨Iterator" class="headerlink" title="è¿­ä»£å™¨Iterator"></a>è¿­ä»£å™¨Iterator</h1><p>è¿­ä»£å™¨ï¼ˆIteratorï¼‰æ˜¯Rustæ ‡å‡†åº“ä¸­æä¾›çš„ä¸€ç§æ•°æ®ç±»å‹ï¼Œç”¨äºéå†é›†åˆä¸­çš„å…ƒç´ ã€‚è¿­ä»£å™¨å¯ä»¥ç”¨äºéå†æ•°ç»„ã€å‘é‡ã€å“ˆå¸Œè¡¨ç­‰æ•°æ®ç»“æ„ã€‚åœ¨æ­¤è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬åªéœ€å…³å¿ƒé›†åˆä¸­çš„å…ƒç´ å¦‚ä½•å¤„ç†ï¼Œè€Œæ— éœ€å…³å¿ƒå¦‚ä½•å¼€å§‹ã€å¦‚ä½•ç»“æŸä»¥åŠéœ€è¦æŒ‰ç…§ä»€ä¹ˆæ ·çš„ç´¢å¼•å»è®¿é—®ç­‰é—®é¢˜ã€‚</p>
<p>è¿­ä»£å™¨ä¼šè´Ÿè´£éå†é›†åˆä¸­çš„æ¯ä¸ªå…ƒç´ ï¼Œå¹¶ç¡®å®šéå†ä½•æ—¶å®Œæˆã€‚</p>
<h2 id="æƒ°æ€§åˆå§‹åŒ–"><a href="#æƒ°æ€§åˆå§‹åŒ–" class="headerlink" title="æƒ°æ€§åˆå§‹åŒ–"></a>æƒ°æ€§åˆå§‹åŒ–</h2><p>Rustçš„è¿­ä»£å™¨æ˜¯æ‡’æƒ°çš„ï¼Œé™¤éæˆ‘ä»¬è°ƒç”¨æ¶ˆè´¹è¿­ä»£å™¨çš„æ–¹æ³•ï¼Œå¦åˆ™è¿­ä»£å™¨æœ¬èº«æ²¡æœ‰ä»»ä½•æ•ˆæœã€‚</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">v1</span> = <span class="built_in">vec!</span>[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿™é‡Œè™½ç„¶åˆ›å»ºäº†è¿­ä»£å™¨ï¼Œä½†æ˜¯åœ¨ä¸ä½¿ç”¨æ—¶å¹¶ä¸ä¼šéå†ï¼Œå› ä¸ºRustçš„è¿­ä»£å™¨æ˜¯æ‡’æƒ°çš„</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">v1_iter</span> = v1.<span class="title function_ invoke__">iter</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// åªæœ‰å½“forå¾ªç¯ä½¿ç”¨è¿­ä»£å™¨æ—¶ï¼Œè¿­ä»£å™¨æ‰ä¼šå¼€å§‹éå†</span></span><br><span class="line"><span class="keyword">for</span> <span class="variable">val</span> <span class="keyword">in</span> v1_iter &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, val);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ç§æƒ°æ€§åˆå§‹åŒ–çš„æ–¹å¼ç¡®ä¿äº†åˆ›å»ºè¿­ä»£å™¨ä¸ä¼šæœ‰ä»»ä½•é¢å¤–çš„æ€§èƒ½æŸè€—ï¼Œå…¶ä¸­çš„å…ƒç´ ä¹Ÿä¸ä¼šè¢«æ¶ˆè€—ï¼Œåªæœ‰ä½¿ç”¨åˆ°è¯¥è¿­ä»£å™¨çš„æ—¶å€™ï¼Œä¸€åˆ‡æ‰å¼€å§‹ã€‚</p>
<h2 id="è¿­ä»£å™¨çš„å®ç°"><a href="#è¿­ä»£å™¨çš„å®ç°" class="headerlink" title="è¿­ä»£å™¨çš„å®ç°"></a>è¿­ä»£å™¨çš„å®ç°</h2><p>è¿­ä»£å™¨æ˜¯ä¸€ä¸ªèƒ½å¤Ÿæ³¨æ„ç”Ÿæˆå…ƒç´ çš„å¯¹è±¡ã€‚å®ƒæä¾›äº†ä¸€ä¸ªç»Ÿä¸€çš„æ¥å£ï¼Œç”¨äºéå†å®¹å™¨ä¸­çš„å…ƒç´ ï¼ŒåŒæ—¶ä¿é‡äº†ç±»å‹å®‰å…¨å’Œå†…å­˜å®‰å…¨ã€‚</p>
<p>åœ¨Rustä¸­ï¼Œè¿­ä»£å™¨æ˜¯åŸºäºtraitå®ç°çš„ã€‚è¿™ä¸ªtraitè¢«ç§°ä¸º<code>Iterator</code>ï¼Œå®ƒå®šä¹‰äº†è¿­ä»£å™¨çš„åŸºæœ¬è¡Œä¸ºã€‚åœ¨è¯¥traitä¸­ï¼Œå®šä¹‰äº†<code>next</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šè¿”å›è¿­ä»£å™¨ä¸­çš„ä¸‹ä¸€ä¸ªå€¼ï¼Œå½“è¿­ä»£å™¨ç»“æŸæ—¶ï¼Œè¿”å›<code>None</code>ã€‚</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">trait</span> <span class="title class_">Iterator</span> &#123;</span><br><span class="line">    <span class="keyword">type</span> <span class="title class_">Item</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">next</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;<span class="keyword">Self</span>::Item&gt;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>type Item</code>å’Œ<code>Self::Item</code>å®šä¹‰äº†ä¸è¯¥traitå…³è”çš„ç±»å‹ï¼Œç”¨äºæŒ‡å®šè¿­ä»£å™¨ç”Ÿæˆçš„å…ƒç´ çš„ç±»å‹ã€‚</p>
<p>å®ç°<code>Iterator</code>traitéœ€è¦ä½ å®šä¹‰ä¸€ä¸ª<code>item</code>ç±»å‹ï¼Œå¹¶ä¸”ä½¿ç”¨<code>Self::Item</code>æ¥æŒ‡å®šï¼Œå®ƒç”¨äº<code>next</code>æ–¹æ³•è¿”å›çš„å€¼çš„ç±»å‹ã€‚</p>
<h2 id="å…³è”ç±»å‹"><a href="#å…³è”ç±»å‹" class="headerlink" title="å…³è”ç±»å‹"></a>å…³è”ç±»å‹</h2><p>ä¸Šé¢æˆ‘ä»¬æ‰€æåˆ°çš„å°±æ˜¯å…³è”ç±»å‹ã€‚å…³è”ç±»å‹æ˜¯traitä¸­çš„ç±»å‹å ä½ç¬¦ï¼Œå®ƒå¯ä»¥ç”¨äºtraitçš„æ–¹æ³•ç­¾åä¸­ï¼Œtraitçš„å®ç°è€…éœ€è¦ä¸ºå®ƒæŒ‡å®šå…·ä½“çš„ç±»å‹ã€‚å®ƒå¯ä»¥å®šä¹‰å‡ºåŒ…å«æŸäº›ç±»å‹çš„traitï¼Œè€Œæ— éœ€åœ¨å®ç°å‰å°±çŸ¥é“è¿™äº›ç±»å‹æ˜¯ä»€ä¹ˆã€‚</p>
<h3 id="æ³›å‹ä¸å…³è”ç±»å‹çš„åŒºåˆ«"><a href="#æ³›å‹ä¸å…³è”ç±»å‹çš„åŒºåˆ«" class="headerlink" title="æ³›å‹ä¸å…³è”ç±»å‹çš„åŒºåˆ«"></a>æ³›å‹ä¸å…³è”ç±»å‹çš„åŒºåˆ«</h3><p><strong>æ³›å‹</strong>ï¼š<br>-æ³›å‹éœ€è¦åœ¨æ¯æ¬¡å®ç°traitæ—¶æ ‡æ³¨ç±»å‹<br>-å¯ä»¥ä¸ºä¸€ä¸ªæ³›å‹å¤šæ¬¡å®ç°æŸä¸ªtraitï¼ˆä¸åŒçš„æ³›å‹å‚æ•°ï¼‰</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">trait</span> <span class="title class_">Iterator</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">next</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;T&gt;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">MyIterator</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Iterator</span>&lt;<span class="type">String</span>&gt; <span class="keyword">for</span> <span class="title class_">MyIterator</span> &#123;  <span class="comment">// ä¸ºæ³›å‹TæŒ‡å®šStringç±»å‹å¹¶å®ç°nextæ–¹æ³•</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">next</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;<span class="type">String</span>&gt; &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Iterator</span>&lt;<span class="type">i32</span>&gt; <span class="keyword">for</span> <span class="title class_">MyIterator</span> &#123;  <span class="comment">// ä¸ºæ³›å‹TæŒ‡å®ši32ç±»å‹å¹¶å®ç°nextæ–¹æ³•</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">next</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;<span class="type">i32</span>&gt; &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>å…³è”ç±»å‹</strong>ï¼š<br>-å…³è”ç±»å‹æ— éœ€åœ¨å®ç°traitæ—¶æ ‡æ³¨ç±»å‹<br>-ä¸èƒ½ä¸ºå•ä¸ªå…³è”ç±»å‹å¤šæ¬¡å®ç°æŸä¸ªtrait</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">trait</span> <span class="title class_">Iterator2</span> &#123;</span><br><span class="line">    <span class="keyword">type</span> <span class="title class_">Item</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">next</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;<span class="keyword">Self</span>::Item&gt;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">MyIterator</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Iterator2</span> <span class="keyword">for</span> <span class="title class_">MyIterator</span> &#123;</span><br><span class="line">    <span class="keyword">type</span> <span class="title class_">Item</span> = <span class="type">String</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">next</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;<span class="keyword">Self</span>::Item&gt; &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Iterator2</span> <span class="keyword">for</span> <span class="title class_">MyIterator</span> &#123;</span><br><span class="line">    <span class="keyword">type</span> <span class="title class_">Item</span> = <span class="type">i32</span>;    <span class="comment">// æ­¤æ—¶ä¼šæŠ¥é”™ï¼Œå› ä¸ºå…³è”ç±»å‹ä¸èƒ½è¢«å¤šæ¬¡å®ç°</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">next</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;<span class="keyword">Self</span>::Item&gt; &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ç®€å•è¿­ä»£å™¨"><a href="#ç®€å•è¿­ä»£å™¨" class="headerlink" title="ç®€å•è¿­ä»£å™¨"></a>ç®€å•è¿­ä»£å™¨</h2><p>ä¸‹é¢è®©æˆ‘ä»¬æ¥å®ç°ä¸€ä¸ªç®€å•çš„è¿­ä»£å™¨ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">numbers</span> = <span class="built_in">vec!</span>[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºä¸€ä¸ªè¿­ä»£å™¨</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">numbers_iter</span> = numbers.<span class="title function_ invoke__">iter</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä½¿ç”¨whileå¾ªç¯éå†è¿­ä»£å™¨ä¸­çš„å…ƒç´ </span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">let</span> <span class="variable">Some</span>(num) = numbers_iter.<span class="title function_ invoke__">next</span>() &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, num);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆä½¿ç”¨<code>numbers.iter()</code>åˆ›å»ºäº†ä¸€ä¸ªè¿­ä»£å™¨ï¼Œç„¶åä½¿ç”¨<code>while let</code>å¾ªç¯éå†äº†è¿­ä»£å™¨ä¸­çš„å…ƒç´ ï¼Œ<code>iter.next()</code>æ–¹æ³•ä¼šè¿”å›è¿­ä»£å™¨ä¸­çš„ä¸‹ä¸€ä¸ªå…ƒç´ ï¼Œå½“è¿­ä»£å™¨ç»“æŸæ—¶ï¼Œè¿”å›<code>None</code>ã€‚</p>
<p>åŒæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œä¸Šé¢çš„ä»£ç ä¸­æˆ‘ä»¬ä½¿ç”¨äº†<code>let mut</code>æ¥å£°æ˜è¿­ä»£å™¨ï¼Œè¿™æ˜¯å› ä¸º<code>next</code>æ–¹æ³•ä¼šä¿®æ”¹è¿­ä»£å™¨çš„çŠ¶æ€ï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨<code>mut</code>å…³é”®å­—ã€‚ä½†æ˜¯ä¹‹å‰åœ¨ä½¿ç”¨<code>for</code>å¾ªç¯æ—¶ï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰ä½¿ç”¨<code>mut</code>å…³é”®å­—ï¼Œè¿™æ˜¯å› ä¸º<code>for</code>å¾ªç¯ä¼šè‡ªåŠ¨å°†è¿­ä»£å™¨å£°æ˜ä¸º<code>mut</code>ï¼Œæ‰€ä»¥ä¸éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨å£°æ˜ã€‚</p>
<h2 id="å‡ ä¸ªè¿­ä»£çš„æ–¹æ³•"><a href="#å‡ ä¸ªè¿­ä»£çš„æ–¹æ³•" class="headerlink" title="å‡ ä¸ªè¿­ä»£çš„æ–¹æ³•"></a>å‡ ä¸ªè¿­ä»£çš„æ–¹æ³•</h2><p>æˆ‘ä»¬æœ‰å‡ ä¸ªä¸åŒçš„æ–¹æ³•æ¥åˆ›å»ºè¿­ä»£å™¨ï¼š</p>
<ul>
<li><code>iter()</code>ï¼šåœ¨ä¸å¯å˜å¼•ç”¨ä¸Šåˆ›å»ºä¸€ä¸ªä¸å¯å˜çš„è¿­ä»£å™¨</li>
<li><code>iter_mut()</code>ï¼šåœ¨å¯å˜å¼•ç”¨ä¸Šåˆ›å»ºä¸€ä¸ªå¯å˜çš„è¿­ä»£å™¨</li>
<li><code>into_iter()</code>ï¼šåˆ›å»ºä¸€ä¸ªæ‹¥æœ‰æ‰€æœ‰æƒçš„è¿­ä»£å™¨</li>
</ul>
<p>è®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">values</span> = <span class="built_in">vec!</span>[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> <span class="variable">v</span> <span class="keyword">in</span> values.<span class="title function_ invoke__">into_iter</span>() &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, v)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸‹é¢çš„ä»£ç å°†æŠ¥é”™ï¼Œå› ä¸º values çš„æ‰€æœ‰æƒåœ¨ä¸Šé¢ `for` å¾ªç¯ä¸­å·²ç»è¢«è½¬ç§»èµ°</span></span><br><span class="line">    <span class="comment">// println!(&quot;&#123;:?&#125;&quot;,values);</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">values</span> = <span class="built_in">vec!</span>[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">_values_iter</span> = values.<span class="title function_ invoke__">iter</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸ä¼šæŠ¥é”™ï¼Œå› ä¸º values_iter åªæ˜¯å€Ÿç”¨äº† values ä¸­çš„å…ƒç´ </span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, values);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">values</span> = <span class="built_in">vec!</span>[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line">    <span class="comment">// å¯¹ values ä¸­çš„å…ƒç´ è¿›è¡Œå¯å˜å€Ÿç”¨</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">values_iter_mut</span> = values.<span class="title function_ invoke__">iter_mut</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å–å‡ºç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œå¹¶ä¿®æ”¹ä¸º0</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Some</span>(v) = values_iter_mut.<span class="title function_ invoke__">next</span>() &#123;</span><br><span class="line">        *v = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¾“å‡º[0, 2, 3]</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, values);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®é™…ä¸Šï¼Œä»¥åå¾ˆå¤šå«æœ‰<code>into_</code>çš„æ–¹æ³•éƒ½ä¼šæ‹¿èµ°æ‰€æœ‰æƒï¼Œè€Œ<code>_mut</code>æ–¹æ³•ä¼šåˆ›å»ºä¸€ä¸ªå¯å˜å¼•ç”¨ï¼Œå‰©ä¸‹çš„éƒ½æ˜¯ä¸å¯å˜å€Ÿç”¨ã€‚</p>
<h2 id="æ¶ˆè€—è¿­ä»£å™¨çš„æ–¹æ³•"><a href="#æ¶ˆè€—è¿­ä»£å™¨çš„æ–¹æ³•" class="headerlink" title="æ¶ˆè€—è¿­ä»£å™¨çš„æ–¹æ³•"></a>æ¶ˆè€—è¿­ä»£å™¨çš„æ–¹æ³•</h2><p>æ¶ˆè´¹è€…æ˜¯è¿­ä»£å™¨ä¸Šçš„æ–¹æ³•ï¼Œå®ƒä¼šæ¶ˆè´¹æ‰è¿­ä»£å™¨ä¸­çš„å…ƒç´ ï¼Œç„¶åè¿”å›å…¶ç±»å‹çš„å€¼ï¼Œè¿™äº›æ¶ˆè´¹è€…éƒ½æœ‰ä¸€ä¸ªå…±åŒçš„ç‰¹ç‚¹ï¼šåœ¨å®ƒä»¬çš„å®šä¹‰ä¸­ï¼Œéƒ½ä¾èµ–<code>next</code>æ–¹æ³•æ¥æ¶ˆè´¹å…ƒç´ ï¼Œå› æ­¤è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆè¿­ä»£å™¨è¦å®ç°<code>Iterator</code>ç‰¹å¾ï¼Œè€Œè¯¥ç‰¹å¾å¿…é¡»è¦å®ç°<code>next</code>æ–¹æ³•çš„åŸå› ã€‚</p>
<h3 id="æ¶ˆè´¹è€…é€‚é…å™¨"><a href="#æ¶ˆè´¹è€…é€‚é…å™¨" class="headerlink" title="æ¶ˆè´¹è€…é€‚é…å™¨"></a>æ¶ˆè´¹è€…é€‚é…å™¨</h3><p>åªè¦è¿­ä»£å™¨ä¸Šçš„æŸä¸ªæ–¹æ³•<code>A</code>åœ¨å…¶å†…éƒ¨è°ƒç”¨äº†<code>next</code>æ–¹æ³•ï¼Œé‚£ä¹ˆ<code>A</code>å°±è¢«ç§°ä¸ºæ¶ˆè´¹æ€§é€‚é…å™¨ï¼šå› ä¸º<code>next</code>æ–¹æ³•ä¼šæ¶ˆè€—æ‰è¿­ä»£å™¨ä¸Šçš„å…ƒç´ ï¼Œæ‰€ä»¥æ–¹æ³•<code>A</code>çš„è°ƒç”¨ä¹Ÿä¼šæ¶ˆè€—æ‰è¿­ä»£å™¨ä¸Šçš„å…ƒç´ ã€‚</p>
<p>å…¶ä¸­ä¸€ä¸ªä¾‹å­æ˜¯<code>sum</code>æ–¹æ³•ï¼Œå®ƒä¼šæ‹¿èµ°è¿­ä»£å™¨çš„æ‰€æœ‰æƒï¼Œç„¶åé€šè¿‡ä¸æ–­è°ƒç”¨<code>next</code>æ–¹æ³•éå†æ‰€æœ‰å…ƒç´ å¹¶è¿›è¡Œæ±‚å’Œï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">v1</span> = <span class="built_in">vec!</span>[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">v1_iter</span> = v1.<span class="title function_ invoke__">iter</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">total</span>: <span class="type">i32</span> = v1_iter.<span class="title function_ invoke__">sum</span>();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">assert_eq!</span>(total, <span class="number">6</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// v1_iter æ˜¯å€Ÿç”¨äº† v1ï¼Œå› æ­¤ v1 å¯ä»¥ç…§å¸¸ä½¿ç”¨</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>,v1);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä»¥ä¸‹ä»£ç ä¼šæŠ¥é”™ï¼Œå› ä¸º `sum` æ‹¿åˆ°äº†è¿­ä»£å™¨ `v1_iter` çš„æ‰€æœ‰æƒ</span></span><br><span class="line">    <span class="comment">// println!(&quot;&#123;:?&#125;&quot;,v1_iter);</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚ä»£ç æ³¨é‡Šä¸­æ‰€è¯´æ˜çš„ï¼šåœ¨ä½¿ç”¨<code>sum</code>æ–¹æ³•åï¼Œæˆ‘ä»¬å°†æ— æ³•å†ä½¿ç”¨<code>v1_iter</code>ï¼Œå› ä¸º<code>sum</code>æ‹¿èµ°äº†è¯¥è¿­ä»£å™¨çš„æ‰€æœ‰æƒï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">sum</span>&lt;S&gt;(<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> S</span><br><span class="line">    <span class="keyword">where</span></span><br><span class="line">        <span class="keyword">Self</span>: <span class="built_in">Sized</span>,</span><br><span class="line">        S: Sum&lt;<span class="keyword">Self</span>::Item&gt;,</span><br><span class="line">    &#123;</span><br><span class="line">        Sum::<span class="title function_ invoke__">sum</span>(<span class="keyword">self</span>)</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>ä»<code>sum</code>æºç ä¸­ä¹Ÿå¯ä»¥æ¸…æ™°çœ‹å‡ºï¼Œ<code>self</code>ç±»å‹çš„æ–¹æ³•å‚æ•°æ‹¿èµ°äº†æ‰€æœ‰æƒã€‚</p>
<h3 id="è¿­ä»£å™¨é€‚é…å™¨"><a href="#è¿­ä»£å™¨é€‚é…å™¨" class="headerlink" title="è¿­ä»£å™¨é€‚é…å™¨"></a>è¿­ä»£å™¨é€‚é…å™¨</h3><p>å®šä¹‰åœ¨<code>Iterator</code>traitä¸­çš„å¦ä¸€äº›æ–¹æ³•è¢«ç§°ä¸ºè¿­ä»£å™¨é€‚é…å™¨ï¼Œå®ƒä»¬ä¸ä¼šæ¶ˆè€—æ‰è¿­ä»£å™¨ä¸­çš„å…ƒç´ ï¼Œç›¸åï¼Œå®ƒä»¬ä¼šè¿”å›ä¸€ä¸ªæ–°çš„è¿­ä»£å™¨ã€‚è¿™æ˜¯å®ç°é“¾å¼æ–¹æ³•è°ƒç”¨çš„å…³é”®ï¼š<code>v.iter().map().filter()...</code>ã€‚</p>
<p>ä¸æ¶ˆè´¹è€…é€‚é…å™¨ä¸åŒï¼Œè¿­ä»£å™¨é€‚é…å™¨æ˜¯æƒ°æ€§çš„ï¼Œè¿™æ„å‘³ç€ä½ éœ€è¦ä¸€ä¸ªæ¶ˆè´¹è€…é€‚é…å™¨æ¥è§¦å‘å®ƒä»¬çš„æ‰§è¡Œï¼Œæœ€ç»ˆå°†è¿­ä»£å™¨è½¬æ¢æˆä¸€ä¸ªå…·ä½“çš„å€¼ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">v1</span>: <span class="type">Vec</span>&lt;<span class="type">i32</span>&gt; = <span class="built_in">vec!</span>[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line"></span><br><span class="line">v1.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">map</span>(|x| x + <span class="number">1</span>);</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œçš„<code>map</code>æ–¹æ³•å°±æ˜¯ä¸€ä¸ªè¿­ä»£å™¨é€‚é…å™¨ï¼Œå…è®¸æˆ‘ä»¬å¯¹è¿­ä»£å™¨ä¸­çš„æ¯ä¸ªå…ƒç´ åº”ç”¨ä¸€ä¸ªå‡½æ•°ï¼Œå¹¶è¿”å›ä¸€ä¸ªæ–°çš„è¿­ä»£å™¨ã€‚åœ¨ä¸Šé¢çš„ä»£ç ç¤ºä¾‹ä¸­ï¼Œ<code>map</code>å°†ä¸€ä¸ªé—­åŒ…<code>|x| x + 1</code>åº”ç”¨åˆ°è¿­ä»£å™¨ä¸­çš„æ¯ä¸ªå…ƒç´ ï¼Œå¹¶è¿”å›ä¸€ä¸ªæ–°çš„è¿­ä»£å™¨ã€‚</p>
<p>è¿è¡Œåè¾“å‡ºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">warning: unused `Map` that must be used</span><br><span class="line"> --&gt; src/main.rs:4:5</span><br><span class="line">  |</span><br><span class="line">4 |     v1.iter().map(|x| x + 1);</span><br><span class="line">  |     ^^^^^^^^^^^^^^^^^^^^^^^^^</span><br><span class="line">  |</span><br><span class="line">  = note: `#[warn(unused_must_use)]` on by default</span><br><span class="line">  = note: iterators are lazy and do nothing unless consumed // è¿­ä»£å™¨`map`æ˜¯æƒ°æ€§çš„ï¼Œè¿™é‡Œä¸äº§ç”Ÿä»»ä½•æ•ˆæœ</span><br></pre></td></tr></table></figure>
<p>å¦‚ä¸Šè¿°ä¸­æ–‡æ³¨é‡Šæ‰€è¯´ï¼Œè¿™é‡Œçš„<code>map</code>æ–¹æ³•æ˜¯ä¸€ä¸ªè¿­ä»£è€…é€‚é…å™¨ï¼Œå®ƒæ˜¯æƒ°æ€§çš„ï¼Œä¸äº§ç”Ÿä»»ä½•è¡Œä¸ºï¼Œå› æ­¤æˆ‘ä»¬è¿˜éœ€è¦ä¸€ä¸ªæ¶ˆè´¹è€…é€‚é…å™¨è¿›è¡Œæ”¶å°¾ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">v1</span>: <span class="type">Vec</span>&lt;<span class="type">i32</span>&gt; = <span class="built_in">vec!</span>[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="variable">v2</span>: <span class="type">Vec</span>&lt;_&gt; = v1.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">map</span>(|x| x + <span class="number">1</span>).<span class="title function_ invoke__">collect</span>();</span><br><span class="line"></span><br><span class="line"><span class="built_in">assert_eq!</span>(v2, <span class="built_in">vec!</span>[<span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]);</span><br></pre></td></tr></table></figure>

<h3 id="collect"><a href="#collect" class="headerlink" title="collect"></a>collect</h3><p>åœ¨ä¸Šé¢ä»£ç ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†<code>collect</code>æ–¹æ³•ï¼Œå®ƒå°±æ˜¯ä¸€ä¸ªæ¶ˆè´¹è€…é€‚é…å™¨ï¼Œå®ƒæ¥å—ä¸€ä¸ªè¿­ä»£å™¨ï¼Œå¹¶å°†å…¶è½¬æ¢ä¸ºä¸€ä¸ªé›†åˆç±»å‹ï¼Œå¦‚<code>Vec</code>ã€<code>HashMap</code>ç­‰ã€‚è¿™é‡Œæˆ‘ä»¬ä¸º<code>v2</code>æ ‡æ³¨äº†<code>Vec&lt;_&gt;</code>ç±»å‹ï¼Œå°±æ˜¯ä¸ºäº†å‘Šè¯‰<code>collect</code>ï¼šå°†è¿­ä»£å™¨ä¸­çš„å…ƒç´ æ”¶é›†åˆ°ä¸€ä¸ª<code>Vec</code>ä¸­ã€‚</p>
<p>å†æ¥çœ‹çœ‹å¦‚ä½•ä½¿ç”¨<code>collect</code>æ”¶é›†æˆ<code>HashMap</code>é›†åˆï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::collections::HashMap;</span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">names</span> = [<span class="string">&quot;sunface&quot;</span>, <span class="string">&quot;sunfei&quot;</span>];</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">ages</span> = [<span class="number">18</span>, <span class="number">18</span>];</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">folks</span>: HashMap&lt;_, _&gt; = names.<span class="title function_ invoke__">into_iter</span>().<span class="title function_ invoke__">zip</span>(ages.<span class="title function_ invoke__">into_iter</span>()).<span class="title function_ invoke__">collect</span>();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>,folks);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>zip</code>æ˜¯ä¸€ä¸ªè¿­ä»£å™¨é€‚é…å™¨ï¼Œå®ƒçš„ä½œç”¨å°±æ˜¯å°†ä¸¤ä¸ªè¿­ä»£å™¨çš„å†…å®¹å‹ç¼©åˆ°ä¸€èµ·ï¼Œå½¢æˆ<code>Iterator&lt;Item=(ValueFromA, ValueFromB)&gt;</code>è¿™æ ·çš„æ–°çš„è¿­ä»£å™¨ï¼Œåœ¨æ­¤å¤„å°±æ˜¯å½¢å¦‚<code>[(name1, age1), (name2, age2)]</code>çš„è¿­ä»£å™¨ã€‚</p>
<p>ç„¶åå†é€šè¿‡<code>collect</code>å°†æ–°è¿­ä»£å™¨ä¸­<code>(K, V)</code>å½¢å¼çš„å€¼æ”¶é›†æˆ<code>HashMap&lt;K, V&gt;</code>ï¼ŒåŒæ ·çš„ï¼Œè¿™é‡Œå¿…é¡»æ˜¾å¼å£°æ˜ç±»å‹ï¼Œç„¶å<code>HashMap</code>å†…éƒ¨çš„<code>KV</code>ç±»å‹å¯ä»¥äº¤ç»™ç¼–è¯‘å™¨å»æ¨å¯¼ï¼Œæœ€ç»ˆç¼–è¯‘å™¨ä¼šæ¨å¯¼å‡º<code>HashMap&lt;&amp;str, i32&gt;</code>ï¼Œå®Œå…¨æ­£ç¡®ï¼</p>
<h3 id="filter"><a href="#filter" class="headerlink" title="filter"></a>filter</h3><p><code>filter</code>æ–¹æ³•ç”¨äºè¿‡æ»¤è¿­ä»£å™¨ä¸­çš„å…ƒç´ ï¼Œå®ƒæ¥å—ä¸€ä¸ªé—­åŒ…ä½œä¸ºå‚æ•°ï¼Œè¯¥é—­åŒ…ä¼šè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œ<code>filter</code>æ–¹æ³•ä¼šæ ¹æ®è¿™ä¸ªå¸ƒå°”å€¼æ¥å†³å®šæ˜¯å¦ä¿ç•™è¯¥å…ƒç´ :</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Shoe</span> &#123;</span><br><span class="line">    size: <span class="type">u32</span>,</span><br><span class="line">    style: <span class="type">String</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">shoes_in_size</span>(shoes: <span class="type">Vec</span>&lt;Shoe&gt;, shoe_size: <span class="type">u32</span>) <span class="punctuation">-&gt;</span> <span class="type">Vec</span>&lt;Shoe&gt; &#123;</span><br><span class="line">    shoes.<span class="title function_ invoke__">into_iter</span>().<span class="title function_ invoke__">filter</span>(|s| s.size == shoe_size).<span class="title function_ invoke__">collect</span>() <span class="comment">// ä½¿ç”¨filterè¿‡æ»¤å‡ºsizeç­‰äºshoe_sizeçš„å…ƒç´ </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>filter</code>æ˜¯è¿­ä»£å™¨é€‚é…å™¨ï¼Œç”¨äºå¯¹è¿­ä»£å™¨ä¸­çš„æ¯ä¸ªå€¼è¿›è¡Œè¿‡æ»¤ã€‚ å®ƒä½¿ç”¨é—­åŒ…ä½œä¸ºå‚æ•°ï¼Œè¯¥é—­åŒ…çš„å‚æ•°<code>s</code>æ˜¯æ¥è‡ªè¿­ä»£å™¨ä¸­çš„å€¼ï¼Œç„¶åä½¿ç”¨<code>s</code>è·Ÿå¤–éƒ¨ç¯å¢ƒä¸­çš„<code>shoe_size</code>è¿›è¡Œæ¯”è¾ƒï¼Œè‹¥ç›¸ç­‰ï¼Œåˆ™åœ¨è¿­ä»£å™¨ä¸­ä¿ç•™<code>s</code>å€¼ï¼Œè‹¥ä¸ç›¸ç­‰ï¼Œåˆ™ä»è¿­ä»£å™¨ä¸­å‰”é™¤<code>s</code>å€¼ï¼Œæœ€ç»ˆé€šè¿‡<code>collect</code>æ”¶é›†ä¸º<code>Vec&lt;Shoe&gt;</code>ç±»å‹ã€‚</p>
<h2 id="å®ç°Iteratortrait"><a href="#å®ç°Iteratortrait" class="headerlink" title="å®ç°Iteratortrait"></a>å®ç°<code>Iterator</code>trait</h2><p>ä¹‹å‰çš„å†…å®¹æˆ‘ä»¬éƒ½æ˜¯ä½¿ç”¨Rustæ ‡å‡†åº“ä¸­å·²ç»å®ç°å¥½çš„è¿­ä»£å™¨ï¼Œé‚£ä¹ˆå¦‚æœæˆ‘ä»¬æƒ³è¦å®ç°è‡ªå·±çš„è¿­ä»£å™¨ï¼Œå°±éœ€è¦å®ç°<code>Iterator</code>traitã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å¿…é¡»è¦å®ç°<code>next</code>æ–¹æ³•ï¼Œå› ä¸ºè¯¥æ–¹æ³•å®šä¹‰äº†è¿­ä»£å™¨å¦‚ä½•äº§ç”Ÿä¸‹ä¸€ä¸ªå…ƒç´ ã€‚</p>
<p>è®©æˆ‘ä»¬æ¥è‡ªå·±å®ç°ä¸€ä¸ªå§ï¼</p>
<p>é¦–å…ˆï¼Œåˆ›å»ºä¸€ä¸ªè®¡æ•°å™¨ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Counter</span> &#123;</span><br><span class="line">    count: <span class="type">u32</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Counter</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">new</span>() <span class="punctuation">-&gt;</span> Counter &#123;</span><br><span class="line">        Counter &#123; count: <span class="number">0</span> &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬ä¸ºè®¡æ•°å™¨<code>Counter</code>å®ç°äº†ä¸€ä¸ªå…³è”å‡½æ•°<code>new</code>ï¼Œç”¨äºåˆ›å»ºæ–°çš„è®¡æ•°å™¨å®ä¾‹ã€‚ä¸‹é¢æˆ‘ä»¬ç»§ç»­ä¸ºè®¡æ•°å™¨å®ç°<code>Iterator</code>ç‰¹å¾ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span> <span class="title class_">Iterator</span> <span class="keyword">for</span> <span class="title class_">Counter</span> &#123;</span><br><span class="line">    <span class="keyword">type</span> <span class="title class_">Item</span> = <span class="type">u32</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">next</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;<span class="keyword">Self</span>::Item&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.count &lt; <span class="number">5</span> &#123;</span><br><span class="line">            <span class="keyword">self</span>.count += <span class="number">1</span>;</span><br><span class="line">            <span class="title function_ invoke__">Some</span>(<span class="keyword">self</span>.count)   </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="literal">None</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é¦–å…ˆï¼Œå°†è¯¥ç‰¹å¾çš„å…³è”ç±»å‹è®¾ç½®ä¸º<code>u32</code>ï¼Œç”±äºæˆ‘ä»¬çš„è®¡æ•°å™¨ä¿å­˜çš„<code>count</code>å­—æ®µå°±æ˜¯<code>u32</code>ç±»å‹ï¼Œ å› æ­¤åœ¨<code>next</code>æ–¹æ³•ä¸­ï¼Œæœ€åè¿”å›çš„æ˜¯å®é™…ä¸Šæ˜¯<code>Option&lt;u32&gt;</code>ç±»å‹ã€‚</p>
<p>æ¯æ¬¡è°ƒç”¨<code>next</code>æ–¹æ³•ï¼Œéƒ½ä¼šè®©è®¡æ•°å™¨çš„å€¼åŠ ä¸€ï¼Œç„¶åè¿”å›æœ€æ–°çš„è®¡æ•°å€¼ï¼Œä¸€æ—¦è®¡æ•°å¤§äº<code>5</code>ï¼Œå°±è¿”å›<code>None</code>ã€‚</p>
<p>æœ€åï¼Œä½¿ç”¨æˆ‘ä»¬æ–°å»ºçš„<code>Counter</code>è¿›è¡Œè¿­ä»£ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">counter</span> = Counter::<span class="title function_ invoke__">new</span>();</span><br><span class="line"></span><br><span class="line"><span class="built_in">assert_eq!</span>(counter.<span class="title function_ invoke__">next</span>(), <span class="title function_ invoke__">Some</span>(<span class="number">1</span>));</span><br><span class="line"><span class="built_in">assert_eq!</span>(counter.<span class="title function_ invoke__">next</span>(), <span class="title function_ invoke__">Some</span>(<span class="number">2</span>));</span><br><span class="line"><span class="built_in">assert_eq!</span>(counter.<span class="title function_ invoke__">next</span>(), <span class="title function_ invoke__">Some</span>(<span class="number">3</span>));</span><br><span class="line"><span class="built_in">assert_eq!</span>(counter.<span class="title function_ invoke__">next</span>(), <span class="title function_ invoke__">Some</span>(<span class="number">4</span>));</span><br><span class="line"><span class="built_in">assert_eq!</span>(counter.<span class="title function_ invoke__">next</span>(), <span class="title function_ invoke__">Some</span>(<span class="number">5</span>));</span><br></pre></td></tr></table></figure>

<h2 id="è¯¾åä½œä¸š"><a href="#è¯¾åä½œä¸š" class="headerlink" title="è¯¾åä½œä¸š"></a>è¯¾åä½œä¸š</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Fibonacci</span> &#123;</span><br><span class="line">    a: <span class="type">u32</span>,</span><br><span class="line">    b: <span class="type">u32</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Fibonacci</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">new</span>() <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        Fibonacci &#123; a: <span class="number">0</span>, b: <span class="number">1</span> &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">take</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, n: <span class="type">usize</span>) <span class="punctuation">-&gt;</span> <span class="type">Vec</span>&lt;<span class="type">u32</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">result</span> = <span class="built_in">vec!</span>[];</span><br><span class="line">        <span class="keyword">for</span> <span class="variable">_</span> <span class="keyword">in</span> <span class="number">0</span>..n &#123;</span><br><span class="line">            result.<span class="title function_ invoke__">push</span>(<span class="keyword">self</span>.<span class="title function_ invoke__">next</span>().<span class="title function_ invoke__">unwrap</span>());</span><br><span class="line">        &#125;</span><br><span class="line">        result</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// å®ç° Iterator trait</span></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Iterator</span> <span class="keyword">for</span> <span class="title class_">Fibonacci</span> &#123;</span><br><span class="line">    <span class="keyword">type</span> <span class="title class_">Item</span> = <span class="type">u32</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">next</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;<span class="keyword">Self</span>::Item&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">next_value</span> = <span class="keyword">self</span>.a + <span class="keyword">self</span>.b;</span><br><span class="line">        <span class="keyword">self</span>.a = <span class="keyword">self</span>.b;</span><br><span class="line">        <span class="keyword">self</span>.b = next_value;</span><br><span class="line"></span><br><span class="line">        <span class="title function_ invoke__">Some</span>(<span class="keyword">self</span>.a)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">fib</span> = Fibonacci::<span class="title function_ invoke__">new</span>();</span><br><span class="line">    <span class="keyword">for</span> <span class="variable">num</span> <span class="keyword">in</span> fib.<span class="title function_ invoke__">take</span>(<span class="number">10</span>) &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, num);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/11/01/rust-closure/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Wobujiaoxyy3">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/11/01/rust-closure/" class="post-title-link" itemprop="url">äºŒåäºŒã€Rustè¿›é˜¶-é—­åŒ…</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-11-01 07:42:39" itemprop="dateCreated datePublished" datetime="2024-11-01T07:42:39+08:00">2024-11-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-11-14 07:41:57" itemprop="dateModified" datetime="2024-11-14T07:41:57+08:00">2024-11-14</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="é—­åŒ…Closure"><a href="#é—­åŒ…Closure" class="headerlink" title="é—­åŒ…Closure"></a>é—­åŒ…Closure</h1><p>Ruståœ¨ç¨‹åºè®¾è®¡ä¸­æ”¶åˆ°äº†å¾ˆå¤šè¯­è¨€çš„å½±å“ï¼Œå…¶ä¸­å°±åŒ…æ‹¬å‡½æ•°å¼ç¼–ç¨‹è¯­è¨€ã€‚å‡½æ•°å¼ç¼–ç¨‹æœ‰ç‰¹ç‚¹å¦‚ä¸‹ï¼š</p>
<ul>
<li>å‡½æ•°æ˜¯ä¸€ç­‰å…¬æ°‘ï¼Œå®ƒæ—¢å¯ä»¥å­˜å‚¨åœ¨å˜é‡ä¸­ï¼Œä¹Ÿå¯ä»¥ä½œä¸ºå‚æ•°ä¼ é€’ç»™å…¶ä»–å‡½æ•°ï¼Œè¿˜å¯ä»¥ä½œä¸ºè¿”å›å€¼è¿”å›ã€‚</li>
</ul>
<p>é—­åŒ…æ˜¯å‡½æ•°å¼ç¼–ç¨‹è¯­è¨€ä¸­éå¸¸é‡è¦çš„æ¦‚å¿µï¼ŒRustä¹Ÿå¼•å…¥äº†é—­åŒ…çš„æ¦‚å¿µã€‚</p>
<h2 id="é—­åŒ…çš„å®šä¹‰"><a href="#é—­åŒ…çš„å®šä¹‰" class="headerlink" title="é—­åŒ…çš„å®šä¹‰"></a>é—­åŒ…çš„å®šä¹‰</h2><p>é—­åŒ…æ˜¯ä¸€ç§åŒ¿åå‡½æ•°ï¼Œå®ƒå¯ä»¥èµ‹å€¼ç»™å˜é‡ä¹Ÿå¯ä»¥ä½œä¸ºå‚æ•°ä¼ é€’ç»™å…¶å®ƒå‡½æ•°ï¼Œä¸åŒäºå‡½æ•°çš„æ˜¯ï¼Œå®ƒå…è®¸æ•è·è°ƒç”¨è€…ä½œç”¨åŸŸä¸­çš„å€¼ï¼Œä¾‹å¦‚ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">x</span> = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">let</span> <span class="variable">sum</span> = |y: <span class="type">i32</span>| x + y;</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢çš„ä»£ç å±•ç¤ºäº†éå¸¸ç®€å•çš„é—­åŒ…<code>sum</code>ï¼Œå®ƒæ‹¥æœ‰ä¸€ä¸ªå…¥å‚<code>y</code>ï¼ŒåŒæ—¶æ•è·äº†ä½œç”¨åŸŸä¸­çš„<code>x</code>çš„å€¼ï¼Œå› æ­¤è°ƒç”¨<code>sum(2)</code>æ„å‘³ç€å°†<code>2</code>ï¼ˆå‚æ•°<code>y</code>ï¼‰è·Ÿ<code>1</code>ï¼ˆ<code>x</code>ï¼‰è¿›è¡Œç›¸åŠ ï¼Œæœ€ç»ˆè¿”å›å®ƒä»¬çš„å’Œï¼š<code>3</code>ã€‚</p>
<p>é—­åŒ…æœ‰ç‰¹ç‚¹å¦‚ä¸‹ï¼š</p>
<ul>
<li>å¯ä»¥æ•è·å‘¨å›´ä½œç”¨åŸŸçš„å˜é‡</li>
<li>æ”¯æŒä½œä¸ºå‚æ•°ä¼ é€’ç»™å…¶ä»–å‡½æ•°</li>
<li>å¯ä»¥è¿”å›é—­åŒ…ä½œä¸ºå‡½æ•°çš„è¿”å›å€¼</li>
<li>ç±»å‹æ¨æ–­ï¼šé—­åŒ…é€šå¸¸é€šè¿‡ç±»å‹æ¨æ–­æ¥ç¡®å®šå‚æ•°å’Œè¿”å›å€¼ç±»å‹</li>
</ul>
<h2 id="é—­åŒ…çš„è¯­æ³•"><a href="#é—­åŒ…çš„è¯­æ³•" class="headerlink" title="é—­åŒ…çš„è¯­æ³•"></a>é—­åŒ…çš„è¯­æ³•</h2><p>é—­åŒ…çš„è¯­æ³•éå¸¸ç®€å•ï¼Œåªéœ€è¦ç”¨<code>|</code>åŒ…è£¹å‚æ•°åˆ—è¡¨ï¼Œç”¨<code>-&gt;</code>æŒ‡å®šè¿”å›å€¼ç±»å‹ï¼Œç”¨<code>&#123;&#125;</code>åŒ…è£¹å‡½æ•°ä½“å³å¯ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">closure</span> = |å‚æ•°åˆ—è¡¨| <span class="punctuation">-&gt;</span> è¿”å›å€¼ç±»å‹ &#123;</span><br><span class="line">    å‡½æ•°ä½“</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>æœ‰ç®€å•ç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">add_one</span> = |x: <span class="type">i32</span>| <span class="punctuation">-&gt;</span> <span class="type">i32</span> &#123; x + <span class="number">1</span> &#125;;</span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, <span class="title function_ invoke__">add_one</span>(<span class="number">1</span>)); <span class="comment">// è¾“å‡ºï¼š2</span></span><br></pre></td></tr></table></figure>

<p>åŒæ—¶ï¼Œç”±äºRustå¯ä»¥æ¨æ–­é—­åŒ…çš„å‚æ•°å’Œè¿”å›å€¼ç±»å‹ï¼Œå› æ­¤åœ¨å¾ˆå¤šæƒ…å†µä¸‹å¯ä»¥çœç•¥ç±»å‹å£°æ˜ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">add_one</span> = |x| x + <span class="number">1</span>;</span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, <span class="title function_ invoke__">add_one</span>(<span class="number">1</span>));</span><br></pre></td></tr></table></figure>

<h2 id="é—­åŒ…çš„ä½¿ç”¨"><a href="#é—­åŒ…çš„ä½¿ç”¨" class="headerlink" title="é—­åŒ…çš„ä½¿ç”¨"></a>é—­åŒ…çš„ä½¿ç”¨</h2><h3 id="ä½œä¸ºå‡½æ•°å‚æ•°"><a href="#ä½œä¸ºå‡½æ•°å‚æ•°" class="headerlink" title="ä½œä¸ºå‡½æ•°å‚æ•°"></a>ä½œä¸ºå‡½æ•°å‚æ•°</h3><p>é—­åŒ…å¯ä»¥ä½œä¸ºå‡½æ•°çš„å‚æ•°ä¼ é€’ï¼Œä»è€Œå®ç°æ›´çµæ´»çš„ä»£ç ç»“æ„ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">apply_to_3</span>&lt;F&gt;(f: F) <span class="punctuation">-&gt;</span> <span class="type">i32</span>   <span class="comment">//è¿™é‡Œçš„å‚æ•°Fæ˜¯ä¸€ä¸ªæ³›å‹å‚æ•°ï¼ŒFæ˜¯é—­åŒ…çš„ç±»å‹</span></span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    F: <span class="title function_ invoke__">Fn</span>(<span class="type">i32</span>) <span class="punctuation">-&gt;</span> <span class="type">i32</span>,  <span class="comment">// çº¦æŸFæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œä¸”å‚æ•°æ˜¯i32ï¼Œè¿”å›å€¼ä¹Ÿæ˜¯i32</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="title function_ invoke__">f</span>(<span class="number">3</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="variable">double</span> = |x| x * <span class="number">2</span>;</span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, <span class="title function_ invoke__">apply_to_3</span>(double)); <span class="comment">// è¾“å‡ºï¼š6</span></span><br></pre></td></tr></table></figure>

<h3 id="æ•è·ç¯å¢ƒå˜é‡"><a href="#æ•è·ç¯å¢ƒå˜é‡" class="headerlink" title="æ•è·ç¯å¢ƒå˜é‡"></a>æ•è·ç¯å¢ƒå˜é‡</h3><p>é—­åŒ…å¯ä»¥æ•è·å…¶å‘¨å›´ç¯å¢ƒä¸­çš„å˜é‡ï¼Œä¾‹å¦‚ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">x</span> = <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">equal_to_x</span> = |z| z == x;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">y</span> = <span class="number">4</span>; </span><br><span class="line">    <span class="built_in">assert!</span>(<span class="title function_ invoke__">equal_to_x</span>(y)); <span class="comment">//æ–­è¨€æˆåŠŸï¼Œè¯´æ˜equal_to_xæ•è·äº†xçš„å€¼ï¼Œå³ä½¿å®ƒæ²¡æœ‰ä½œä¸ºå‚æ•°ä¼ å…¥</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œ<code>equal_to_x</code>é—­åŒ…æ•è·äº†å˜é‡<code>x</code>ï¼Œå› æ­¤åœ¨è°ƒç”¨<code>equal_to_x(y)</code>æ—¶ï¼Œ<code>y</code>çš„å€¼ä¼šä¸<code>x</code>çš„å€¼è¿›è¡Œæ¯”è¾ƒã€‚ä½†å¦‚æœæˆ‘ä»¬å°†è¯¥é—­åŒ…æ¢æˆå‡½æ•°ï¼Œé‚£ä¹ˆç»“æœä¼šæ€ä¹ˆæ ·å‘¢ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">x</span> = <span class="number">4</span>;</span><br><span class="line">    <span class="comment">//let equal_to_x = |z| z == x;</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">equal_to_x</span>(z: <span class="type">i32</span>) <span class="punctuation">-&gt;</span> <span class="type">bool</span> &#123;</span><br><span class="line">        z == x     <span class="comment">// è¿™é‡Œz == xï¼Œä½†æ˜¯xæ˜¯å‡½æ•°å¤–çš„å˜é‡ï¼Œå› æ­¤è¿™é‡Œä¼šæŠ¥é”™</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">y</span> = <span class="number">4</span>; </span><br><span class="line">    <span class="built_in">assert!</span>(<span class="title function_ invoke__">equal_to_x</span>(y)); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ˜¾ç„¶å‡½æ•°<code>equal_to_x</code>æ²¡æœ‰æ•è·å˜é‡<code>x</code>ã€‚</p>
<p>é—­åŒ…æœ‰ä¸‰ç§æ•è·å˜é‡çš„æ–¹å¼ï¼š</p>
<ul>
<li>å€¼æ•è·ï¼šé—­åŒ…é€šè¿‡å€¼æ•è·å…¶ç¯å¢ƒä¸­çš„å˜é‡ï¼Œå°†ç¯å¢ƒå˜é‡çš„æ‰€æœ‰æƒè½¬ç§»åˆ°é—­åŒ…ä¸­</li>
<li>å¼•ç”¨æ•è·ï¼šé—­åŒ…é€šè¿‡å¼•ç”¨æ•è·å…¶ç¯å¢ƒä¸­çš„å˜é‡ï¼Œé—­åŒ…åœ¨å®šä¹‰æ—¶æ•è·å˜é‡çš„å¼•ç”¨ï¼Œåœ¨è°ƒç”¨æ—¶ä½¿ç”¨è¿™äº›å¼•ç”¨ã€‚</li>
<li>å¯å˜å¼•ç”¨æ•è·ï¼šé—­åŒ…é€šè¿‡å¯å˜å¼•ç”¨æ•è·å…¶ç¯å¢ƒä¸­çš„å˜é‡ï¼Œé—­åŒ…åœ¨å®šä¹‰æ—¶æ•è·å˜é‡çš„å¯å˜å¼•ç”¨ï¼Œåœ¨è°ƒç”¨æ—¶ä½¿ç”¨è¿™äº›å¯å˜å¼•ç”¨ã€‚</li>
</ul>
<p>è®©æˆ‘ä»¬æ¥çœ‹ä¸‹é¢çš„å‡ ä¸ªä¾‹å­ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">num</span> = <span class="number">5</span>;</span><br><span class="line"><span class="comment">// å¼•ç”¨æ•è·</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">add_num</span> = |x: <span class="type">i32</span>| x + num;</span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, <span class="title function_ invoke__">add_num</span>(<span class="number">1</span>)); <span class="comment">// è¾“å‡ºï¼š6</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å¯å˜å¼•ç”¨æ•è·</span></span><br><span class="line"><span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">change_num</span> = |x: <span class="type">i32</span>| num += x;</span><br><span class="line"><span class="title function_ invoke__">change_num</span>(<span class="number">5</span>);</span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, num); <span class="comment">// è¾“å‡ºï¼š10</span></span><br></pre></td></tr></table></figure>

<h2 id="é—­åŒ…çš„ç±»å‹æ¨å¯¼"><a href="#é—­åŒ…çš„ç±»å‹æ¨å¯¼" class="headerlink" title="é—­åŒ…çš„ç±»å‹æ¨å¯¼"></a>é—­åŒ…çš„ç±»å‹æ¨å¯¼</h2><p>Rust æ˜¯é™æ€è¯­è¨€ï¼Œå› æ­¤æ‰€æœ‰çš„å˜é‡éƒ½å…·æœ‰ç±»å‹ï¼Œä½†æ˜¯å¾—ç›Šäºç¼–è¯‘å™¨çš„å¼ºå¤§ç±»å‹æ¨å¯¼èƒ½åŠ›ï¼Œåœ¨å¾ˆå¤šæ—¶å€™æˆ‘ä»¬å¹¶ä¸éœ€è¦æ˜¾å¼åœ°å»å£°æ˜ç±»å‹ï¼Œä½†æ˜¯æ˜¾ç„¶å‡½æ•°å¹¶ä¸åœ¨æ­¤åˆ—ï¼Œå¿…é¡»æ‰‹åŠ¨ä¸ºå‡½æ•°çš„æ‰€æœ‰å‚æ•°å’Œè¿”å›å€¼æŒ‡å®šç±»å‹ã€‚åŸå› åœ¨äºå‡½æ•°å¾€å¾€ä¼šä½œä¸º API æä¾›ç»™ä½ çš„ç”¨æˆ·ï¼Œå› æ­¤ä½ çš„ç”¨æˆ·å¿…é¡»åœ¨ä½¿ç”¨æ—¶çŸ¥é“ä¼ å…¥å‚æ•°çš„ç±»å‹å’Œè¿”å›å€¼ç±»å‹ã€‚</p>
<p>ä¸å‡½æ•°ç›¸åï¼Œé—­åŒ…å¹¶ä¸ä¼šä½œä¸º API å¯¹å¤–æä¾›ï¼Œå› æ­¤å®ƒå¯ä»¥äº«å—ç¼–è¯‘å™¨çš„ç±»å‹æ¨å¯¼èƒ½åŠ›ï¼Œæ— éœ€æ ‡æ³¨å‚æ•°å’Œè¿”å›å€¼çš„ç±»å‹ã€‚</p>
<p>ä¸ºäº†å¢åŠ ä»£ç å¯è¯»æ€§ï¼Œæœ‰æ—¶å€™æˆ‘ä»¬ä¼šæ˜¾å¼åœ°ç»™ç±»å‹è¿›è¡Œæ ‡æ³¨ï¼Œå‡ºäºåŒæ ·çš„ç›®çš„ï¼Œä¹Ÿå¯ä»¥ç»™é—­åŒ…æ ‡æ³¨ç±»å‹ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">sum</span> = |x: <span class="type">i32</span>, y: <span class="type">i32</span>| <span class="punctuation">-&gt;</span> <span class="type">i32</span> &#123;</span><br><span class="line">    x + y</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>ä¸ä¹‹ç›¸æ¯”ï¼Œä¸æ ‡æ³¨ç±»å‹çš„é—­åŒ…å£°æ˜ä¼šæ›´ç®€æ´äº›ï¼š<code>let sum = |x, y| x + y</code>ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œé’ˆå¯¹<code>sum</code>é—­åŒ…ï¼Œå¦‚æœä½ åªè¿›è¡Œäº†å£°æ˜ï¼Œä½†æ˜¯æ²¡æœ‰ä½¿ç”¨ï¼Œç¼–è¯‘å™¨ä¼šæç¤ºä½ ä¸º<code>x, y</code>æ·»åŠ ç±»å‹æ ‡æ³¨ï¼Œå› ä¸ºå®ƒç¼ºä¹å¿…è¦çš„ä¸Šä¸‹æ–‡ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">sum</span>  = |x, y| x + y;</span><br><span class="line"><span class="keyword">let</span> <span class="variable">v</span> = <span class="title function_ invoke__">sum</span>(<span class="number">1</span>, <span class="number">2</span>);</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨äº†<code>sum</code>ï¼ŒåŒæ—¶æŠŠ<code>1</code>ä¼ ç»™äº†<code>x</code>ï¼Œ<code>2</code>ä¼ ç»™äº†<code>y</code>ï¼Œå› æ­¤ç¼–è¯‘å™¨æ‰å¯ä»¥æ¨å¯¼å‡º<code>x,y</code>çš„ç±»å‹ä¸º<code>i32</code>ã€‚</p>
<p>ååˆ†å€¼å¾—æˆ‘ä»¬æ³¨æ„çš„æ˜¯ï¼Œè™½ç„¶ç±»å‹æ¨å¯¼ååˆ†å¥½ç”¨ï¼Œä½†å®ƒä¸æ˜¯æ³›å‹ï¼Œ<strong>å½“ç¼–è¯‘å™¨æ¨å¯¼å‡ºä¸€ç§ç±»å‹åï¼Œå®ƒå°±ä¼šä¸€ç›´ä½¿ç”¨è¯¥ç±»å‹ï¼š</strong></p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">example_closure</span> = |x| x;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="variable">s</span> = <span class="title function_ invoke__">example_closure</span>(<span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;hello&quot;</span>));</span><br><span class="line"><span class="keyword">let</span> <span class="variable">n</span> = <span class="title function_ invoke__">example_closure</span>(<span class="number">5</span>); <span class="comment">// ç¼–è¯‘å™¨ä¼šæŠ¥é”™ï¼Œå› ä¸ºç¼–è¯‘å™¨å·²ç»æ¨å¯¼å‡ºxçš„ç±»å‹ä¸ºStringï¼Œå› æ­¤ä¸èƒ½å°†i32ç±»å‹çš„5ä¼ é€’ç»™x</span></span><br></pre></td></tr></table></figure>
<p>å½“è¿è¡Œåˆ°<code>let n = example_closure(5);</code>æ—¶ï¼Œç¼–è¯‘å™¨ä¼šæŠ¥é”™ï¼Œå› ä¸ºç¼–è¯‘å™¨å·²ç»æ¨å¯¼å‡º<code>x</code>çš„ç±»å‹ä¸º<code>String</code>ï¼Œå› æ­¤ä¸èƒ½å°†<code>i32</code>ç±»å‹çš„<code>5</code>ä¼ é€’ç»™<code>x</code>ã€‚</p>
<h2 id="é—­åŒ…åŸç†"><a href="#é—­åŒ…åŸç†" class="headerlink" title="é—­åŒ…åŸç†"></a>é—­åŒ…åŸç†</h2><p><strong>è‡ªåŠ¨å®ç°çš„å‡½æ•°ç±»å‹ï¼š</strong><br><code>Fn</code>ã€<code>FnMut</code>ã€<code>FnOnce</code>æ˜¯ä¸‰ä¸ªè‡ªåŠ¨å®ç°çš„é—­åŒ…traitï¼Œåˆ†åˆ«è¡¨ç¤ºæŒ‰å¼•ç”¨æ•è·ã€æŒ‰å¯å˜å¼•ç”¨æ•è·å’ŒæŒ‰å€¼æ•è·ã€‚å½“é—­åŒ…æ•è·å˜é‡æ—¶ï¼Œç¼–è¯‘å™¨ä¼šæ ¹æ®æ•è·å˜é‡çš„æ–¹å¼è‡ªåŠ¨å®ç°å¯¹åº”çš„traitï¼š</p>
<ul>
<li>æ‰€æœ‰çš„é—­åŒ…éƒ½å®ç°äº†<code>FnOnce</code></li>
<li>æ— éœ€ç§»åŠ¨æ•è·å˜é‡çš„é—­åŒ…å®ç°äº†<code>FnMut</code></li>
<li>æ— éœ€å¯å˜è®¿é—®æ•è·å˜é‡çš„é—­åŒ…å®ç°äº†<code>Fn</code></li>
</ul>
<p><strong>ç”Ÿå‘½å‘¨æœŸä¸é—­åŒ…ï¼š</strong><br>é—­åŒ…å¯ä»¥æ•è·å¼•ç”¨ï¼Œä½†æ˜¯éœ€è¦ä¿è¯å¼•ç”¨çš„ç”Ÿå‘½å‘¨æœŸè¶…è¿‡é—­åŒ…çš„ç”Ÿå‘½å‘¨æœŸï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">s</span> = <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="variable">clousre</span> = || <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, s);</span><br><span class="line"><span class="title function_ invoke__">clousre</span>();  <span class="comment">//æ­£å¸¸è¿è¡Œï¼Œè¾“å‡ºï¼šhello</span></span><br></pre></td></tr></table></figure>

<h2 id="moveå…³é”®å­—"><a href="#moveå…³é”®å­—" class="headerlink" title="moveå…³é”®å­—"></a>moveå…³é”®å­—</h2><p>åœ¨å‚æ•°åˆ—è¡¨å‰ä½¿ç”¨<code>move</code>å…³é”®å­—ï¼Œå¯ä»¥å¼ºåˆ¶é—­åŒ…è·å–å…¶ä½¿ç”¨çš„ç¯å¢ƒå˜é‡çš„æ‰€æœ‰æƒï¼Œè¿™åœ¨å°†é—­åŒ…ä¼ é€’ç»™æ–°çº¿ç¨‹ä»¥ç§»åŠ¨æ•°æ®æ—¶éå¸¸æœ‰ç”¨ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">x</span> = <span class="built_in">vec!</span>[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line"><span class="keyword">let</span> <span class="variable">equal_to_x</span> = <span class="keyword">move</span> |z| z == x;</span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, x); <span class="comment">// ç¼–è¯‘å™¨ä¼šæŠ¥é”™ï¼Œå› ä¸ºxçš„æ‰€æœ‰æƒå·²ç»è¢«ç§»åŠ¨åˆ°equal_to_xé—­åŒ…ä¸­</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="variable">y</span> = <span class="built_in">vec!</span>[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line"><span class="built_in">assert!</span>(<span class="title function_ invoke__">equal_to_x</span>(y));    <span class="comment">//æ­£å¸¸è¿è¡Œ</span></span><br></pre></td></tr></table></figure>

<h2 id="è¯¾åä¹ é¢˜"><a href="#è¯¾åä¹ é¢˜" class="headerlink" title="è¯¾åä¹ é¢˜"></a>è¯¾åä¹ é¢˜</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é¢˜ç›®ï¼š</span></span><br><span class="line"><span class="comment">// å‡è®¾ä½ æ­£åœ¨å¼€å‘ä¸€ä¸ªåšå®¢ç³»ç»Ÿï¼Œå…¶ä¸­æ¯ä¸ªç”¨æˆ·å¯ä»¥æŸ¥çœ‹ä¸åŒçš„æ–‡ç« é¡µé¢ã€‚é¡µé¢çš„æ¸²æŸ“æ˜¯ä¸€ä¸ªè®¡ç®—å¯†é›†å‹çš„è¿‡ç¨‹ï¼Œå¯èƒ½æ¶‰åŠæ•°æ®åº“é‡è®¿ã€æ¨¡æ¿æ¸²æŸ“ç­‰æ“ä½œã€‚</span></span><br><span class="line"><span class="comment">// å› æ­¤ï¼Œä¸ºäº†ä¼˜åŒ–æ€§èƒ½ï¼Œä½ å†³å®šåœ¨æœåŠ¡ç«¯å®ç°ä¸€ä¸ªç¼“å­˜ç³»ç»Ÿã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è¦æ±‚ï¼š</span></span><br><span class="line"><span class="comment">//     å®ç° PageCache ç»“æ„ä½“ã€‚</span></span><br><span class="line"><span class="comment">//  è¯¥ç»“æ„ä½“åº”ç¼“å­˜æ ¹æ®ç”¨æˆ· ID å’Œæ–‡ç«  ID æ¸²æŸ“çš„é¡µé¢ã€‚</span></span><br><span class="line"><span class="comment">//     ä½ éœ€è¦ä¸ºè¯¥ç»“æ„ä½“å®ç°ä¸€ä¸ª get_page æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ¥å—ç”¨æˆ· ID å’Œæ–‡ç«  IDï¼Œå¹¶è¿”å›æ¸²æŸ“åçš„é¡µé¢å†…å®¹ã€‚</span></span><br><span class="line"><span class="comment">//     å¦‚æœç›¸åŒçš„ç”¨æˆ· ID å’Œæ–‡ç«  ID å·²ç»æ¸²æŸ“è¿‡ï¼Œåˆ™ get_page åº”ç›´æ¥è¿”å›ç¼“å­˜çš„é¡µé¢ï¼Œè€Œä¸æ˜¯é‡æ–°æ¸²æŸ“ã€‚</span></span><br><span class="line"><span class="comment">// é€šç”¨æ€§ï¼š</span></span><br><span class="line"><span class="comment">//     PageCache åº”æ”¯æŒä»»æ„ç±»å‹çš„ç”¨æˆ· IDï¼ˆä¾‹å¦‚ï¼Œu32 æˆ– Stringï¼‰å’Œæ–‡ç«  IDã€‚</span></span><br><span class="line"><span class="comment">//     ç¼“å­˜çš„å†…å®¹åº”ä¸ºæ¸²æŸ“åçš„ HTML é¡µé¢ï¼ˆString ç±»å‹ï¼‰ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> std::collections::HashMap;</span><br><span class="line"><span class="keyword">use</span> std::hash::Hash;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">PageCache</span>&lt;F, U, A&gt; </span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    F: <span class="title function_ invoke__">Fn</span>(&amp;U, &amp;A) <span class="punctuation">-&gt;</span> <span class="type">String</span>,    <span class="comment">// å‡½æ•°æŒ‡é’ˆæˆ–é—­åŒ…ç±»å‹</span></span><br><span class="line">    U: Hash + <span class="built_in">Eq</span> + <span class="built_in">Clone</span>,</span><br><span class="line">    A: Hash + <span class="built_in">Eq</span> + <span class="built_in">Clone</span>,</span><br><span class="line">&#123;</span><br><span class="line">    render_fn: F,</span><br><span class="line">    cache: HashMap&lt;(U, A), <span class="type">String</span>&gt;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;F, U, A&gt; PageCache&lt;F, U, A&gt; </span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    F: <span class="title function_ invoke__">Fn</span>(&amp;U, &amp;A) <span class="punctuation">-&gt;</span> <span class="type">String</span>,</span><br><span class="line">    U: Hash + <span class="built_in">Eq</span> + <span class="built_in">Clone</span>,</span><br><span class="line">    A: Hash + <span class="built_in">Eq</span> + <span class="built_in">Clone</span>,</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// å®ç°æ„é€ å™¨æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">new</span>(render_fn: F) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        PageCache &#123;</span><br><span class="line">            render_fn,</span><br><span class="line">            cache: HashMap::<span class="title function_ invoke__">new</span>()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">get_page</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, user_id: U, article_id: A) <span class="punctuation">-&gt;</span> <span class="type">String</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">key</span> = (user_id, article_id);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Some</span>(cached_page) = <span class="keyword">self</span>.cache.<span class="title function_ invoke__">get</span>(&amp;key) &#123;</span><br><span class="line">            cached_page.<span class="title function_ invoke__">clone</span>()</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">rendered_page</span> = (<span class="keyword">self</span>.render_fn)(&amp;key.<span class="number">0</span>, &amp;key.<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">self</span>.cache.<span class="title function_ invoke__">insert</span>(key, rendered_page.<span class="title function_ invoke__">clone</span>());</span><br><span class="line">            rendered_page</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">page_cache</span> = PageCache::<span class="title function_ invoke__">new</span>(|user_id: &amp;<span class="type">String</span>, article_id: &amp;<span class="type">u32</span>| <span class="punctuation">-&gt;</span> <span class="type">String</span> &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;Rendering page for user &#123;&#125; and article &#123;&#125;&quot;</span>, user_id, article_id); <span class="comment">//æ‰“å°æ¸²æŸ“æ—¥å¿—</span></span><br><span class="line">        <span class="built_in">format!</span>(<span class="string">&quot;Rendered HTML content for user &#123;&#125; and article &#123;&#125;&quot;</span>, user_id, article_id)    <span class="comment">//å­˜å‚¨æ¸²æŸ“åçš„é¡µé¢ï¼ˆåœ¨HashMapä¸­ï¼‰</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, page_cache.<span class="title function_ invoke__">get_page</span>(<span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;user1&quot;</span>), <span class="number">42</span>));</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, page_cache.<span class="title function_ invoke__">get_page</span>(<span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;user1&quot;</span>), <span class="number">42</span>));</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, page_cache.<span class="title function_ invoke__">get_page</span>(<span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;user2&quot;</span>), <span class="number">42</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/11/01/rust-macros/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Wobujiaoxyy3">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/11/01/rust-macros/" class="post-title-link" itemprop="url">äºŒåä¸€ã€Rustè¿›é˜¶-å®</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-11-01 02:36:49" itemprop="dateCreated datePublished" datetime="2024-11-01T02:36:49+08:00">2024-11-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-11-14 07:44:41" itemprop="dateModified" datetime="2024-11-14T07:44:41+08:00">2024-11-14</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="å®Macros"><a href="#å®Macros" class="headerlink" title="å®Macros"></a>å®Macros</h1><p>åœ¨Rustä¸­ï¼Œå®ï¼ˆMacrosï¼‰æ˜¯ä¸€ç§å¼ºå¤§çš„å·¥å…·ï¼Œç”¨äºç”Ÿæˆä»£ç ã€‚å®ƒä»¬åœ¨ç¼–è¯‘æ—¶å±•å¼€ï¼Œå¯ä»¥æ‰§è¡Œå¤æ‚çš„æ–‡æœ¬æ“ä½œã€‚</p>
<p>å®é™…ä¸Šæˆ‘ä»¬æ—©å°±è§åˆ°è¿‡å®ï¼Œæ¯”å¦‚<code>println!</code>ã€<code>vec!</code>ç­‰ï¼Œè¿™äº›éƒ½æ˜¯Rustå†…ç½®çš„å®ï¼Œå®åœ¨Rustä¸­æ— å¤„ä¸åœ¨ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">test_common_macros</span>() &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Hello, world!&quot;</span>);</span><br><span class="line">    <span class="built_in">println!</span>&#123;<span class="string">&quot;Hello, World!&quot;</span>&#125;;</span><br><span class="line">    <span class="built_in">println!</span>[<span class="string">&quot;Hello, World!&quot;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">v</span> = <span class="built_in">vec!</span>[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line">    <span class="built_in">assert_eq!</span>(v, [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]);</span><br><span class="line">    <span class="built_in">panic!</span>(<span class="string">&quot;Error&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°è™½ç„¶æˆ‘ä»¬å¹³æ—¶ä½¿ç”¨<code>println!</code>æ—¶ï¼Œæ˜¯<code>println!(&quot;Hello, World!&quot;)</code>ï¼Œä½†æ˜¯<code>println!</code>ä¹Ÿå¯ä»¥ä½¿ç”¨<code>&#123;&#125;</code>ã€<code>[]</code>ã€<code>&#123;&#125;</code>ç­‰ä½œä¸ºå‚æ•°ã€‚è™½ç„¶ä¸‰ç§ä½¿ç”¨æ–¹å¼éƒ½æ­£ç¡®ï¼Œä½†æ˜¯Rustå†…ç½®çš„å®æœ‰è‡ªå·±é»˜è®¤çš„ä½¿ç”¨æ–¹å¼ï¼Œå¦‚<code>assert_eq!()</code>ã€<code>panic!()</code>ç­‰ã€‚</p>
<p><strong>å®åˆ†ä¸ºä¸¤ç±»ï¼šå£°æ˜å®ï¼ˆDeclarative Macrosï¼‰å’Œä¸‰ç§è¿‡ç¨‹å®ï¼ˆProcedural Macrosï¼‰</strong>ï¼š</p>
<ul>
<li><code>#[derive]</code>ï¼Œåœ¨ä¹‹å‰å¤šæ¬¡è§åˆ°çš„æ´¾ç”Ÿå®ï¼Œå¯ä»¥ä¸ºç›®æ ‡ç»“æ„ä½“æˆ–æšä¸¾æ´¾ç”ŸæŒ‡å®šçš„ä»£ç ï¼Œä¾‹å¦‚ Debug ç‰¹å¾</li>
<li>ç±»å±æ€§å®(Attribute-like macro)ï¼Œç”¨äºä¸ºç›®æ ‡æ·»åŠ è‡ªå®šä¹‰çš„å±æ€§</li>
<li>ç±»å‡½æ•°å®(Function-like macro)ï¼Œçœ‹ä¸Šå»å°±åƒæ˜¯å‡½æ•°è°ƒç”¨</li>
</ul>
<h2 id="å®å’Œå‡½æ•°çš„åŒºåˆ«"><a href="#å®å’Œå‡½æ•°çš„åŒºåˆ«" class="headerlink" title="å®å’Œå‡½æ•°çš„åŒºåˆ«"></a>å®å’Œå‡½æ•°çš„åŒºåˆ«</h2><p>å®å’Œå‡½æ•°çš„åŒºåˆ«å¹¶ä¸å°‘ï¼Œè€Œä¸”å¯¹äºå®æ“…é•¿çš„é¢†åŸŸï¼Œå‡½æ•°å…¶å®æ˜¯æœ‰äº›æ— èƒ½ä¸ºåŠ›çš„ã€‚</p>
<h3 id="å…ƒç¼–ç¨‹"><a href="#å…ƒç¼–ç¨‹" class="headerlink" title="å…ƒç¼–ç¨‹"></a>å…ƒç¼–ç¨‹</h3><p>ä»æ ¹æœ¬ä¸Šè¯´ï¼Œå®æ˜¯é€šè¿‡ä¸€ç§ä»£ç æ¥ç”Ÿæˆå¦ä¸€ç§ä»£ç ï¼Œå®ƒå’Œå…ƒç¼–ç¨‹æœ‰ä¸€å®šçš„å…±åŒç‚¹ã€‚</p>
<p>ä¾‹å¦‚<code>derive</code>å®ï¼Œå®ƒå¯ä»¥åœ¨ç¼–è¯‘æ—¶è‡ªåŠ¨ä¸ºç»“æ„ä½“æ´¾ç”Ÿå‡ºç›¸åº”ç‰¹å¾çš„å®ç°ä»£ç ã€‚ä¾‹å¦‚<code>#[derive(Debug)]</code>ï¼Œè¿˜æœ‰ç†Ÿæ‚‰çš„<code>println!</code>å’Œ<code>vec!</code>ï¼Œæ‰€æœ‰çš„è¿™äº›å®éƒ½ä¼šå±•å¼€æˆç›¸åº”çš„ä»£ç ï¼Œä¸”å¾ˆå¯èƒ½æ˜¯é•¿å¾—å¤šçš„ä»£ç ã€‚</p>
<p>æ€»ä¹‹ï¼Œå…ƒç¼–ç¨‹å¯ä»¥å¸®æˆ‘ä»¬å‡å°‘æ‰€éœ€ç¼–å†™çš„ä»£ç ï¼Œä¹Ÿå¯ä»¥ä¸€å®šç¨‹åº¦ä¸Šå‡å°‘ç»´æŠ¤çš„æˆæœ¬ï¼Œè™½ç„¶å‡½æ•°å¤ç”¨ä¹Ÿæœ‰ç±»ä¼¼çš„ä½œç”¨ï¼Œä½†æ˜¯å®ä¾ç„¶æ‹¥æœ‰è‡ªå·±ç‹¬ç‰¹çš„ä¼˜åŠ¿ã€‚</p>
<h3 id="å¯å˜å‚æ•°"><a href="#å¯å˜å‚æ•°" class="headerlink" title="å¯å˜å‚æ•°"></a>å¯å˜å‚æ•°</h3><p>Rust çš„å‡½æ•°ç­¾åæ˜¯å›ºå®šçš„ï¼šå®šä¹‰äº†ä¸¤ä¸ªå‚æ•°ï¼Œå°±å¿…é¡»ä¼ å…¥ä¸¤ä¸ªå‚æ•°ï¼Œå¤šä¸€ä¸ªå°‘ä¸€ä¸ªéƒ½ä¸è¡Œã€‚</p>
<p>è€Œå®å°±å¯ä»¥æ‹¥æœ‰å¯å˜æ•°é‡çš„å‚æ•°ï¼Œä¾‹å¦‚å¯ä»¥è°ƒç”¨ä¸€ä¸ªå‚æ•°çš„<code>println!(&quot;hello&quot;)</code>ï¼Œä¹Ÿå¯ä»¥è°ƒç”¨ä¸¤ä¸ªå‚æ•°çš„<code>println!(&quot;hello &#123;&#125;&quot;, name)</code>ã€‚</p>
<h3 id="å®å±•å¼€"><a href="#å®å±•å¼€" class="headerlink" title="å®å±•å¼€"></a>å®å±•å¼€</h3><p>ç”±äºå®ä¼šè¢«å±•å¼€æˆå…¶å®ƒä»£ç ï¼Œä¸”è¿™ä¸ªå±•å¼€è¿‡ç¨‹æ˜¯å‘ç”Ÿåœ¨ç¼–è¯‘å™¨å¯¹ä»£ç è¿›è¡Œè§£é‡Šä¹‹å‰ã€‚å› æ­¤ï¼Œå®å¯ä»¥ä¸ºæŒ‡å®šçš„ç±»å‹å®ç°æŸä¸ªç‰¹å¾ï¼šå…ˆå°†å®å±•å¼€æˆå®ç°ç‰¹å¾çš„ä»£ç åï¼Œå†è¢«ç¼–è¯‘ã€‚</p>
<p>è€Œå‡½æ•°å°±åšä¸åˆ°è¿™ä¸€ç‚¹ï¼Œå› ä¸ºå®ƒç›´åˆ°è¿è¡Œæ—¶æ‰èƒ½è¢«è°ƒç”¨ï¼Œè€Œç‰¹å¾éœ€è¦åœ¨ç¼–è¯‘æœŸè¢«å®ç°ã€‚</p>
<h3 id="å®çš„ç¼ºç‚¹"><a href="#å®çš„ç¼ºç‚¹" class="headerlink" title="å®çš„ç¼ºç‚¹"></a>å®çš„ç¼ºç‚¹</h3><p>ç›¸å¯¹å‡½æ•°æ¥è¯´ï¼Œç”±äºå®æ˜¯åŸºäºä»£ç å†å±•å¼€æˆä»£ç ï¼Œå› æ­¤å®ç°ç›¸æ¯”å‡½æ•°æ¥è¯´ä¼šæ›´åŠ å¤æ‚ï¼Œå†åŠ ä¸Šå®çš„è¯­æ³•æ›´ä¸ºå¤æ‚ï¼Œæœ€ç»ˆå¯¼è‡´å®šä¹‰å®çš„ä»£ç ç›¸å½“åœ°éš¾è¯»ï¼Œä¹Ÿéš¾ä»¥ç†è§£å’Œç»´æŠ¤ã€‚</p>
<p><strong>å°±æ˜¯ååˆ†éš¾å†™ï¼Œååˆ†éš¾æ‡‚ï¼Œååˆ†éš¾ç»´æŠ¤ï¼ï¼</strong></p>
<h2 id="å£°æ˜å®"><a href="#å£°æ˜å®" class="headerlink" title="å£°æ˜å®"></a>å£°æ˜å®</h2><p>åœ¨Rustä¸­æœ€å¹¿æ³›ä½¿ç”¨çš„å®å°±æ˜¯å£°æ˜å®ï¼Œå£°æ˜å®ä½¿ç”¨<code>macro_rules!</code>æ¥å®šä¹‰ï¼Œ<code>macro_rules!</code>çœ‹èµ·æ¥åƒæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œä½†æ˜¯å®ƒå’Œå‡½æ•°æ²¡æœ‰ä»»ä½•å…³ç³»ï¼Œå®ƒå…è®¸ä½ é€šè¿‡æ¨¡å¼åŒ¹é…æ¥ç”Ÿæˆä»£ç ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å£°æ˜å®</span></span><br><span class="line"><span class="meta">#[macro_export]</span></span><br><span class="line"><span class="built_in">macro_rules!</span> say_hello &#123;</span><br><span class="line">    () =&gt; &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;Hello, world!&quot;</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    say_hello!();</span><br><span class="line">    say_hello![];</span><br><span class="line">    say_hello!&#123;&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…¶å®ä¸Šé¢çš„ä¾‹å­æ˜¯ä¸€ä¸ªååˆ†ååˆ†ç®€å•çš„å£°æ˜å®ï¼Œå®ƒæ²¡æœ‰è¿›è¡Œä»»ä½•çš„åŒ¹é…ï¼Œåªæ˜¯æ‰“å°äº†ä¸€ä¸ªå›ºå®šçš„è¯­å¥ã€‚</p>
<h3 id="å®ç°ç®€åŒ–ç‰ˆçš„vec"><a href="#å®ç°ç®€åŒ–ç‰ˆçš„vec" class="headerlink" title="å®ç°ç®€åŒ–ç‰ˆçš„vec!"></a>å®ç°ç®€åŒ–ç‰ˆçš„vec!</h3><p>åœ¨ä¹‹å‰åŠ¨æ€æ•°ç»„çš„ç¯èŠ‚ä¸­ï¼Œæˆ‘ä»¬å­¦ä¹ äº†ä½¿ç”¨<code>vec!</code>å®æ¥åˆ›å»ºåŠ¨æ€æ•°ç»„:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">v</span> = <span class="built_in">vec!</span>[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br></pre></td></tr></table></figure>
<p>æœ€é‡è¦çš„æ˜¯ï¼Œé€šè¿‡<code>vec!</code>åˆ›å»ºçš„åŠ¨æ€æ•°ç»„æ”¯æŒä»»ä½•å…ƒç´ ç±»å‹ï¼Œä¹Ÿå¹¶æ²¡æœ‰é™åˆ¶æ•°ç»„çš„é•¿åº¦ï¼Œå¦‚æœä½¿ç”¨å‡½æ•°ï¼Œæˆ‘ä»¬æ˜¯æ— æ³•åšåˆ°è¿™ä¸€ç‚¹çš„ã€‚</p>
<p>ç°åœ¨è®©æˆ‘ä»¬å°è¯•ç”¨<code>macro_rules!</code>æ¥è‡ªå·±å®ç°ä¸€ä¸ªç®€åŒ–ç‰ˆçš„<code>vec!</code>å®:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[macro_export]</span></span><br><span class="line"><span class="built_in">macro_rules!</span> vec &#123;</span><br><span class="line">    ($($e:expr),*) =&gt; &#123;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">temp_vec</span> = <span class="type">Vec</span>::<span class="title function_ invoke__">new</span>();</span><br><span class="line">            $(</span><br><span class="line">                temp_vec.<span class="title function_ invoke__">push</span>($e);</span><br><span class="line">            )*</span><br><span class="line">            temp_vec</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å³ä½¿æ˜¯ç®€åŒ–ç‰ˆæœ¬çš„<code>vec!</code>å®ï¼Œå®ƒè¿˜æ˜¯é‚£ä¹ˆéš¾ç†è§£ï¼Œä¸è¿‡æ²¡å…³ç³»ï¼Œæˆ‘ä»¬æ…¢æ…¢æ¥ã€‚</p>
<p>é¦–å…ˆ<code>#[macro_export]</code>æ˜¯ç”¨æ¥å¯¼å‡ºå®çš„ï¼Œè¿™æ ·å®å°±å¯ä»¥åœ¨å½“å‰crateä¹‹å¤–ä½¿ç”¨ã€‚</p>
<p>ç´§æ¥ç€æˆ‘ä»¬ä½¿ç”¨<code>macro_rules!</code>æ˜¯å£°æ˜å®çš„è¯­æ³•ï¼Œ<code>vec!</code>æ˜¯å®çš„åç§°ï¼Œ<code>($($e:expr),*)</code>æ˜¯æ¨¡å¼åŒ¹é…ï¼Œè·Ÿæ¨¡å¼ç›¸åŒ¹é…çš„ä»£ç å°±åœ¨<code>=&gt;</code>åé¢ã€‚</p>
<h3 id="æ¨¡å¼è§£æ"><a href="#æ¨¡å¼è§£æ" class="headerlink" title="æ¨¡å¼è§£æ"></a>æ¨¡å¼è§£æ</h3><p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬æ¥ç®€å•åœ°è§£æä¸€ä¸‹<code>($($e:expr),*)</code>è¿™ä¸ªæ¨¡å¼ï¼š</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬ä½¿ç”¨åœ†æ‹¬å·<code>()</code>æ¥å°†æ•´ä¸ªå®æ¨¡å¼åŒ…è£¹å…¶ä¸­ï¼Œéšåæ˜¯<code>$()</code>ï¼Œåœ¨æ­¤æ‹¬å·ä¸­è·Ÿæ¨¡å¼ç›¸åŒ¹é…çš„å€¼(ä¼ å…¥çš„Rustæºä»£ç )ä¼šè¢«æ•è·ï¼Œç„¶åç”¨äºä»£ç æ›¿æ¢ã€‚åœ¨è¿™é‡Œï¼Œæ¨¡å¼ <code>$x:expr</code> ä¼šåŒ¹é…<strong>ä»»ä½•Rustè¡¨è¾¾å¼</strong>å¹¶ç»™äºˆè¯¥æ¨¡å¼ä¸€ä¸ªåç§°ï¼š<code>$x</code>ã€‚</p>
<p><code>$()</code> ä¹‹åçš„é€—å·è¯´æ˜åœ¨ <code>$()</code> æ‰€åŒ¹é…çš„ä»£ç çš„åé¢ä¼šæœ‰ä¸€ä¸ªå¯é€‰çš„é€—å·åˆ†éš”ç¬¦ï¼Œç´§éšé€—å·ä¹‹åçš„ <code>*</code> è¯´æ˜ <code>*</code> ä¹‹å‰çš„æ¨¡å¼ä¼šè¢«åŒ¹é…é›¶æ¬¡æˆ–ä»»æ„å¤šæ¬¡(ç±»ä¼¼æ­£åˆ™è¡¨è¾¾å¼)ã€‚</p>
<p>å½“æˆ‘ä»¬ä½¿ç”¨ vec![1, 2, 3] æ¥è°ƒç”¨è¯¥å®æ—¶ï¼Œ$x æ¨¡å¼å°†è¢«åŒ¹é…ä¸‰æ¬¡ï¼Œåˆ†åˆ«æ˜¯ 1ã€2ã€3ã€‚ä¸ºäº†å¸®åŠ©å¤§å®¶å·©å›ºï¼Œæˆ‘ä»¬å†æ¥ä¸€èµ·è¿‡ä¸€ä¸‹ï¼š</p>
<ul>
<li><code>$()</code>ä¸­åŒ…å«çš„æ˜¯æ¨¡å¼<code>$x:expr</code>ï¼Œè¯¥æ¨¡å¼ä¸­çš„<code>expr</code>è¡¨ç¤ºä¼šåŒ¹é…ä»»ä½•Rustè¡¨è¾¾å¼ï¼Œå¹¶ç»™äºˆè¯¥æ¨¡å¼ä¸€ä¸ªåç§°<code>$x</code></li>
<li>å› æ­¤<code>$x</code>æ¨¡å¼å¯ä»¥è·Ÿæ•´æ•°<code>1</code>è¿›è¡ŒåŒ¹é…ï¼Œä¹Ÿå¯ä»¥è·Ÿå­—ç¬¦ä¸²<code>&quot;hello&quot;</code>è¿›è¡ŒåŒ¹é…:<code>vec![&quot;hello&quot;, &quot;world&quot;]</code></li>
<li><code>$()</code>ä¹‹åçš„é€—å·ï¼Œæ„å‘³ç€<code>1</code>å’Œ<code>2</code>ä¹‹é—´å¯ä»¥ä½¿ç”¨é€—å·è¿›è¡Œåˆ†å‰²ï¼Œä¹Ÿæ„å‘³ç€<code>3</code>æ—¢å¯ä»¥æ²¡æœ‰é€—å·ï¼Œä¹Ÿå¯ä»¥æœ‰é€—å·ï¼š<code>vec![1, 2, 3,]</code></li>
<li><code>*</code>è¯´æ˜ä¹‹å‰çš„æ¨¡å¼å¯ä»¥å‡ºç°é›¶æ¬¡ä¹Ÿå¯ä»¥ä»»æ„æ¬¡ï¼Œè¿™é‡Œå‡ºç°äº†ä¸‰æ¬¡.</li>
</ul>
<p>æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬å†çœ‹çœ‹ä¸æ¨¡å¼ç›¸å…³è”ï¼Œåœ¨<code>=&gt;</code>ä¹‹åæ‰€å†™çš„ä»£ç ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">temp_vec</span> = <span class="type">Vec</span>::<span class="title function_ invoke__">new</span>();</span><br><span class="line">    $(</span><br><span class="line">        temp_vec.<span class="title function_ invoke__">push</span>($e);</span><br><span class="line">    )*</span><br><span class="line">    temp_vec</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œå°±æ¯”è¾ƒå¥½ç†è§£äº†ï¼Œ<code>$()</code>ä¸­çš„<code>temp_vec.push()</code>å°†æ ¹æ®æ¨¡å¼åŒ¹é…çš„æ¬¡æ•°ç”Ÿæˆå¯¹åº”çš„ä»£ç ï¼Œå½“è°ƒç”¨<code>vec![1, 2, 3]</code>æ—¶ï¼Œä¸‹é¢è¿™æ®µç”Ÿæˆçš„ä»£ç å°†æ›¿ä»£ä¼ å…¥çš„æºä»£ç ï¼Œä¹Ÿå°±æ˜¯æ›¿ä»£<code>vec![1, 2, 3]</code>:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">temp_vec</span> = <span class="type">Vec</span>::<span class="title function_ invoke__">new</span>();</span><br><span class="line">    temp_vec.<span class="title function_ invoke__">push</span>(<span class="number">1</span>);</span><br><span class="line">    temp_vec.<span class="title function_ invoke__">push</span>(<span class="number">2</span>);</span><br><span class="line">    temp_vec.<span class="title function_ invoke__">push</span>(<span class="number">3</span>);</span><br><span class="line">    temp_vec</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»èƒ½å¤Ÿå¤§è‡´ç†è§£è¿™ä¸ªç®€åŒ–ç‰ˆçš„<code>vec!</code>å®äº†ã€‚å®ƒå¯ä»¥æ¥å—ä»»æ„æ•°é‡å’Œä»»æ„ç±»å‹çš„å‚æ•°ï¼Œå¹¶åˆ›å»ºä¸€ä¸ªåŒ…å«è¿™äº›å‚æ•°çš„å‘é‡ã€‚</p>
<h2 id="è¿‡ç¨‹å®"><a href="#è¿‡ç¨‹å®" class="headerlink" title="è¿‡ç¨‹å®"></a>è¿‡ç¨‹å®</h2><p>ç¬¬äºŒç§å¸¸ç”¨çš„å®å°±æ˜¯è¿‡ç¨‹å®ï¼ˆProcedural Macrosï¼‰ï¼Œä»å½¢å¼ä¸Šæ¥çœ‹ï¼Œè¿‡ç¨‹å®è·Ÿå‡½æ•°è¾ƒä¸ºç›¸åƒï¼Œä½†è¿‡ç¨‹å®æ˜¯ä½¿ç”¨æºä»£ç ä½œä¸ºè¾“å…¥å‚æ•°ï¼ŒåŸºäºä»£ç è¿›è¡Œä¸€ç³»åˆ—æ“ä½œåï¼Œå†è¾“å‡ºä¸€æ®µå…¨æ–°çš„ä»£ç ã€‚<strong>æ³¨æ„ï¼Œè¿‡ç¨‹å®ä¸­çš„ derive å®è¾“å‡ºçš„ä»£ç å¹¶ä¸ä¼šæ›¿æ¢ä¹‹å‰çš„ä»£ç ï¼Œè¿™ä¸€ç‚¹ä¸å£°æ˜å®æœ‰å¾ˆå¤§çš„ä¸åŒï¼</strong></p>
<p>è‡³äºå‰æ–‡æåˆ°çš„è¿‡ç¨‹å®çš„ä¸‰ç§ç±»å‹(è‡ªå®šä¹‰ deriveã€å±æ€§å®ã€å‡½æ•°å®)ï¼Œå®ƒä»¬çš„å·¥ä½œæ–¹å¼éƒ½æ˜¯ç±»ä¼¼çš„ã€‚</p>
<p>å½“åˆ›å»ºè¿‡ç¨‹å®æ—¶ï¼Œå®ƒçš„å®šä¹‰å¿…é¡»è¦æ”¾å…¥ä¸€ä¸ªç‹¬ç«‹çš„åŒ…ä¸­ï¼Œä¸”åŒ…çš„ç±»å‹ä¹Ÿæ˜¯ç‰¹æ®Šçš„ï¼Œå¿…é¡»ä½¿ç”¨<code>#[proc_macro]</code>å±æ€§æ¥æ ‡æ³¨ã€‚è¿‡ç¨‹å®éœ€è¦æ”¾å…¥ç‹¬ç«‹åŒ…çš„åŸå› æ¯”è¾ƒå¤æ‚ï¼Œåœ¨äºå®ƒå¿…é¡»å…ˆè¢«ç¼–è¯‘åæ‰èƒ½ä½¿ç”¨ï¼Œå¦‚æœè¿‡ç¨‹å®å’Œä½¿ç”¨å®ƒçš„ä»£ç åœ¨ä¸€ä¸ªåŒ…ï¼Œå°±å¿…é¡»å…ˆå•ç‹¬å¯¹è¿‡ç¨‹å®çš„ä»£ç è¿›è¡Œç¼–è¯‘ï¼Œç„¶åå†å¯¹æˆ‘ä»¬çš„ä»£ç è¿›è¡Œç¼–è¯‘ï¼Œä½†æ‚²å‰§çš„æ˜¯ Rust çš„ç¼–è¯‘å•å…ƒæ˜¯åŒ…ï¼Œå› æ­¤ä½ æ— æ³•åšåˆ°è¿™ä¸€ç‚¹ã€‚</p>
<h3 id="æ´¾ç”Ÿå®"><a href="#æ´¾ç”Ÿå®" class="headerlink" title="æ´¾ç”Ÿå®"></a>æ´¾ç”Ÿå®</h3><h4 id="æ´¾ç”Ÿå®çš„å®ç°"><a href="#æ´¾ç”Ÿå®çš„å®ç°" class="headerlink" title="æ´¾ç”Ÿå®çš„å®ç°"></a>æ´¾ç”Ÿå®çš„å®ç°</h4><p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åœ¨ç¼–å†™ä»£ç çš„è¿‡ç¨‹ä¸­ä¸éœ€è¦è‡ªå·±å®šä¹‰æˆ–è€…å®ç°å®ï¼Œæˆ‘ä»¬åªéœ€è¦ç”¨å¥½Rustå†…ç½®çš„å®å³å¯ã€‚</p>
<p>è¿™é‡Œï¼Œæˆ‘ä»¬ç®€å•çœ‹ä¸€ä¸‹æ´¾ç”Ÿå®çš„å®ç°ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> proc_macro::TokenStream;</span><br><span class="line"><span class="keyword">use</span> quote::quote;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#[proc_macro_derive(HelloMacro)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">hello_macro_derive</span>(input: TokenStream) <span class="punctuation">-&gt;</span> TokenStream &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">ast</span> = syn::<span class="title function_ invoke__">parse</span>(input).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">name</span> = &amp;ast.ident;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">gen</span> = quote! &#123;</span><br><span class="line">        <span class="keyword">impl</span> <span class="title class_">HelloMacro</span> <span class="keyword">for</span> #name &#123;</span><br><span class="line">            <span class="keyword">fn</span> <span class="title function_">hello_macro</span>() &#123;</span><br><span class="line">                <span class="built_in">println!</span>(<span class="string">&quot;Hello, Macro! My name is &#123;&#125;&quot;</span>, <span class="built_in">stringify!</span>(#name));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    gen.<span class="title function_ invoke__">into</span>()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åŒæ—¶ï¼Œæˆ‘ä»¬è¿˜éœ€è¦åœ¨<code>Cargo.toml</code>ä¸­æ·»åŠ <code>quote</code>å’Œ<code>syn</code>çš„ä¾èµ–ï¼Œä»¥åŠ<code>proc-macro</code>çš„å·¥å…·ï¼š</p>
<figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[dependencies]</span></span><br><span class="line"><span class="attr">quote</span> = <span class="string">&quot;1.0&quot;</span></span><br><span class="line"><span class="attr">syn</span> = <span class="string">&quot;2.0&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[lib]</span></span><br><span class="line"><span class="attr">proc-macro</span> = <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>å®ç°æ´¾ç”Ÿå®çœŸçš„ååˆ†å¤æ‚ï¼Œè¯·åœ¨æœ‰éœ€è¦çš„æ—¶å€™è‡ªè¡ŒæŸ¥é˜…æ–‡æ¡£<a target="_blank" rel="noopener" href="https://course.rs/advance/macro.html">Rustè¯­è¨€åœ£ç»</a> </p>
<p>é‚£ä¹ˆï¼ŒRustå½“ä¸­æœ‰é‚£äº›å·²ç»ä¸ºæˆ‘ä»¬å®ç°çš„å†…ç½®å®å‘¢ï¼Ÿå¸¸ç”¨çš„æœ‰ï¼š</p>
<ul>
<li><code>#[derive(Debug)]</code>  </li>
<li><code>#[derive(Clone)]</code></li>
<li><code>#[derive(Copy)]</code></li>
<li><code>#[derive(Default)]</code> </li>
<li><code>#[derive(PartialEq)]</code></li>
<li><code>#[derive(Eq)]</code></li>
<li><code>#[derive(Hash)]</code></li>
<li><code>#[derive(PartialOrd)]</code></li>
<li><code>#[derive(Ord)]</code></li>
</ul>
<h3 id="ç±»å±æ€§å®"><a href="#ç±»å±æ€§å®" class="headerlink" title="ç±»å±æ€§å®"></a>ç±»å±æ€§å®</h3><p>ç±»å±æ€§è¿‡ç¨‹å®è·Ÿ<code>derive</code>å®ç±»ä¼¼ï¼Œä½†æ˜¯å‰è€…å…è®¸æˆ‘ä»¬å®šä¹‰è‡ªå·±çš„å±æ€§ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œ<code>derive</code>åªèƒ½ç”¨äºç»“æ„ä½“å’Œæšä¸¾ï¼Œè€Œç±»å±æ€§å®å¯ä»¥ç”¨äºå…¶å®ƒç±»å‹é¡¹ï¼Œä¾‹å¦‚å‡½æ•°ã€‚</p>
<p>å‡è®¾æˆ‘ä»¬åœ¨å¼€å‘ä¸€ä¸ªwebæ¡†æ¶ï¼Œå½“ç”¨æˆ·é€šè¿‡<code>HTTP GET</code>è¯·æ±‚è®¿é—®<code>/</code>æ ¹è·¯å¾„æ—¶ï¼Œä½¿ç”¨<code>index</code>å‡½æ•°ä¸ºå…¶æä¾›æœåŠ¡:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[route(GET, <span class="string">&quot;/&quot;</span>)]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">index</span>() &#123;</span><br></pre></td></tr></table></figure>
<p>å¦‚ä¸Šæ‰€ç¤ºï¼Œä»£ç åŠŸèƒ½éå¸¸æ¸…æ™°ã€ç®€æ´ï¼Œè¿™é‡Œçš„<code>#[route]</code>å±æ€§å°±æ˜¯ä¸€ä¸ªè¿‡ç¨‹å®ï¼Œå®ƒçš„å®šä¹‰å‡½æ•°å¤§æ¦‚å¦‚ä¸‹ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[proc_macro_attribute]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">route</span>(attr: TokenStream, item: TokenStream) <span class="punctuation">-&gt;</span> TokenStream &#123;</span><br></pre></td></tr></table></figure>
<p>ä¸<code>derive</code>å®ä¸åŒï¼Œç±»å±æ€§å®çš„å®šä¹‰å‡½æ•°æœ‰ä¸¤ä¸ªå‚æ•°ï¼š</p>
<ul>
<li>ç¬¬ä¸€ä¸ªå‚æ•°æ—¶ç”¨äºè¯´æ˜å±æ€§åŒ…å«çš„å†…å®¹ï¼š<code>Get</code>, <code>/</code>éƒ¨åˆ†</li>
<li>ç¬¬äºŒä¸ªæ˜¯å±æ€§æ‰€æ ‡æ³¨çš„ç±»å‹é¡¹ï¼Œåœ¨è¿™é‡Œæ˜¯<code>fn index() &#123;...&#125;</code>ï¼Œæ³¨æ„ï¼Œå‡½æ•°ä½“ä¹Ÿè¢«åŒ…å«å…¶ä¸­</li>
</ul>
<p>é™¤æ­¤ä¹‹å¤–ï¼Œç±»å±æ€§å®è·Ÿ<code>derive</code>å®çš„å·¥ä½œæ–¹å¼å¹¶æ— åŒºåˆ«ï¼šåˆ›å»ºä¸€ä¸ªåŒ…ï¼Œç±»å‹æ˜¯<code>proc-macro</code>ï¼Œæ¥ç€å®ç°ä¸€ä¸ªå‡½æ•°ç”¨äºç”Ÿæˆæƒ³è¦çš„ä»£ç ã€‚</p>
<h3 id="ç±»å‡½æ•°å®"><a href="#ç±»å‡½æ•°å®" class="headerlink" title="ç±»å‡½æ•°å®"></a>ç±»å‡½æ•°å®</h3><p>ç±»å‡½æ•°å®å¯ä»¥è®©æˆ‘ä»¬å®šä¹‰åƒå‡½æ•°é‚£æ ·è°ƒç”¨çš„å®ï¼Œä»è¿™ä¸ªè§’åº¦æ¥çœ‹ï¼Œå®ƒè·Ÿå£°æ˜å®<code>macro_rules</code>è¾ƒä¸ºç±»ä¼¼ã€‚</p>
<p>åŒºåˆ«åœ¨äºï¼Œ<code>macro_rules</code>çš„å®šä¹‰å½¢å¼ä¸<code>match</code>åŒ¹é…éå¸¸ç›¸åƒï¼Œè€Œç±»å‡½æ•°å®çš„å®šä¹‰å½¢å¼åˆ™ç±»ä¼¼äºä¹‹å‰è®²è¿‡çš„ä¸¤ç§è¿‡ç¨‹å®ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[proc_macro]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">sql</span>(input: TokenStream) <span class="punctuation">-&gt;</span> TokenStream &#123;</span><br></pre></td></tr></table></figure>
<p>è€Œä½¿ç”¨å½¢å¼åˆ™ç±»ä¼¼äºå‡½æ•°è°ƒç”¨ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">sql</span> = sql!(SELECT * FROM users);</span><br></pre></td></tr></table></figure>

<p>Rustå†…ç½®çš„ç±»å‡½æ•°å®æœ‰ï¼š</p>
<ul>
<li><code>assert_eq!</code></li>
<li><code>assert!</code></li>
<li><code>println!</code></li>
<li><code>vec!</code></li>
<li><code>include_str!</code> &#x2F;&#x2F; åŒ…å«å­—ç¬¦ä¸²</li>
<li><code>env!</code> &#x2F;&#x2F; è·å–ç¯å¢ƒå˜é‡</li>
<li><code>concat!</code> &#x2F;&#x2F; è¿æ¥å­—ç¬¦ä¸²</li>
<li><code>format!</code> &#x2F;&#x2F; æ ¼å¼åŒ–å­—ç¬¦ä¸²</li>
<li><code>todo!</code> &#x2F;&#x2F; ç”Ÿæˆæœªå®ç°ä»£ç </li>
</ul>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><ul>
<li><strong>åˆ›å»ºå£°æ˜å®</strong>ï¼šä½¿ç”¨<code>macro_rules!</code>å®šä¹‰å®ï¼Œé€šè¿‡æ¨¡å¼åŒ¹é…ç”Ÿæˆä»£ç </li>
<li><strong>åˆ›å»ºè¿‡ç¨‹å®</strong>ï¼šä½¿ç”¨è¿‡ç¨‹å®å‡½æ•°<code>#[proc_macro]</code>ã€æ´¾ç”Ÿå®<code>#[proc_macro_attribute]</code>å’Œå±æ€§å®<code>#[proc_macro_derive]</code>ç”Ÿæˆä»£ç </li>
</ul>
<p>å®çš„ä½¿ç”¨åœºæ™¯ï¼š</p>
<ol>
<li><strong>å‡å°‘é‡å¤ä»£ç </strong>ï¼šå®å¯ä»¥å‡å°‘é‡å¤ä»£ç ï¼Œæé«˜ä»£ç çš„å¤ç”¨æ€§</li>
<li><strong>ç¼–è¯‘æœŸè®¡ç®—</strong>ï¼šå®å¯ä»¥åœ¨ç¼–è¯‘æœŸè¿›è¡Œå¤æ‚çš„è®¡ç®—ï¼Œå‡å°‘è¿è¡Œæ—¶çš„å¼€é”€</li>
<li><strong>DSLï¼ˆé¢†åŸŸç‰¹å®šè¯­è¨€ï¼‰</strong>ï¼šå®å¯ä»¥ç”¨äºåˆ›å»ºé¢†åŸŸç‰¹å®šè¯­è¨€ï¼Œæé«˜ä»£ç çš„è¡¨è¾¾åŠ›å’Œå¯è¯»æ€§</li>
</ol>
<h2 id="è¯¾åä½œä¸š"><a href="#è¯¾åä½œä¸š" class="headerlink" title="è¯¾åä½œä¸š"></a>è¯¾åä½œä¸š</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¦æ±‚ï¼š</span></span><br><span class="line"><span class="comment">// é€šè¿‡`macro_rules!`å®å®ç°å¯¹åº”çš„marcoï¼Œå¹¶é€šè¿‡æµ‹è¯•case</span></span><br><span class="line"><span class="comment">// assert_eq!(repeat!(&quot;x&quot;, 3), &quot;xxx&quot;);</span></span><br><span class="line"><span class="comment">// assert_eq!(sum!(1, 2, 3, 4, 5), 15);</span></span><br><span class="line"><span class="comment">// assert_eq!(max_value!(1, 8, 9), 9);</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#[macro_export]</span></span><br><span class="line"><span class="built_in">macro_rules!</span> repeat &#123;</span><br><span class="line">    ($item:expr, $n:expr) =&gt; &#123;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">result</span> = <span class="type">String</span>::<span class="title function_ invoke__">new</span>();</span><br><span class="line">            <span class="keyword">for</span> <span class="variable">_</span> <span class="keyword">in</span> <span class="number">0</span>..$n &#123;</span><br><span class="line">                result.<span class="title function_ invoke__">push_str</span>(&amp;$item);</span><br><span class="line">            &#125;</span><br><span class="line">            result</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[macro_export]</span></span><br><span class="line"><span class="built_in">macro_rules!</span> sum &#123;</span><br><span class="line">    ($($x:expr),*) =&gt; &#123;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">sum</span> = <span class="number">0</span>;</span><br><span class="line">            $(</span><br><span class="line">                sum += $x;</span><br><span class="line">            )*</span><br><span class="line">            sum</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[macro_export]</span></span><br><span class="line"><span class="built_in">macro_rules!</span> max_value &#123;</span><br><span class="line">    ($first:expr, $($rest:expr),*) =&gt; &#123; <span class="comment">//éœ€è¦åˆ†åˆ«å¤„ç†ç¬¬ä¸€ä¸ªå€¼å’Œå‰©ä½™å€¼ï¼Œç¬¬ä¸€ä¸ªå€¼ç”¨äºåˆå§‹åŒ–sum</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">max</span> = $first; </span><br><span class="line">            $(</span><br><span class="line">                <span class="keyword">if</span> $rest &gt; max &#123;</span><br><span class="line">                    max = $rest;</span><br><span class="line">                &#125;</span><br><span class="line">            )*</span><br><span class="line">            max</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="built_in">assert_eq!</span>(repeat!(<span class="string">&quot;x&quot;</span>, <span class="number">3</span>), <span class="string">&quot;xxx&quot;</span>);</span><br><span class="line">    <span class="built_in">assert_eq!</span>(sum!(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>), <span class="number">15</span>);</span><br><span class="line">    <span class="built_in">assert_eq!</span>(max_value!(<span class="number">1</span>, <span class="number">8</span>, <span class="number">9</span>), <span class="number">9</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name"></p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">30</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder"></span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  

</body>
</html>
